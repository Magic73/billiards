(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[826],{"./node_modules/three/examples/jsm/exporters/GLTFExporter.js":(e,t,s)=>{"use strict";s.r(t),s.d(t,{GLTFExporter:()=>i});var n=s("./node_modules/three/build/three.module.js");class i{constructor(){this.pluginCallbacks=[],this.register((function(e){return new P(e)})),this.register((function(e){return new O(e)})),this.register((function(e){return new C(e)}))}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s){const n=new L,i=[];for(let e=0,t=this.pluginCallbacks.length;e<t;e++)i.push(this.pluginCallbacks[e](n));n.setPlugins(i),n.write(e,t,s)}}const r=0,o=1,a=2,l=3,c=4,u=5121,h=5123,d=5126,p=5125,m=34962,f=34963,g=9728,v=9729,y=9984,b=9985,w=9986,M=9987,x=33071,T=33648,S=10497,k={};k[n.NearestFilter]=g,k[n.NearestMipmapNearestFilter]=y,k[n.NearestMipmapLinearFilter]=w,k[n.LinearFilter]=v,k[n.LinearMipmapNearestFilter]=b,k[n.LinearMipmapLinearFilter]=M,k[n.ClampToEdgeWrapping]=x,k[n.RepeatWrapping]=S,k[n.MirroredRepeatWrapping]=T;const A={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};function E(e,t){return e.length===t.length&&e.every((function(e,s){return e===t[s]}))}function R(e){return 4*Math.ceil(e/4)}function _(e,t=0){const s=R(e.byteLength);if(s!==e.byteLength){const n=new Uint8Array(s);if(n.set(new Uint8Array(e)),0!==t)for(let i=e.byteLength;i<s;i++)n[i]=t;return n.buffer}return e}let I=null;class L{constructor(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}setPlugins(e){this.plugins=e}write(e,t,s){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);const n=this;Promise.all(this.pending).then((function(){const e=n.buffers,s=n.json,i=n.options,r=n.extensionsUsed,o=new Blob(e,{type:"application/octet-stream"}),a=Object.keys(r);if(a.length>0&&(s.extensionsUsed=a),s.buffers&&s.buffers.length>0&&(s.buffers[0].byteLength=o.size),!0===i.binary){const e=new window.FileReader;e.readAsArrayBuffer(o),e.onloadend=function(){const n=_(e.result),i=new DataView(new ArrayBuffer(8));i.setUint32(0,n.byteLength,!0),i.setUint32(4,5130562,!0);const r=_(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;const t=new Uint8Array(new ArrayBuffer(e.length));for(let s=0,n=e.length;s<n;s++){const n=e.charCodeAt(s);t[s]=n>255?32:n}return t.buffer}(JSON.stringify(s)),32),o=new DataView(new ArrayBuffer(8));o.setUint32(0,r.byteLength,!0),o.setUint32(4,1313821514,!0);const a=new ArrayBuffer(12),l=new DataView(a);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);const c=12+o.byteLength+r.byteLength+i.byteLength+n.byteLength;l.setUint32(8,c,!0);const u=new Blob([a,o,r,i,n],{type:"application/octet-stream"}),h=new window.FileReader;h.readAsArrayBuffer(u),h.onloadend=function(){t(h.result)}}}else if(s.buffers&&s.buffers.length>0){const e=new window.FileReader;e.readAsDataURL(o),e.onloadend=function(){const n=e.result;s.buffers[0].uri=n,t(s)}}else t(s)}))}serializeUserData(e,t){if(0===Object.keys(e.userData).length)return;const s=this.options,n=this.extensionsUsed;try{const i=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&i.gltfExtensions){void 0===t.extensions&&(t.extensions={});for(const e in i.gltfExtensions)t.extensions[e]=i.gltfExtensions[e],n[e]=!0;delete i.gltfExtensions}Object.keys(i).length>0&&(t.extras=i)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}getUID(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)}isNormalizedNormalAttribute(e){if(this.cache.attributesNormalized.has(e))return!1;const t=new n.Vector3;for(let s=0,n=e.count;s<n;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0}createNormalizedNormalAttribute(e){const t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);const s=e.clone(),i=new n.Vector3;for(let e=0,t=s.count;e<t;e++)i.fromBufferAttribute(s,e),0===i.x&&0===i.y&&0===i.z?i.setX(1):i.normalize(),s.setXYZ(e,i.x,i.y,i.z);return t.attributesNormalized.set(e,s),s}applyTextureTransform(e,t){let s=!1;const n={};0===t.offset.x&&0===t.offset.y||(n.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(n.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(n.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=n,this.extensionsUsed.KHR_texture_transform=!0)}processBuffer(e){const t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0}processBufferView(e,t,s,n,i){const r=this.json;let o;r.bufferViews||(r.bufferViews=[]),o=t===u?1:t===h?2:4;const a=R(n*e.itemSize*o),l=new DataView(new ArrayBuffer(a));let c=0;for(let i=s;i<s+n;i++)for(let s=0;s<e.itemSize;s++){let n;e.itemSize>4?n=e.array[i*e.itemSize+s]:0===s?n=e.getX(i):1===s?n=e.getY(i):2===s?n=e.getZ(i):3===s&&(n=e.getW(i)),t===d?l.setFloat32(c,n,!0):t===p?l.setUint32(c,n,!0):t===h?l.setUint16(c,n,!0):t===u&&l.setUint8(c,n),c+=o}const f={buffer:this.processBuffer(l.buffer),byteOffset:this.byteOffset,byteLength:a};void 0!==i&&(f.target=i),i===m&&(f.byteStride=e.itemSize*o),this.byteOffset+=a,r.bufferViews.push(f);return{id:r.bufferViews.length-1,byteLength:0}}processBufferViewImage(e){const t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise((function(n){const i=new window.FileReader;i.readAsArrayBuffer(e),i.onloadend=function(){const e=_(i.result),r={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,n(s.bufferViews.push(r)-1)}}))}processAccessor(e,t,s,n){const i=this.options,r=this.json;let o;if(e.array.constructor===Float32Array)o=d;else if(e.array.constructor===Uint32Array)o=p;else if(e.array.constructor===Uint16Array)o=h;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");o=u}if(void 0===s&&(s=0),void 0===n&&(n=e.count),i.truncateDrawRange&&void 0!==t&&null===t.index){const i=s+n,r=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;s=Math.max(s,t.drawRange.start),(n=Math.min(i,r)-s)<0&&(n=0)}if(0===n)return null;const a=function(e,t,s){const n={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)};for(let i=t;i<t+s;i++)for(let t=0;t<e.itemSize;t++){let s;e.itemSize>4?s=e.array[i*e.itemSize+t]:0===t?s=e.getX(i):1===t?s=e.getY(i):2===t?s=e.getZ(i):3===t&&(s=e.getW(i)),n.min[t]=Math.min(n.min[t],s),n.max[t]=Math.max(n.max[t],s)}return n}(e,s,n);let l;void 0!==t&&(l=e===t.index?f:m);const c=this.processBufferView(e,o,s,n,l),g={bufferView:c.id,byteOffset:c.byteOffset,componentType:o,count:n,max:a.max,min:a.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(g.normalized=!0),r.accessors||(r.accessors=[]),r.accessors.push(g)-1}processImage(e,t,s){const i=this,r=i.cache,o=i.json,a=i.options,l=i.pending;r.images.has(e)||r.images.set(e,{});const c=r.images.get(e),u=t===n.RGBAFormat?"image/png":"image/jpeg",h=u+":flipY/"+s.toString();if(void 0!==c[h])return c[h];o.images||(o.images=[]);const d={mimeType:u};if(a.embedImages){const r=I=I||document.createElement("canvas");r.width=Math.min(e.width,a.maxTextureSize),r.height=Math.min(e.height,a.maxTextureSize);const o=r.getContext("2d");if(!0===s&&(o.translate(0,r.height),o.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)o.drawImage(e,0,0,r.width,r.height);else{t!==n.RGBAFormat&&t!==n.RGBFormat&&console.error("GLTFExporter: Only RGB and RGBA formats are supported."),(e.width>a.maxTextureSize||e.height>a.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);const s=new Uint8ClampedArray(e.height*e.width*4);if(t===n.RGBAFormat)for(let t=0;t<s.length;t+=4)s[t+0]=e.data[t+0],s[t+1]=e.data[t+1],s[t+2]=e.data[t+2],s[t+3]=e.data[t+3];else for(let t=0,n=0;t<s.length;t+=4,n+=3)s[t+0]=e.data[n+0],s[t+1]=e.data[n+1],s[t+2]=e.data[n+2],s[t+3]=255;o.putImageData(new ImageData(s,e.width,e.height),0,0)}!0===a.binary?l.push(new Promise((function(e){r.toBlob((function(t){i.processBufferViewImage(t).then((function(t){d.bufferView=t,e()}))}),u)}))):d.uri=r.toDataURL(u)}else d.uri=e.src;const p=o.images.push(d)-1;return c[h]=p,p}processSampler(e){const t=this.json;t.samplers||(t.samplers=[]);const s={magFilter:k[e.magFilter],minFilter:k[e.minFilter],wrapS:k[e.wrapS],wrapT:k[e.wrapT]};return t.samplers.push(s)-1}processTexture(e){const t=this.cache,s=this.json;if(t.textures.has(e))return t.textures.get(e);s.textures||(s.textures=[]);const n={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(n.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,n)}));const i=s.textures.push(n)-1;return t.textures.set(e,i),i}processMaterial(e){const t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);const i={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");const r=e.color.toArray().concat([e.opacity]);if(E(r,[1,1,1,1])||(i.pbrMetallicRoughness.baseColorFactor=r),e.isMeshStandardMaterial?(i.pbrMetallicRoughness.metallicFactor=e.metalness,i.pbrMetallicRoughness.roughnessFactor=e.roughness):(i.pbrMetallicRoughness.metallicFactor=.5,i.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap){const t={index:this.processTexture(e.metalnessMap)};this.applyTextureTransform(t,e.metalnessMap),i.pbrMetallicRoughness.metallicRoughnessTexture=t}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){const t={index:this.processTexture(e.map)};this.applyTextureTransform(t,e.map),i.pbrMetallicRoughness.baseColorTexture=t}if(e.emissive){const t=e.emissive.toArray();if(E(t,[0,0,0])||(i.emissiveFactor=t),e.emissiveMap){const t={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(t,e.emissiveMap),i.emissiveTexture=t}}if(e.normalMap){const t={index:this.processTexture(e.normalMap)};e.normalScale&&-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),t.scale=e.normalScale.x),this.applyTextureTransform(t,e.normalMap),i.normalTexture=t}if(e.aoMap){const t={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(t.strength=e.aoMapIntensity),this.applyTextureTransform(t,e.aoMap),i.occlusionTexture=t}e.transparent?i.alphaMode="BLEND":e.alphaTest>0&&(i.alphaMode="MASK",i.alphaCutoff=e.alphaTest),e.side===n.DoubleSide&&(i.doubleSided=!0),""!==e.name&&(i.name=e.name),this.serializeUserData(e,i),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,i)}));const o=s.materials.push(i)-1;return t.materials.set(e,o),o}processMesh(e){const t=this.cache,s=this.json,i=[e.geometry.uuid];if(Array.isArray(e.material))for(let t=0,s=e.material.length;t<s;t++)i.push(e.material[t].uuid);else i.push(e.material.uuid);const u=i.join(":");if(t.meshes.has(u))return t.meshes.get(u);const h=e.geometry;let d;if(d=e.isLineSegments?o:e.isLineLoop?a:e.isLine?l:e.isPoints?r:e.material.wireframe?o:c,!0!==h.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");const p={},m={},f=[],g=[],v={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},y=h.getAttribute("normal");void 0===y||this.isNormalizedNormalAttribute(y)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),h.setAttribute("normal",this.createNormalizedNormalAttribute(y)));let b=null;for(let e in h.attributes){if("morph"===e.substr(0,5))continue;const s=h.attributes[e];e=v[e]||e.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(e)||(e="_"+e),t.attributes.has(this.getUID(s))){m[e]=t.attributes.get(this.getUID(s));continue}b=null;const i=s.array;"JOINTS_0"!==e||i instanceof Uint16Array||i instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),b=new n.BufferAttribute(new Uint16Array(i),s.itemSize,s.normalized));const r=this.processAccessor(b||s,h);null!==r&&(m[e]=r,t.attributes.set(this.getUID(s),r))}if(void 0!==y&&h.setAttribute("normal",y),0===Object.keys(m).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){const s=[],n=[],i={};if(void 0!==e.morphTargetDictionary)for(const t in e.morphTargetDictionary)i[e.morphTargetDictionary[t]]=t;for(let r=0;r<e.morphTargetInfluences.length;++r){const o={};let a=!1;for(const e in h.morphAttributes){if("position"!==e&&"normal"!==e){a||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),a=!0);continue}const s=h.morphAttributes[e][r],n=e.toUpperCase(),i=h.attributes[e];if(t.attributes.has(this.getUID(s))){o[n]=t.attributes.get(this.getUID(s));continue}const l=s.clone();if(!h.morphTargetsRelative)for(let e=0,t=s.count;e<t;e++)l.setXYZ(e,s.getX(e)-i.getX(e),s.getY(e)-i.getY(e),s.getZ(e)-i.getZ(e));o[n]=this.processAccessor(l,h),t.attributes.set(this.getUID(i),o[n])}g.push(o),s.push(e.morphTargetInfluences[r]),void 0!==e.morphTargetDictionary&&n.push(i[r])}p.weights=s,n.length>0&&(p.extras={},p.extras.targetNames=n)}const w=Array.isArray(e.material);if(w&&0===h.groups.length)return null;const M=w?e.material:[e.material],x=w?h.groups:[{materialIndex:0,start:void 0,count:void 0}];for(let e=0,s=x.length;e<s;e++){const s={mode:d,attributes:m};if(this.serializeUserData(h,s),g.length>0&&(s.targets=g),null!==h.index){let n=this.getUID(h.index);void 0===x[e].start&&void 0===x[e].count||(n+=":"+x[e].start+":"+x[e].count),t.attributes.has(n)?s.indices=t.attributes.get(n):(s.indices=this.processAccessor(h.index,h,x[e].start,x[e].count),t.attributes.set(n,s.indices)),null===s.indices&&delete s.indices}const n=this.processMaterial(M[x[e].materialIndex]);null!==n&&(s.material=n),f.push(s)}p.primitives=f,s.meshes||(s.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,p)}));const T=s.meshes.push(p)-1;return t.meshes.set(u,T),T}processCamera(e){const t=this.json;t.cameras||(t.cameras=[]);const s=e.isOrthographicCamera,i={type:s?"orthographic":"perspective"};return s?i.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:i.perspective={aspectRatio:e.aspect,yfov:n.MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(i.name=e.type),t.cameras.push(i)-1}processAnimation(e,t){const s=this.json,r=this.nodeMap;s.animations||(s.animations=[]);const o=(e=i.Utils.mergeMorphTargetTracks(e.clone(),t)).tracks,a=[],l=[];for(let e=0;e<o.length;++e){const s=o[e],i=n.PropertyBinding.parseTrackName(s.name);let c=n.PropertyBinding.findNode(t,i.nodeName);const u=A[i.propertyName];if("bones"===i.objectName&&(c=!0===c.isSkinnedMesh?c.skeleton.getBoneByName(i.objectIndex):void 0),!c||!u)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',s.name),null;const h=1;let d,p=s.values.length/s.times.length;u===A.morphTargetInfluences&&(p/=c.morphTargetInfluences.length),!0===s.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(d="CUBICSPLINE",p/=3):d=s.getInterpolation()===n.InterpolateDiscrete?"STEP":"LINEAR",l.push({input:this.processAccessor(new n.BufferAttribute(s.times,h)),output:this.processAccessor(new n.BufferAttribute(s.values,p)),interpolation:d}),a.push({sampler:l.length-1,target:{node:r.get(c),path:u}})}return s.animations.push({name:e.name||"clip_"+s.animations.length,samplers:l,channels:a}),s.animations.length-1}processSkin(e){const t=this.json,s=this.nodeMap,i=t.nodes[s.get(e)],r=e.skeleton;if(void 0===r)return null;const o=e.skeleton.bones[0];if(void 0===o)return null;const a=[],l=new Float32Array(16*r.bones.length),c=new n.Matrix4;for(let t=0;t<r.bones.length;++t)a.push(s.get(r.bones[t])),c.copy(r.boneInverses[t]),c.multiply(e.bindMatrix).toArray(l,16*t);void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new n.BufferAttribute(l,16)),joints:a,skeleton:s.get(o)});return i.skin=t.skins.length-1}processNode(e){const t=this.json,s=this.options,n=this.nodeMap;t.nodes||(t.nodes=[]);const i={};if(s.trs){const t=e.quaternion.toArray(),s=e.position.toArray(),n=e.scale.toArray();E(t,[0,0,0,1])||(i.rotation=t),E(s,[0,0,0])||(i.translation=s),E(n,[1,1,1])||(i.scale=n)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===E(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(i.matrix=e.matrix.elements);if(""!==e.name&&(i.name=String(e.name)),this.serializeUserData(e,i),e.isMesh||e.isLine||e.isPoints){const t=this.processMesh(e);null!==t&&(i.mesh=t)}else e.isCamera&&(i.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){const t=[];for(let n=0,i=e.children.length;n<i;n++){const i=e.children[n];if(i.visible||!1===s.onlyVisible){const e=this.processNode(i);null!==e&&t.push(e)}}t.length>0&&(i.children=t)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,i)}));const r=t.nodes.push(i)-1;return n.set(e,r),r}processScene(e){const t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);const n={};""!==e.name&&(n.name=e.name),t.scenes.push(n);const i=[];for(let t=0,n=e.children.length;t<n;t++){const n=e.children[t];if(n.visible||!1===s.onlyVisible){const e=this.processNode(n);null!==e&&i.push(e)}}i.length>0&&(n.nodes=i),this.serializeUserData(e,n)}processObjects(e){const t=new n.Scene;t.name="AuxScene";for(let s=0;s<e.length;s++)t.children.push(e[s]);this.processScene(t)}processInput(e){const t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));const s=[];for(let t=0;t<e.length;t++)e[t]instanceof n.Scene?this.processScene(e[t]):s.push(e[t]);s.length>0&&this.processObjects(s);for(let e=0;e<this.skins.length;++e)this.processSkin(this.skins[e]);for(let s=0;s<t.animations.length;++s)this.processAnimation(t.animations[s],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))}_invokeAll(e){for(let t=0,s=this.plugins.length;t<s;t++)e(this.plugins[t])}}class P{constructor(e){this.writer=e,this.name="KHR_lights_punctual"}writeNode(e,t){if(!e.isLight)return;if(!e.isDirectionalLight&&!e.isPointLight&&!e.isSpotLight)return void console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e);const s=this.writer,n=s.json,i=s.extensionsUsed,r={};e.name&&(r.name=e.name),r.color=e.color.toArray(),r.intensity=e.intensity,e.isDirectionalLight?r.type="directional":e.isPointLight?(r.type="point",e.distance>0&&(r.range=e.distance)):e.isSpotLight&&(r.type="spot",e.distance>0&&(r.range=e.distance),r.spot={},r.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,r.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),i[this.name]||(n.extensions=n.extensions||{},n.extensions[this.name]={lights:[]},i[this.name]=!0);const o=n.extensions[this.name].lights;o.push(r),t.extensions=t.extensions||{},t.extensions[this.name]={light:o.length-1}}}class O{constructor(e){this.writer=e,this.name="KHR_materials_unlit"}writeMaterial(e,t){if(!e.isMeshBasicMaterial)return;const s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}class C{constructor(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}writeMaterial(e,t){if(!e.isGLTFSpecularGlossinessMaterial)return;const s=this.writer,n=s.extensionsUsed,i={};t.pbrMetallicRoughness.baseColorFactor&&(i.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);const r=[1,1,1];if(e.specular.toArray(r,0),i.specularFactor=r,i.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(i.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){const t={index:s.processTexture(e.specularMap)};s.applyTextureTransform(t,e.specularMap),i.specularGlossinessTexture=t}t.extensions=t.extensions||{},t.extensions[this.name]=i,n[this.name]=!0}}i.Utils={insertKeyframe:function(e,t){const s=.001,n=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),r=new e.ValueBufferType(e.values.length+n),o=e.createInterpolant(new e.ValueBufferType(n));let a;if(0===e.times.length){i[0]=t;for(let e=0;e<n;e++)r[e]=0;a=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<s)return 0;i[0]=t,i.set(e.times,1),r.set(o.evaluate(t),0),r.set(e.values,n),a=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<s)return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),r.set(e.values,0),r.set(o.evaluate(t),e.values.length),a=i.length-1}else for(let l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<s)return l;if(e.times[l]<t&&e.times[l+1]>t){i.set(e.times.slice(0,l+1),0),i[l+1]=t,i.set(e.times.slice(l+1),l+2),r.set(e.values.slice(0,(l+1)*n),0),r.set(o.evaluate(t),(l+1)*n),r.set(e.values.slice((l+1)*n),(l+2)*n),a=l+1;break}}return e.times=i,e.values=r,a},mergeMorphTargetTracks:function(e,t){const s=[],i={},r=e.tracks;for(let e=0;e<r.length;++e){let o=r[e];const a=n.PropertyBinding.parseTrackName(o.name),l=n.PropertyBinding.findNode(t,a.nodeName);if("morphTargetInfluences"!==a.propertyName||void 0===a.propertyIndex){s.push(o);continue}if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),o=o.clone(),o.setInterpolation(n.InterpolateLinear)}const c=l.morphTargetInfluences.length,u=l.morphTargetDictionary[a.propertyIndex];if(void 0===u)throw new Error("THREE.GLTFExporter: Morph target name not found: "+a.propertyIndex);let h;if(void 0===i[l.uuid]){h=o.clone();const e=new h.ValueBufferType(c*h.times.length);for(let t=0;t<h.times.length;t++)e[t*c+u]=h.values[t];h.name=(a.nodeName||"")+".morphTargetInfluences",h.values=e,i[l.uuid]=h,s.push(h);continue}const d=o.createInterpolant(new o.ValueBufferType(1));h=i[l.uuid];for(let e=0;e<h.times.length;e++)h.values[e*c+u]=d.evaluate(h.times[e]);for(let e=0;e<o.times.length;e++){const t=this.insertKeyframe(h,o.times[e]);h.values[t*c+u]=o.values[e]}}return e.tracks=s,e}}},"./node_modules/three/examples/jsm/loaders/GLTFLoader.js":(e,t,s)=>{"use strict";s.r(t),s.d(t,{GLTFLoader:()=>i});var n=s("./node_modules/three/build/three.module.js");class i extends n.Loader{constructor(e){super(e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new c(e)})),this.register((function(e){return new h(e)})),this.register((function(e){return new d(e)})),this.register((function(e){return new u(e)})),this.register((function(e){return new a(e)})),this.register((function(e){return new p(e)}))}load(e,t,s,i){const r=this;let o;o=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:n.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);const a=function(t){i?i(t):console.error(t),r.manager.itemError(e),r.manager.itemEnd(e)},l=new n.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(s){try{r.parse(s,o,(function(s){t(s),r.manager.itemEnd(e)}),a)}catch(e){a(e)}}),s,a)}setDRACOLoader(e){return this.dracoLoader=e,this}setDDSLoader(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')}setKTX2Loader(e){return this.ktx2Loader=e,this}setMeshoptDecoder(e){return this.meshoptDecoder=e,this}register(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this}unregister(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this}parse(e,t,s,i){let r;const a={},c={};if("string"==typeof e)r=e;else{if(n.LoaderUtils.decodeText(new Uint8Array(e,0,4))===m){try{a[o.KHR_BINARY_GLTF]=new v(e)}catch(e){return void(i&&i(e))}r=a[o.KHR_BINARY_GLTF].content}else r=n.LoaderUtils.decodeText(new Uint8Array(e))}const u=JSON.parse(r);if(void 0===u.asset||u.asset.version[0]<2)return void(i&&i(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported.")));const h=new Y(u,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});h.fileLoader.setRequestHeader(this.requestHeader);for(let e=0;e<this.pluginCallbacks.length;e++){const t=this.pluginCallbacks[e](h);c[t.name]=t,a[t.name]=!0}if(u.extensionsUsed)for(let e=0;e<u.extensionsUsed.length;++e){const t=u.extensionsUsed[e],s=u.extensionsRequired||[];switch(t){case o.KHR_MATERIALS_UNLIT:a[t]=new l;break;case o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:a[t]=new M;break;case o.KHR_DRACO_MESH_COMPRESSION:a[t]=new y(u,this.dracoLoader);break;case o.KHR_TEXTURE_TRANSFORM:a[t]=new b;break;case o.KHR_MESH_QUANTIZATION:a[t]=new x;break;default:s.indexOf(t)>=0&&void 0===c[t]&&console.warn('THREE.GLTFLoader: Unknown extension "'+t+'".')}}h.setExtensions(a),h.setPlugins(c),h.parse(s,i)}}function r(){let e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}const o={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};class a{constructor(e){this.parser=e,this.name=o.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}_markDefs(){const e=this.parser,t=this.parser.json.nodes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}}_loadLight(e){const t=this.parser,s="light:"+e;let i=t.cache.get(s);if(i)return i;const r=t.json,o=((r.extensions&&r.extensions[this.name]||{}).lights||[])[e];let a;const l=new n.Color(16777215);void 0!==o.color&&l.fromArray(o.color);const c=void 0!==o.range?o.range:0;switch(o.type){case"directional":a=new n.DirectionalLight(l),a.target.position.set(0,0,-1),a.add(a.target);break;case"point":a=new n.PointLight(l),a.distance=c;break;case"spot":a=new n.SpotLight(l),a.distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,a.angle=o.spot.outerConeAngle,a.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,a.target.position.set(0,0,-1),a.add(a.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return a.position.set(0,0,0),a.decay=2,void 0!==o.intensity&&(a.intensity=o.intensity),a.name=t.createUniqueName(o.name||"light_"+e),i=Promise.resolve(a),t.cache.add(s,i),i}createNodeAttachment(e){const t=this,s=this.parser,n=s.json.nodes[e],i=(n.extensions&&n.extensions[this.name]||{}).light;return void 0===i?null:this._loadLight(i).then((function(e){return s._getNodeRef(t.cache,i,e)}))}}class l{constructor(){this.name=o.KHR_MATERIALS_UNLIT}getMaterialType(){return n.MeshBasicMaterial}extendParams(e,t,s){const i=[];e.color=new n.Color(1,1,1),e.opacity=1;const r=t.pbrMetallicRoughness;if(r){if(Array.isArray(r.baseColorFactor)){const t=r.baseColorFactor;e.color.fromArray(t),e.opacity=t[3]}void 0!==r.baseColorTexture&&i.push(s.assignTexture(e,"map",r.baseColorTexture))}return Promise.all(i)}}class c{constructor(e){this.parser=e,this.name=o.KHR_MATERIALS_CLEARCOAT}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?n.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,i=s.json.materials[e];if(!i.extensions||!i.extensions[this.name])return Promise.resolve();const r=[],o=i.extensions[this.name];if(void 0!==o.clearcoatFactor&&(t.clearcoat=o.clearcoatFactor),void 0!==o.clearcoatTexture&&r.push(s.assignTexture(t,"clearcoatMap",o.clearcoatTexture)),void 0!==o.clearcoatRoughnessFactor&&(t.clearcoatRoughness=o.clearcoatRoughnessFactor),void 0!==o.clearcoatRoughnessTexture&&r.push(s.assignTexture(t,"clearcoatRoughnessMap",o.clearcoatRoughnessTexture)),void 0!==o.clearcoatNormalTexture&&(r.push(s.assignTexture(t,"clearcoatNormalMap",o.clearcoatNormalTexture)),void 0!==o.clearcoatNormalTexture.scale)){const e=o.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new n.Vector2(e,-e)}return Promise.all(r)}}class u{constructor(e){this.parser=e,this.name=o.KHR_MATERIALS_TRANSMISSION}getMaterialType(e){const t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?n.MeshPhysicalMaterial:null}extendMaterialParams(e,t){const s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();const i=[],r=n.extensions[this.name];return void 0!==r.transmissionFactor&&(t.transmission=r.transmissionFactor),void 0!==r.transmissionTexture&&i.push(s.assignTexture(t,"transmissionMap",r.transmissionTexture)),Promise.all(i)}}class h{constructor(e){this.parser=e,this.name=o.KHR_TEXTURE_BASISU}loadTexture(e){const t=this.parser,s=t.json,n=s.textures[e];if(!n.extensions||!n.extensions[this.name])return null;const i=n.extensions[this.name],r=s.images[i.source],o=t.options.ktx2Loader;if(!o){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,r,o)}}class d{constructor(e){this.parser=e,this.name=o.EXT_TEXTURE_WEBP,this.isSupported=null}loadTexture(e){const t=this.name,s=this.parser,n=s.json,i=n.textures[e];if(!i.extensions||!i.extensions[t])return null;const r=i.extensions[t],o=n.images[r.source];let a=s.textureLoader;if(o.uri){const e=s.options.manager.getHandler(o.uri);null!==e&&(a=e)}return this.detectSupport().then((function(i){if(i)return s.loadTextureImage(e,o,a);if(n.extensionsRequired&&n.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))}detectSupport(){return this.isSupported||(this.isSupported=new Promise((function(e){const t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported}}class p{constructor(e){this.name=o.EXT_MESHOPT_COMPRESSION,this.parser=e}loadBufferView(e){const t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){const e=s.extensions[this.name],n=this.parser.getDependency("buffer",e.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([n,i.ready]).then((function(t){const s=e.byteOffset||0,n=e.byteLength||0,r=e.count,o=e.byteStride,a=new ArrayBuffer(r*o),l=new Uint8Array(t[0],s,n);return i.decodeGltfBuffer(new Uint8Array(a),r,o,l,e.mode,e.filter),a}))}return null}}const m="glTF",f=1313821514,g=5130562;class v{constructor(e){this.name=o.KHR_BINARY_GLTF,this.content=null,this.body=null;const t=new DataView(e,0,12);if(this.header={magic:n.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==m)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");const s=this.header.length-12,i=new DataView(e,12);let r=0;for(;r<s;){const t=i.getUint32(r,!0);r+=4;const s=i.getUint32(r,!0);if(r+=4,s===f){const s=new Uint8Array(e,12+r,t);this.content=n.LoaderUtils.decodeText(s)}else if(s===g){const s=12+r;this.body=e.slice(s,s+t)}r+=t}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}}class y{constructor(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=o.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}decodePrimitive(e,t){const s=this.json,n=this.dracoLoader,i=e.extensions[this.name].bufferView,r=e.extensions[this.name].attributes,o={},a={},l={};for(const e in r){const t=N[e]||e.toLowerCase();o[t]=r[e]}for(const t in e.attributes){const n=N[t]||t.toLowerCase();if(void 0!==r[t]){const i=s.accessors[e.attributes[t]],r=L[i.componentType];l[n]=r,a[n]=!0===i.normalized}}return t.getDependency("bufferView",i).then((function(e){return new Promise((function(t){n.decodeDracoFile(e,(function(e){for(const t in e.attributes){const s=e.attributes[t],n=a[t];void 0!==n&&(s.normalized=n)}t(e)}),o,l)}))}))}}class b{constructor(){this.name=o.KHR_TEXTURE_TRANSFORM}extendTexture(e,t){return void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),void 0===t.offset&&void 0===t.rotation&&void 0===t.scale||(e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),e.needsUpdate=!0),e}}class w extends n.MeshStandardMaterial{constructor(e){super(),this.isGLTFSpecularGlossinessMaterial=!0;const t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),i=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),r=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),o=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),a={specular:{value:(new n.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=a,this.onBeforeCompile=function(e){for(const t in a)e.uniforms[t]=a[t];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",i).replace("#include <metalnessmap_fragment>",r).replace("#include <lights_physical_fragment>",o)},Object.defineProperties(this,{specular:{get:function(){return a.specular.value},set:function(e){a.specular.value=e}},specularMap:{get:function(){return a.specularMap.value},set:function(e){a.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return a.glossiness.value},set:function(e){a.glossiness.value=e}},glossinessMap:{get:function(){return a.glossinessMap.value},set:function(e){a.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}copy(e){return super.copy(e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this}}class M{constructor(){this.name=o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,this.specularGlossinessParams=["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"]}getMaterialType(){return w}extendParams(e,t,s){const i=t.extensions[this.name];e.color=new n.Color(1,1,1),e.opacity=1;const r=[];if(Array.isArray(i.diffuseFactor)){const t=i.diffuseFactor;e.color.fromArray(t),e.opacity=t[3]}if(void 0!==i.diffuseTexture&&r.push(s.assignTexture(e,"map",i.diffuseTexture)),e.emissive=new n.Color(0,0,0),e.glossiness=void 0!==i.glossinessFactor?i.glossinessFactor:1,e.specular=new n.Color(1,1,1),Array.isArray(i.specularFactor)&&e.specular.fromArray(i.specularFactor),void 0!==i.specularGlossinessTexture){const t=i.specularGlossinessTexture;r.push(s.assignTexture(e,"glossinessMap",t)),r.push(s.assignTexture(e,"specularMap",t))}return Promise.all(r)}createMaterial(e){const t=new w(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=n.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}class x{constructor(){this.name=o.KHR_MESH_QUANTIZATION}}class T extends n.Interpolant{constructor(e,t,s,n){super(e,t,s,n)}copySampleValue_(e){const t=this.resultBuffer,s=this.sampleValues,n=this.valueSize,i=e*n*3+n;for(let e=0;e!==n;e++)t[e]=s[i+e];return t}}T.prototype.beforeStart_=T.prototype.copySampleValue_,T.prototype.afterEnd_=T.prototype.copySampleValue_,T.prototype.interpolate_=function(e,t,s,n){const i=this.resultBuffer,r=this.sampleValues,o=this.valueSize,a=2*o,l=3*o,c=n-t,u=(s-t)/c,h=u*u,d=h*u,p=e*l,m=p-l,f=-2*d+3*h,g=d-h,v=1-f,y=g-h+u;for(let e=0;e!==o;e++){const t=r[m+e+o],s=r[m+e+a]*c,n=r[p+e+o],l=r[p+e]*c;i[e]=v*t+y*s+f*n+g*l}return i};const S=0,k=1,A=2,E=3,R=4,_=5,I=6,L={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},P={9728:n.NearestFilter,9729:n.LinearFilter,9984:n.NearestMipmapNearestFilter,9985:n.LinearMipmapNearestFilter,9986:n.NearestMipmapLinearFilter,9987:n.LinearMipmapLinearFilter},O={33071:n.ClampToEdgeWrapping,33648:n.MirroredRepeatWrapping,10497:n.RepeatWrapping},C={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},N={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},F={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},B={CUBICSPLINE:void 0,LINEAR:n.InterpolateLinear,STEP:n.InterpolateDiscrete},j="OPAQUE",U="MASK",V="BLEND";function H(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function G(e,t,s){for(const n in s.extensions)void 0===e[n]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[n]=s.extensions[n])}function D(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function z(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(let s=0,n=t.weights.length;s<n;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){const s=t.extras.targetNames;if(e.morphTargetInfluences.length===s.length){e.morphTargetDictionary={};for(let t=0,n=s.length;t<n;t++)e.morphTargetDictionary[s[t]]=t}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function K(e){const t=e.extensions&&e.extensions[o.KHR_DRACO_MESH_COMPRESSION];let s;return s=t?"draco:"+t.bufferView+":"+t.indices+":"+W(t.attributes):e.indices+":"+W(e.attributes)+":"+e.mode,s}function W(e){let t="";const s=Object.keys(e).sort();for(let n=0,i=s.length;n<i;n++)t+=s[n]+":"+e[s[n]]+";";return t}function X(e){switch(e){case Int8Array:return 1/127;case Uint8Array:return 1/255;case Int16Array:return 1/32767;case Uint16Array:return 1/65535;default:throw new Error("THREE.GLTFLoader: Unsupported normalized accessor component type.")}}class Y{constructor(e={},t={}){this.json=e,this.extensions={},this.plugins={},this.options=t,this.cache=new r,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.textureCache={},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new n.ImageBitmapLoader(this.options.manager):this.textureLoader=new n.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new n.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}setExtensions(e){this.extensions=e}setPlugins(e){this.plugins=e}parse(e,t){const s=this,n=this.json,i=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){const r={scene:t[0][n.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:n.asset,parser:s,userData:{}};G(i,r,n),D(r,n),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(r)}))).then((function(){e(r)}))})).catch(t)}_markDefs(){const e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[];for(let s=0,n=t.length;s<n;s++){const n=t[s].joints;for(let t=0,s=n.length;t<s;t++)e[n[t]].isBone=!0}for(let t=0,n=e.length;t<n;t++){const n=e[t];void 0!==n.mesh&&(this._addNodeRef(this.meshCache,n.mesh),void 0!==n.skin&&(s[n.mesh].isSkinnedMesh=!0)),void 0!==n.camera&&this._addNodeRef(this.cameraCache,n.camera)}}_addNodeRef(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)}_getNodeRef(e,t,s){if(e.refs[t]<=1)return s;const n=s.clone();return n.name+="_instance_"+e.uses[t]++,n}_invokeOne(e){const t=Object.values(this.plugins);t.push(this);for(let s=0;s<t.length;s++){const n=e(t[s]);if(n)return n}return null}_invokeAll(e){const t=Object.values(this.plugins);t.unshift(this);const s=[];for(let n=0;n<t.length;n++){const i=e(t[n]);i&&s.push(i)}return s}getDependency(e,t){const s=e+":"+t;let n=this.cache.get(s);if(!n){switch(e){case"scene":n=this.loadScene(t);break;case"node":n=this.loadNode(t);break;case"mesh":n=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":n=this.loadAccessor(t);break;case"bufferView":n=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":n=this.loadBuffer(t);break;case"material":n=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":n=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":n=this.loadSkin(t);break;case"animation":n=this.loadAnimation(t);break;case"camera":n=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,n)}return n}getDependencies(e){let t=this.cache.get(e);if(!t){const s=this,n=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(n.map((function(t,n){return s.getDependency(e,n)}))),this.cache.add(e,t)}return t}loadBuffer(e){const t=this.json.buffers[e],s=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[o.KHR_BINARY_GLTF].body);const n=this.options;return new Promise((function(e,i){s.load(H(t.uri,n.path),e,void 0,(function(){i(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))}loadBufferView(e){const t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){const s=t.byteLength||0,n=t.byteOffset||0;return e.slice(n,n+s)}))}loadAccessor(e){const t=this,s=this.json,i=this.json.accessors[e];if(void 0===i.bufferView&&void 0===i.sparse)return Promise.resolve(null);const r=[];return void 0!==i.bufferView?r.push(this.getDependency("bufferView",i.bufferView)):r.push(null),void 0!==i.sparse&&(r.push(this.getDependency("bufferView",i.sparse.indices.bufferView)),r.push(this.getDependency("bufferView",i.sparse.values.bufferView))),Promise.all(r).then((function(e){const r=e[0],o=C[i.type],a=L[i.componentType],l=a.BYTES_PER_ELEMENT,c=l*o,u=i.byteOffset||0,h=void 0!==i.bufferView?s.bufferViews[i.bufferView].byteStride:void 0,d=!0===i.normalized;let p,m;if(h&&h!==c){const e=Math.floor(u/h),s="InterleavedBuffer:"+i.bufferView+":"+i.componentType+":"+e+":"+i.count;let c=t.cache.get(s);c||(p=new a(r,e*h,i.count*h/l),c=new n.InterleavedBuffer(p,h/l),t.cache.add(s,c)),m=new n.InterleavedBufferAttribute(c,o,u%h/l,d)}else p=null===r?new a(i.count*o):new a(r,u,i.count*o),m=new n.BufferAttribute(p,o,d);if(void 0!==i.sparse){const t=C.SCALAR,s=L[i.sparse.indices.componentType],l=i.sparse.indices.byteOffset||0,c=i.sparse.values.byteOffset||0,u=new s(e[1],l,i.sparse.count*t),h=new a(e[2],c,i.sparse.count*o);null!==r&&(m=new n.BufferAttribute(m.array.slice(),m.itemSize,m.normalized));for(let e=0,t=u.length;e<t;e++){const t=u[e];if(m.setX(t,h[e*o]),o>=2&&m.setY(t,h[e*o+1]),o>=3&&m.setZ(t,h[e*o+2]),o>=4&&m.setW(t,h[e*o+3]),o>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return m}))}loadTexture(e){const t=this.json,s=this.options,n=t.textures[e],i=t.images[n.source];let r=this.textureLoader;if(i.uri){const e=s.manager.getHandler(i.uri);null!==e&&(r=e)}return this.loadTextureImage(e,i,r)}loadTextureImage(e,t,s){const i=this,r=this.json,o=this.options,a=r.textures[e],l=(t.uri||t.bufferView)+":"+a.sampler;if(this.textureCache[l])return this.textureCache[l];const c=self.URL||self.webkitURL;let u=t.uri||"",h=!1,d=!0;const p=u.search(/\.jpe?g($|\?)/i)>0||0===u.search(/^data\:image\/jpeg/);if(("image/jpeg"===t.mimeType||p)&&(d=!1),void 0!==t.bufferView)u=i.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){const t=new DataView(e,25,1).getUint8(0,!1);d=6===t||4===t||3===t}h=!0;const s=new Blob([e],{type:t.mimeType});return u=c.createObjectURL(s),u}));else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");const m=Promise.resolve(u).then((function(e){return new Promise((function(t,i){let r=t;!0===s.isImageBitmapLoader&&(r=function(e){t(new n.CanvasTexture(e))}),s.load(H(e,o.path),r,void 0,i)}))})).then((function(t){!0===h&&c.revokeObjectURL(u),t.flipY=!1,a.name&&(t.name=a.name),d||(t.format=n.RGBFormat);const s=(r.samplers||{})[a.sampler]||{};return t.magFilter=P[s.magFilter]||n.LinearFilter,t.minFilter=P[s.minFilter]||n.LinearMipmapLinearFilter,t.wrapS=O[s.wrapS]||n.RepeatWrapping,t.wrapT=O[s.wrapT]||n.RepeatWrapping,i.associations.set(t,{type:"textures",index:e}),t}));return this.textureCache[l]=m,m}assignTexture(e,t,s){const n=this;return this.getDependency("texture",s.index).then((function(i){if(void 0===s.texCoord||0==s.texCoord||"aoMap"===t&&1==s.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+s.texCoord+" for texture "+t+" not yet supported."),n.extensions[o.KHR_TEXTURE_TRANSFORM]){const e=void 0!==s.extensions?s.extensions[o.KHR_TEXTURE_TRANSFORM]:void 0;if(e){const t=n.associations.get(i);i=n.extensions[o.KHR_TEXTURE_TRANSFORM].extendTexture(i,e),n.associations.set(i,t)}}e[t]=i}))}assignFinalMaterial(e){const t=e.geometry;let s=e.material;const i=void 0!==t.attributes.tangent,r=void 0!==t.attributes.color,o=void 0===t.attributes.normal,a=Object.keys(t.morphAttributes).length>0,l=a&&void 0!==t.morphAttributes.normal;if(e.isPoints){const e="PointsMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new n.PointsMaterial,n.Material.prototype.copy.call(t,s),t.color.copy(s.color),t.map=s.map,t.sizeAttenuation=!1,this.cache.add(e,t)),s=t}else if(e.isLine){const e="LineBasicMaterial:"+s.uuid;let t=this.cache.get(e);t||(t=new n.LineBasicMaterial,n.Material.prototype.copy.call(t,s),t.color.copy(s.color),this.cache.add(e,t)),s=t}if(i||r||o||a){let e="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(e+="specular-glossiness:"),i&&(e+="vertex-tangents:"),r&&(e+="vertex-colors:"),o&&(e+="flat-shading:"),a&&(e+="morph-targets:"),l&&(e+="morph-normals:");let t=this.cache.get(e);t||(t=s.clone(),r&&(t.vertexColors=!0),o&&(t.flatShading=!0),a&&(t.morphTargets=!0),l&&(t.morphNormals=!0),i&&(t.vertexTangents=!0,t.normalScale&&(t.normalScale.y*=-1),t.clearcoatNormalScale&&(t.clearcoatNormalScale.y*=-1)),this.cache.add(e,t),this.associations.set(t,this.associations.get(s))),s=t}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=s}getMaterialType(){return n.MeshStandardMaterial}loadMaterial(e){const t=this,s=this.json,i=this.extensions,r=s.materials[e];let a;const l={},c=r.extensions||{},u=[];if(c[o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){const e=i[o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];a=e.getMaterialType(),u.push(e.extendParams(l,r,t))}else if(c[o.KHR_MATERIALS_UNLIT]){const e=i[o.KHR_MATERIALS_UNLIT];a=e.getMaterialType(),u.push(e.extendParams(l,r,t))}else{const s=r.pbrMetallicRoughness||{};if(l.color=new n.Color(1,1,1),l.opacity=1,Array.isArray(s.baseColorFactor)){const e=s.baseColorFactor;l.color.fromArray(e),l.opacity=e[3]}void 0!==s.baseColorTexture&&u.push(t.assignTexture(l,"map",s.baseColorTexture)),l.metalness=void 0!==s.metallicFactor?s.metallicFactor:1,l.roughness=void 0!==s.roughnessFactor?s.roughnessFactor:1,void 0!==s.metallicRoughnessTexture&&(u.push(t.assignTexture(l,"metalnessMap",s.metallicRoughnessTexture)),u.push(t.assignTexture(l,"roughnessMap",s.metallicRoughnessTexture))),a=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),u.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,l)}))))}!0===r.doubleSided&&(l.side=n.DoubleSide);const h=r.alphaMode||j;return h===V?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,h===U&&(l.alphaTest=void 0!==r.alphaCutoff?r.alphaCutoff:.5)),void 0!==r.normalTexture&&a!==n.MeshBasicMaterial&&(u.push(t.assignTexture(l,"normalMap",r.normalTexture)),l.normalScale=new n.Vector2(1,-1),void 0!==r.normalTexture.scale&&l.normalScale.set(r.normalTexture.scale,-r.normalTexture.scale)),void 0!==r.occlusionTexture&&a!==n.MeshBasicMaterial&&(u.push(t.assignTexture(l,"aoMap",r.occlusionTexture)),void 0!==r.occlusionTexture.strength&&(l.aoMapIntensity=r.occlusionTexture.strength)),void 0!==r.emissiveFactor&&a!==n.MeshBasicMaterial&&(l.emissive=(new n.Color).fromArray(r.emissiveFactor)),void 0!==r.emissiveTexture&&a!==n.MeshBasicMaterial&&u.push(t.assignTexture(l,"emissiveMap",r.emissiveTexture)),Promise.all(u).then((function(){let s;return s=a===w?i[o.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):new a(l),r.name&&(s.name=r.name),s.map&&(s.map.encoding=n.sRGBEncoding),s.emissiveMap&&(s.emissiveMap.encoding=n.sRGBEncoding),D(s,r),t.associations.set(s,{type:"materials",index:e}),r.extensions&&G(i,s,r),s}))}createUniqueName(e){const t=n.PropertyBinding.sanitizeNodeName(e||"");let s=t;for(let e=1;this.nodeNamesUsed[s];++e)s=t+"_"+e;return this.nodeNamesUsed[s]=!0,s}loadGeometries(e){const t=this,s=this.extensions,i=this.primitiveCache;function r(e){return s[o.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return J(s,e,t)}))}const a=[];for(let s=0,l=e.length;s<l;s++){const l=e[s],c=K(l),u=i[c];if(u)a.push(u.promise);else{let e;e=l.extensions&&l.extensions[o.KHR_DRACO_MESH_COMPRESSION]?r(l):J(new n.BufferGeometry,l,t),i[c]={primitive:l,promise:e},a.push(e)}}return Promise.all(a)}loadMesh(e){const t=this,s=this.json,i=this.extensions,r=s.meshes[e],o=r.primitives,a=[];for(let e=0,t=o.length;e<t;e++){const t=void 0===o[e].material?(void 0===(l=this.cache).DefaultMaterial&&(l.DefaultMaterial=new n.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:n.FrontSide})),l.DefaultMaterial):this.getDependency("material",o[e].material);a.push(t)}var l;return a.push(t.loadGeometries(o)),Promise.all(a).then((function(s){const a=s.slice(0,s.length-1),l=s[s.length-1],c=[];for(let s=0,u=l.length;s<u;s++){const u=l[s],h=o[s];let d;const p=a[s];if(h.mode===R||h.mode===_||h.mode===I||void 0===h.mode)d=!0===r.isSkinnedMesh?new n.SkinnedMesh(u,p):new n.Mesh(u,p),!0!==d.isSkinnedMesh||d.geometry.attributes.skinWeight.normalized||d.normalizeSkinWeights(),h.mode===_?d.geometry=Z(d.geometry,n.TriangleStripDrawMode):h.mode===I&&(d.geometry=Z(d.geometry,n.TriangleFanDrawMode));else if(h.mode===k)d=new n.LineSegments(u,p);else if(h.mode===E)d=new n.Line(u,p);else if(h.mode===A)d=new n.LineLoop(u,p);else{if(h.mode!==S)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+h.mode);d=new n.Points(u,p)}Object.keys(d.geometry.morphAttributes).length>0&&z(d,r),d.name=t.createUniqueName(r.name||"mesh_"+e),D(d,r),h.extensions&&G(i,d,h),t.assignFinalMaterial(d),c.push(d)}if(1===c.length)return c[0];const u=new n.Group;for(let e=0,t=c.length;e<t;e++)u.add(c[e]);return u}))}loadCamera(e){let t;const s=this.json.cameras[e],i=s[s.type];if(i)return"perspective"===s.type?t=new n.PerspectiveCamera(n.MathUtils.radToDeg(i.yfov),i.aspectRatio||1,i.znear||1,i.zfar||2e6):"orthographic"===s.type&&(t=new n.OrthographicCamera(-i.xmag,i.xmag,i.ymag,-i.ymag,i.znear,i.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),D(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")}loadSkin(e){const t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))}loadAnimation(e){const t=this.json.animations[e],s=[],i=[],r=[],o=[],a=[];for(let e=0,n=t.channels.length;e<n;e++){const n=t.channels[e],l=t.samplers[n.sampler],c=n.target,u=void 0!==c.node?c.node:c.id,h=void 0!==t.parameters?t.parameters[l.input]:l.input,d=void 0!==t.parameters?t.parameters[l.output]:l.output;s.push(this.getDependency("node",u)),i.push(this.getDependency("accessor",h)),r.push(this.getDependency("accessor",d)),o.push(l),a.push(c)}return Promise.all([Promise.all(s),Promise.all(i),Promise.all(r),Promise.all(o),Promise.all(a)]).then((function(s){const i=s[0],r=s[1],o=s[2],a=s[3],l=s[4],c=[];for(let e=0,t=i.length;e<t;e++){const t=i[e],s=r[e],u=o[e],h=a[e],d=l[e];if(void 0===t)continue;let p;switch(t.updateMatrix(),t.matrixAutoUpdate=!0,F[d.path]){case F.weights:p=n.NumberKeyframeTrack;break;case F.rotation:p=n.QuaternionKeyframeTrack;break;case F.position:case F.scale:default:p=n.VectorKeyframeTrack}const m=t.name?t.name:t.uuid,f=void 0!==h.interpolation?B[h.interpolation]:n.InterpolateLinear,g=[];F[d.path]===F.weights?t.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&g.push(e.name?e.name:e.uuid)})):g.push(m);let v=u.array;if(u.normalized){const e=X(v.constructor),t=new Float32Array(v.length);for(let s=0,n=v.length;s<n;s++)t[s]=v[s]*e;v=t}for(let e=0,t=g.length;e<t;e++){const t=new p(g[e]+"."+F[d.path],s.array,v,f);"CUBICSPLINE"===h.interpolation&&(t.createInterpolant=function(e){return new T(this.times,this.values,this.getValueSize()/3,e)},t.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(t)}}const u=t.name?t.name:"animation_"+e;return new n.AnimationClip(u,void 0,c)}))}createNodeMesh(e){const t=this.json,s=this,n=t.nodes[e];return void 0===n.mesh?null:s.getDependency("mesh",n.mesh).then((function(e){const t=s._getNodeRef(s.meshCache,n.mesh,e);return void 0!==n.weights&&t.traverse((function(e){if(e.isMesh)for(let t=0,s=n.weights.length;t<s;t++)e.morphTargetInfluences[t]=n.weights[t]})),t}))}loadNode(e){const t=this.json,s=this.extensions,i=this,r=t.nodes[e],o=r.name?i.createUniqueName(r.name):"";return function(){const t=[],s=i._invokeOne((function(t){return t.createNodeMesh&&t.createNodeMesh(e)}));return s&&t.push(s),void 0!==r.camera&&t.push(i.getDependency("camera",r.camera).then((function(e){return i._getNodeRef(i.cameraCache,r.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)}().then((function(t){let a;if(a=!0===r.isBone?new n.Bone:t.length>1?new n.Group:1===t.length?t[0]:new n.Object3D,a!==t[0])for(let e=0,s=t.length;e<s;e++)a.add(t[e]);if(r.name&&(a.userData.name=r.name,a.name=o),D(a,r),r.extensions&&G(s,a,r),void 0!==r.matrix){const e=new n.Matrix4;e.fromArray(r.matrix),a.applyMatrix4(e)}else void 0!==r.translation&&a.position.fromArray(r.translation),void 0!==r.rotation&&a.quaternion.fromArray(r.rotation),void 0!==r.scale&&a.scale.fromArray(r.scale);return i.associations.set(a,{type:"nodes",index:e}),a}))}loadScene(e){const t=this.json,s=this.extensions,i=this.json.scenes[e],r=this,o=new n.Group;i.name&&(o.name=r.createUniqueName(i.name)),D(o,i),i.extensions&&G(s,o,i);const a=i.nodes||[],l=[];for(let e=0,s=a.length;e<s;e++)l.push(q(a[e],o,t,r));return Promise.all(l).then((function(){return o}))}}function q(e,t,s,i){const r=s.nodes[e];return i.getDependency("node",e).then((function(e){if(void 0===r.skin)return e;let t;return i.getDependency("skin",r.skin).then((function(e){t=e;const s=[];for(let e=0,n=t.joints.length;e<n;e++)s.push(i.getDependency("node",t.joints[e]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(!e.isMesh)return;const i=[],r=[];for(let e=0,o=s.length;e<o;e++){const o=s[e];if(o){i.push(o);const s=new n.Matrix4;void 0!==t.inverseBindMatrices&&s.fromArray(t.inverseBindMatrices.array,16*e),r.push(s)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[e])}e.bind(new n.Skeleton(i,r),e.matrixWorld)})),e}))})).then((function(e){t.add(e);const n=[];if(r.children){const t=r.children;for(let r=0,o=t.length;r<o;r++){const o=t[r];n.push(q(o,e,s,i))}}return Promise.all(n)}))}function J(e,t,s){const i=t.attributes,r=[];function o(t,n){return s.getDependency("accessor",t).then((function(t){e.setAttribute(n,t)}))}for(const t in i){const s=N[t]||t.toLowerCase();s in e.attributes||r.push(o(i[t],s))}if(void 0!==t.indices&&!e.index){const n=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));r.push(n)}return D(e,t),function(e,t,s){const i=t.attributes,r=new n.Box3;if(void 0===i.POSITION)return;{const e=s.json.accessors[i.POSITION],t=e.min,o=e.max;if(void 0===t||void 0===o)return void console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.");if(r.set(new n.Vector3(t[0],t[1],t[2]),new n.Vector3(o[0],o[1],o[2])),e.normalized){const t=X(L[e.componentType]);r.min.multiplyScalar(t),r.max.multiplyScalar(t)}}const o=t.targets;if(void 0!==o){const e=new n.Vector3,t=new n.Vector3;for(let n=0,i=o.length;n<i;n++){const i=o[n];if(void 0!==i.POSITION){const n=s.json.accessors[i.POSITION],r=n.min,o=n.max;if(void 0!==r&&void 0!==o){if(t.setX(Math.max(Math.abs(r[0]),Math.abs(o[0]))),t.setY(Math.max(Math.abs(r[1]),Math.abs(o[1]))),t.setZ(Math.max(Math.abs(r[2]),Math.abs(o[2]))),n.normalized){const e=X(L[n.componentType]);t.multiplyScalar(e)}e.max(t)}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}r.expandByVector(e)}e.boundingBox=r;const a=new n.Sphere;r.getCenter(a.center),a.radius=r.min.distanceTo(r.max)/2,e.boundingSphere=a}(e,t,s),Promise.all(r).then((function(){return void 0!==t.targets?function(e,t,s){let n=!1,i=!1;for(let e=0,s=t.length;e<s;e++){const s=t[e];if(void 0!==s.POSITION&&(n=!0),void 0!==s.NORMAL&&(i=!0),n&&i)break}if(!n&&!i)return Promise.resolve(e);const r=[],o=[];for(let a=0,l=t.length;a<l;a++){const l=t[a];if(n){const t=void 0!==l.POSITION?s.getDependency("accessor",l.POSITION):e.attributes.position;r.push(t)}if(i){const t=void 0!==l.NORMAL?s.getDependency("accessor",l.NORMAL):e.attributes.normal;o.push(t)}}return Promise.all([Promise.all(r),Promise.all(o)]).then((function(t){const s=t[0],r=t[1];return n&&(e.morphAttributes.position=s),i&&(e.morphAttributes.normal=r),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e}))}function Z(e,t){let s=e.getIndex();if(null===s){const t=[],n=e.getAttribute("position");if(void 0===n)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(let e=0;e<n.count;e++)t.push(e);e.setIndex(t),s=e.getIndex()}const i=s.count-2,r=[];if(t===n.TriangleFanDrawMode)for(let e=1;e<=i;e++)r.push(s.getX(0)),r.push(s.getX(e)),r.push(s.getX(e+1));else for(let e=0;e<i;e++)e%2==0?(r.push(s.getX(e)),r.push(s.getX(e+1)),r.push(s.getX(e+2))):(r.push(s.getX(e+2)),r.push(s.getX(e+1)),r.push(s.getX(e)));r.length/3!==i&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");const o=e.clone();return o.setIndex(r),o}},"./src/controller/aim.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Aim=void 0;const n=s("./src/controller/controller.ts"),i=s("./src/controller/controllerbase.ts"),r=s("./src/controller/playshot.ts");class o extends i.ControllerBase{constructor(e){super(e),this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.table.cue.aim.power=0,this.container.view.camera.suggestMode(this.container.view.camera.aimView)}handleInput(e){switch(e.key){case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"SpaceUp":return this.hit();default:if(!this.commonKeyHandler(e))return this}return this.container.sendEvent(this.container.table.cue.aim),this}hit(){return this.container.table.cue.aim.round(),this.container.sendEvent(new n.HitEvent(this.container.table.cue.aim)),new r.PlayShot(this.container)}}t.Aim=o},"./src/controller/container.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Container=void 0;const n=s("./src/events/stationaryevent.ts"),i=s("./src/model/table.ts"),r=s("./src/view/view.ts"),o=s("./src/controller/init.ts"),a=s("./src/utils/rack.ts"),l=s("./src/events/eventutil.ts"),c=s("./src/view/aiminputs.ts"),u=s("./src/view/sound.ts");t.Container=class{table;view;controller;inputQueue=[];eventQueue=[];aimInputs;keyboard;sound;last=performance.now();step=.001;broadcast;log;constructor(e,t,s,n){this.log=t,this.table=new i.Table(a.Rack.diamond()),this.view=new r.View(e,n),this.aimInputs=new c.AimInputs(this),this.keyboard=s,this.sound=new u.Sound(this.view.camera.camera),this.table.balls.forEach((e=>{this.view.addMesh(e.ballmesh.mesh),this.view.addMesh(e.ballmesh.shadow)})),this.view.addMesh(this.table.cue.mesh),this.view.addMesh(this.table.cue.helperMesh),this.view.table=this.table,this.updateController(new o.Init(this))}sendEvent(e){this.broadcast(l.EventUtil.serialise(e))}advance(e){const t=Math.floor(e/this.step),s=t*this.step,i=this.table.allStationary();for(var r=0;r<t;r++)this.table.advance(this.step);this.table.updateBallMesh(s),this.view.update(s,this.table.cue.aim),this.table.cue.update(s),!i&&this.table.allStationary()?this.eventQueue.push(new n.StationaryEvent):this.table.outcome.length>0&&this.sound.eventToSounds(this.table.outcome.shift())}processEvents(){this.keyboard&&this.keyboard.getEvents().forEach((e=>this.inputQueue.push(e)));for(;this.inputQueue.length>0;){const e=this.inputQueue.shift();e&&this.updateController(this.controller.handleInput(e))}const e=this.eventQueue.shift();e&&this.updateController(e.applyToController(this.controller))}animate(e){this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),this.view.render(),requestAnimationFrame((e=>{this.animate(e)}))}updateController(e){e!==this.controller&&this.log("Transition to "+e.constructor.name),this.controller=e}}},"./src/controller/controller.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Controller=t.StationaryEvent=t.AbortEvent=t.Input=t.HitEvent=t.AimEvent=t.BeginEvent=void 0;const n=s("./src/events/beginevent.ts");Object.defineProperty(t,"BeginEvent",{enumerable:!0,get:function(){return n.BeginEvent}});const i=s("./src/events/aimevent.ts");Object.defineProperty(t,"AimEvent",{enumerable:!0,get:function(){return i.AimEvent}});const r=s("./src/events/hitevent.ts");Object.defineProperty(t,"HitEvent",{enumerable:!0,get:function(){return r.HitEvent}});const o=s("./src/events/input.ts");Object.defineProperty(t,"Input",{enumerable:!0,get:function(){return o.Input}});const a=s("./src/events/abortevent.ts");Object.defineProperty(t,"AbortEvent",{enumerable:!0,get:function(){return a.AbortEvent}});const l=s("./src/events/stationaryevent.ts");Object.defineProperty(t,"StationaryEvent",{enumerable:!0,get:function(){return l.StationaryEvent}});t.Controller=class{container;constructor(e){this.container=e}handleInput(e){return this}handleBegin(e){return this}handleBreak(e){return this}handleAim(e){return this}handleHit(e){return this}handleAbort(e){return this}handleWatch(e){return this}handleStationary(e){return this}}},"./src/controller/controllerbase.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ControllerBase=void 0;const n=s("./src/controller/controller.ts"),i=s("./src/controller/end.ts"),r=s("./src/utils/gltf.ts");class o extends n.Controller{scale=.001;constructor(e){super(e)}handleAbort(e){return new i.End(this.container)}commonKeyHandler(e){switch(e.key){case"ArrowLeft":return this.container.table.cue.rotateAim(-e.t*this.scale),!0;case"ArrowRight":return this.container.table.cue.rotateAim(e.t*this.scale),!0;case"ArrowDown":return this.container.table.cue.adjustHeight(-e.t*this.scale),!0;case"ArrowUp":return this.container.table.cue.adjustHeight(e.t*this.scale),!0;case"ShiftArrowLeft":return this.container.table.cue.adjustSide(e.t*this.scale),!0;case"ShiftArrowRight":return this.container.table.cue.adjustSide(-e.t*this.scale),!0;case"KeyPUp":return r.exportGltf(this.container.view.scene),!0;case"KeyHUp":return this.container.table.cue.helperMesh.visible=!this.container.table.cue.helperMesh.visible,!0;case"movementXUp":return this.container.table.cue.rotateAim(e.t*this.scale*2),!0;case"movementYUp":return this.container.view.camera.adjustHeight(-e.t*this.scale*10),!0;case"NumpadAdd":return this.container.view.camera.adjustHeight(e.t*this.scale*10),!0;case"NumpadSubtract":return this.container.view.camera.adjustHeight(-e.t*this.scale*10),!0;case"KeyOUp":return this.container.view.camera.toggleMode(),!0;default:return!1}return!1}}t.ControllerBase=o},"./src/controller/end.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.End=void 0;const n=s("./src/controller/controller.ts");class i extends n.Controller{}t.End=i},"./src/controller/init.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Init=void 0;const n=s("./src/events/watchevent.ts"),i=s("./src/controller/aim.ts"),r=s("./src/controller/watchaim.ts"),o=s("./src/controller/controllerbase.ts"),a=s("./src/controller/placeball.ts"),l=s("./src/controller/replay.ts");class c extends o.ControllerBase{handleBegin(e){return this.container.sendEvent(new n.WatchEvent(this.container.table.serialise())),new i.Aim(this.container)}handleWatch(e){return this.container.table.updateFromSerialised(e.json),new r.WatchAim(this.container)}handleBreak(e){return e.init?(console.log("ReplayMode"),this.container.table.updateFromShortSerialised(e.init),new l.Replay(this.container,e.shots)):new a.PlaceBall(this.container)}}t.Init=c},"./src/controller/placeball.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceBall=void 0;const n=s("./src/controller/controllerbase.ts"),i=s("./src/controller/aim.ts"),r=s("./node_modules/three/build/three.module.js"),o=s("./src/view/tablegeometry.ts"),a=s("./src/events/breakevent.ts"),l=s("./src/utils/utils.ts");class c extends n.ControllerBase{placescale=.01;constructor(e){super(e),this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.table.cue.aim.power=0,this.container.view.camera.forceMode(this.container.view.camera.aimView),this.container.table.cue.mesh.visible=!1}handleInput(e){switch(e.key){case"ArrowLeft":this.container.table.balls[0].pos.y=r.MathUtils.clamp(l.round(this.container.table.balls[0].pos.y+e.t*this.placescale),-o.TableGeometry.tableY,o.TableGeometry.tableY);break;case"ArrowRight":this.container.table.balls[0].pos.y=r.MathUtils.clamp(l.round(this.container.table.balls[0].pos.y-e.t*this.placescale),-o.TableGeometry.tableY,o.TableGeometry.tableY);break;case"movementXUp":this.container.table.balls[0].pos.y=r.MathUtils.clamp(l.round(this.container.table.balls[0].pos.y-e.t*this.placescale*2),-o.TableGeometry.tableY,o.TableGeometry.tableY);break;case"SpaceUp":return this.placed();default:this.commonKeyHandler(e)}return this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.view.camera.forceMove(this.container.table.cue.aim),this}placed(){return this.container.table.cue.mesh.visible=!0,this.container.table.cue.aim.round(),this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.sendEvent(new a.BreakEvent(this.container.table.shortSerialise())),new i.Aim(this.container)}}t.PlaceBall=c},"./src/controller/playshot.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayShot=void 0;const n=s("./src/events/watchevent.ts"),i=s("./src/controller/aim.ts"),r=s("./src/controller/controllerbase.ts");class o extends r.ControllerBase{allStationary=!1;pendingState;constructor(e){super(e),this.container.table.outcome=[{type:"hit",incidentSpeed:this.container.table.cue.aim.power}],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.afterHitView)}handleStationary(e){return this.allStationary=!0,this.container.log("stationary event"),this.container.table.outcome.some((e=>"pot"==e.type))?(this.container.log("pot! transition to Aim"),this.container.sendEvent(new n.WatchEvent(this.container.table.serialise())),new i.Aim(this.container)):(this.container.log("no pot"),this.container.sendEvent(new n.WatchEvent(this.container.table.serialise())),new i.Aim(this.container))}handleInput(e){return this.commonKeyHandler(e),this}}t.PlayShot=o},"./src/controller/replay.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Replay=void 0;const n=s("./src/events/hitevent.ts"),i=s("./src/controller/controllerbase.ts"),r=s("./src/events/aimevent.ts");class o extends i.ControllerBase{delay=1500;shots;constructor(e,t){return super(e),this.shots=t,this.playNextShot(),this}playNextShot(){var e=r.AimEvent.fromJson(this.shots.shift());this.container.table.cue.aim=e,this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.view.camera.suggestMode(this.container.view.camera.aimView),setTimeout((()=>{this.container.eventQueue.push(new n.HitEvent({}))}),this.delay)}handleHit(e){return this.container.table.outcome=[],this.container.table.hit(),this.container.view.camera.suggestMode(this.container.view.camera.afterHitView),this}handleStationary(e){return console.log("stationary event"),this.container.table.outcome.some((e=>"pot"==e.type))&&console.log(this.container.table.outcome.filter((e=>"pot"==e.type))),this.shots.length>0&&setTimeout((()=>{this.playNextShot()}),this.delay),this}handleInput(e){switch(e.key){case"KeyOUp":this.container.view.camera.toggleMode()}return this}}t.Replay=o},"./src/controller/watchaim.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchAim=void 0;const n=s("./src/controller/watchshot.ts"),i=s("./src/controller/controllerbase.ts");class r extends i.ControllerBase{constructor(e){super(e),this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.view.camera.suggestMode(this.container.view.camera.topView)}handleAim(e){return this.container.table.cue.aim=e,this}handleHit(e){return this.container.table.updateFromSerialised(e.json),new n.WatchShot(this.container)}}t.WatchAim=r},"./src/controller/watchshot.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchShot=void 0;const n=s("./src/controller/aim.ts"),i=s("./src/controller/watchaim.ts"),r=s("./src/controller/controllerbase.ts");class o extends r.ControllerBase{allStationary=!1;pendingState;constructor(e){super(e),this.container.table.outcome=[],this.container.table.hit()}handleAim(e){return this.allStationary?(this.container.log("all stationary so transition to Aim now"),new n.Aim(this.container)):(this.container.log("pending transition to Aim"),this.pendingState=new n.Aim(this.container),this)}handleWatch(e){return this.allStationary?(this.container.log("all stationary so transition to WatchAim now"),new i.WatchAim(this.container)):(this.container.log("pending transition to WatchAim"),this.pendingState=new i.WatchAim(this.container),this)}handleStationary(e){return this.allStationary=!0,this.container.log("stationary event"),this.pendingState?(this.container.log("go to pending state now"),this.pendingState):(this.container.log("no pending state"),this)}}t.WatchShot=o},"./src/events/abortevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbortEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts");class r extends n.GameEvent{constructor(){super(),this.type=i.EventType.ABORT}applyToController(e){return e.handleAbort(this)}}t.AbortEvent=r},"./src/events/aimevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AimEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts"),r=s("./src/utils/utils.ts"),o=s("./node_modules/three/build/three.module.js");class a extends n.GameEvent{verticalOffset=0;sideOffset=0;angle=0;power=0;pos=new o.Vector3(1,0,0);spinOnly=!1;constructor(){super(),this.type=i.EventType.AIM}applyToController(e){return e.handleAim(this)}static fromJson(e){let t=new a;return t.pos=r.vec(e.pos),t.angle=e.angle,t.verticalOffset=e.verticalOffset,t.sideOffset=e.sideOffset,t.power=e.power,t.spinOnly=e.spinOnly,t}copy(){return a.fromJson(this)}round(){this.angle=r.round(this.angle),this.power=r.round(this.power),this.verticalOffset=r.round(this.verticalOffset),this.sideOffset=r.round(this.sideOffset),r.roundVec(this.pos)}}t.AimEvent=a},"./src/events/beginevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeginEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts");class r extends n.GameEvent{constructor(){super(),this.type=i.EventType.BEGIN}applyToController(e){return e.handleBegin(this)}}t.BeginEvent=r},"./src/events/breakevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BreakEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts");class r extends n.GameEvent{init;shots;constructor(e,t){super(),this.init=e,this.shots=t,this.type=i.EventType.BREAK}applyToController(e){return e.handleBreak(this)}static fromJson(e){return new r(e.init,e.shots)}}t.BreakEvent=r},"./src/events/eventtype.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventType=void 0,function(e){e[e.BEGIN=0]="BEGIN",e[e.BREAK=1]="BREAK",e[e.WATCHAIM=2]="WATCHAIM",e[e.AIM=3]="AIM",e[e.HIT=4]="HIT",e[e.STATIONARY=5]="STATIONARY",e[e.CHAT=6]="CHAT",e[e.ABORT=7]="ABORT",e[e.REPOSITION=8]="REPOSITION"}(t.EventType||(t.EventType={}))},"./src/events/eventutil.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventUtil=void 0;const n=s("./src/events/eventtype.ts"),i=s("./src/events/aimevent.ts"),r=s("./src/events/watchevent.ts"),o=s("./src/events/hitevent.ts"),a=s("./src/events/abortevent.ts"),l=s("./src/events/breakevent.ts");t.EventUtil=class{static serialise(e){return JSON.stringify(e)}static fromSerialised(e){let t=JSON.parse(e);switch(t.type){case n.EventType.AIM:return i.AimEvent.fromJson(t);case n.EventType.BREAK:return l.BreakEvent.fromJson(t);case n.EventType.WATCHAIM:return r.WatchEvent.fromJson(t.json);case n.EventType.HIT:return o.HitEvent.fromJson(t.json);case n.EventType.ABORT:return new a.AbortEvent;default:throw Error("Unknown GameEvent :"+e)}}}},"./src/events/gameevent.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameEvent=void 0;t.GameEvent=class{type}},"./src/events/hitevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HitEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts");class r extends n.GameEvent{json;constructor(e){super(),this.type=i.EventType.HIT,this.json=e}applyToController(e){return e.handleHit(this)}static fromJson(e){return new r(e)}}t.HitEvent=r},"./src/events/input.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Input=void 0;t.Input=class{t;key;constructor(e,t){this.t=e,this.key=t}}},"./src/events/keyboard.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Keyboard=void 0;const n=s("./src/events/input.ts");t.Keyboard=class{pressed={};released={};getEvents(){let e=Object.keys(this.pressed).filter((e=>!/.*Shift.*/.test(e))).filter((e=>!/.*Control.*/.test(e))),t=Object.keys(this.pressed).some((e=>/.*Shift.*/.test(e))),s=Object.keys(this.pressed).some((e=>/.*Control.*/.test(e))),i=[];return e.forEach((e=>{let r=performance.now()-this.pressed[e];i.push(new n.Input(s?r/3:r,t?"Shift"+e:e)),"Space"!=e&&(this.pressed[e]=performance.now())})),Object.keys(this.released).forEach((e=>i.push(new n.Input(this.released[e],e+"Up")))),this.released={},i}constructor(e){this.addHandlers(e)}keydown=e=>{e=e||window.event,null==this.pressed[e.code]&&(this.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()};keyup=e=>{e=e||window.event,this.released[e.code]=performance.now()-this.pressed[e.code],delete this.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()};mousemove=e=>{1===e.buttons&&(this.released.movementY?this.released.movementX+=e.movementX:this.released.movementX=e.movementX)};addHandlers(e){document.addEventListener("keydown",this.keydown),document.addEventListener("keyup",this.keyup),e.addEventListener("pointermove",this.mousemove)}}},"./src/events/stationaryevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StationaryEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts");class r extends n.GameEvent{constructor(){super(),this.type=i.EventType.STATIONARY}applyToController(e){return e.handleStationary(this)}}t.StationaryEvent=r},"./src/events/watchevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchEvent=void 0;const n=s("./src/events/gameevent.ts"),i=s("./src/events/eventtype.ts");class r extends n.GameEvent{json;constructor(e){super(),this.type=i.EventType.WATCHAIM,this.json=e}applyToController(e){return e.handleWatch(this)}static fromJson(e){return new r(e)}}t.WatchEvent=r},"./src/index.ts":(e,t,s)=>{"use strict";const n=s("./src/controller/container.ts"),i=s("./src/events/keyboard.ts"),r=s("./src/events/eventutil.ts"),o=s("./src/events/eventtype.ts"),a=s("./src/events/breakevent.ts");var l,c={init:null,shots:Array()};function u(){console.log("Assets loaded");const e=/state=(.*)/.exec(location.search);null!==e?(c=JSON.parse(decodeURI(e[1])),l.eventQueue.push(new a.BreakEvent(c.init,c.shots))):l.eventQueue.push(new a.BreakEvent),l.broadcast=e=>{let t=r.EventUtil.fromSerialised(e);if(t.type===o.EventType.BREAK&&(c.init=t.init),t.type===o.EventType.HIT){c.shots.push(t.json),console.log("break of "+c.shots.length);let e=encodeURI(`${window.location}?&state=${JSON.stringify(c)}`);console.log(e)}},l.animate(performance.now())}l=new n.Container(document.getElementById("viewP1"),(e=>{}),new i.Keyboard(document.getElementById("viewP1")),u)},"./src/model/ball.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ball=t.State=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/utils/utils.ts"),r=s("./src/model/physics/physics.ts"),o=s("./src/view/ballmesh.ts"),a=s("./src/model/physics/constants.ts");var l;!function(e){e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket"}(l=t.State||(t.State={}));class c{pos;vel=i.zero.clone();rvel=i.zero.clone();state=l.Stationary;pocket;futurePos=i.zero.clone();ballmesh;transition=.05;constructor(e,t){this.pos=e.clone(),this.ballmesh=new o.BallMesh(t||5592405*Math.random())}update(e){this.updatePosition(e),this.updateVelocity(e),this.state==l.Falling&&this.updateFalling(e)}updateMesh(e){this.ballmesh.updatePosition(this.pos),0!=this.rvel.lengthSq()&&this.ballmesh.updateRotation(this.rvel,e)}updatePosition(e){this.pos.addScaledVector(this.vel,e)}updateFalling(e){if(this.vel.addScaledVector(i.up,-10*e*a.g),this.pos.z<-2&&(this.pos.z+=n.MathUtils.randFloat(-.5,.25),this.setStationary(),this.state=l.InPocket),this.pos.distanceTo(this.pocket.pos)>this.pocket.radius-.5){const e=this.pocket.pos.clone().sub(this.pos).normalize().multiplyScalar(.5*this.vel.length());this.vel.dot(e)<0&&(this.vel.x=e.x,this.vel.y=e.y)}}updateVelocity(e){this.inMotion()&&(this.isRolling()?this.updateVelocityRolling(e):this.updateVelocitySliding(e))}dv=new n.Vector3;dw=new n.Vector3;updateVelocityRolling(e){r.rollingFull(this.rvel,this.dv,this.dw),this.dv.multiplyScalar(e),this.dw.multiplyScalar(e),i.passesThroughZero(this.rvel,this.dw)||i.passesThroughZero(this.vel,this.dv)?this.setStationary():(this.vel.add(this.dv),this.rvel.add(this.dw),this.state=l.Rolling)}updateVelocitySliding(e){r.sliding(this.vel,this.rvel,this.dv,this.dw),this.dv.multiplyScalar(e),this.dw.multiplyScalar(e),i.passesThroughZero(this.rvel,this.dw)&&i.passesThroughZero(this.vel,this.dv)?this.setStationary():(this.vel.add(this.dv),this.rvel.add(this.dw),this.state=l.Sliding)}setStationary(){this.vel.copy(i.zero),this.rvel.copy(i.zero),this.state=l.Stationary}isRolling(){return 0!=this.vel.lengthSq()&&0!=this.rvel.lengthSq()&&r.surfaceVelocityFull(this.vel,this.rvel).length()<this.transition}onTable(){return this.state!==l.Falling&&this.state!==l.InPocket}inMotion(){return this.state==l.Rolling||this.state==l.Sliding}isFalling(){return this.state==l.Falling}futurePosition(e){return this.futurePos.copy(this.pos).addScaledVector(this.vel,e),this.futurePos}serialise(){return{pos:this.pos,vel:this.vel,rvel:this.rvel,state:this.state}}static fromSerialised(e){return c.updateFromSerialised(new c(i.vec(e.pos)),e)}static updateFromSerialised(e,t){return e.pos.copy(t.pos),e.vel.copy(i.vec(t.vel)),e.rvel.copy(i.vec(t.rvel)),e.state=t.state,e}}t.Ball=c},"./src/model/physics/collision.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Collision=void 0;const n=s("./src/model/ball.ts");class i{static willCollide(e,t,s){return e.onTable()&&t.onTable()&&e.futurePosition(s).distanceToSquared(t.futurePosition(s))<1}static collide(e,t){return i.updateVelocities(e,t)}static updateVelocities(e,t){const s=t.pos.clone().sub(e.pos).normalize(),i=s.dot(e.vel),r=s.dot(t.vel);return e.vel.addScaledVector(s,r).addScaledVector(s,-i),t.vel.addScaledVector(s,i).addScaledVector(s,-r),e.state=n.State.Sliding,t.state=n.State.Sliding,Math.abs(i)+Math.abs(r)}}t.Collision=i},"./src/model/physics/constants.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.I=t.R=t.e=t.Mxy=t.Mz=t.m=t.rho=t.g=t.mu=void 0,t.mu=.8,t.g=9.8,t.rho=.1,t.m=1,t.Mz=t.mu*t.m*t.g*2/3*t.rho,t.Mxy=7/(5*Math.sqrt(2))*t.mu*t.m*t.g*.25,t.e=.85,t.R=.5,t.I=.4*t.m*t.R*t.R},"./src/model/physics/cushion.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cushion=void 0;const n=s("./src/view/tablegeometry.ts"),i=s("./src/model/physics/physics.ts"),r=s("./node_modules/three/build/three.module.js");class o{static willBounce(e,t){let s=e.futurePosition(t);return!(Math.abs(s.y)<n.TableGeometry.tableY&&Math.abs(s.x)<n.TableGeometry.tableX)&&(e.onTable()&&(o.willBounceLongSegment(n.TableGeometry.pockets.pocketNW.knuckleNE.pos.x,n.TableGeometry.pockets.pocketN.knuckleNW.pos.x,s)||o.willBounceLongSegment(n.TableGeometry.pockets.pocketN.knuckleNE.pos.x,n.TableGeometry.pockets.pocketNE.knuckleNW.pos.x,s)||o.willBounceShortSegment(n.TableGeometry.pockets.pocketNW.knuckleSW.pos.y,n.TableGeometry.pockets.pocketSW.knuckleNW.pos.y,s)))}static willBounceLongSegment(e,t,s){return s.x>e&&s.x<t&&Math.abs(s.y)>n.TableGeometry.tableY}static willBounceShortSegment(e,t,s){return s.y>t&&s.y<e&&Math.abs(s.x)>n.TableGeometry.tableX}static bounce(e,t){const s=e.futurePosition(t);return s.x>n.TableGeometry.tableX?o.bounceIn(0,e):s.x<-n.TableGeometry.tableX?o.bounceIn(Math.PI,e):s.y>n.TableGeometry.tableY?o.bounceIn(-Math.PI/2,e):s.y<-n.TableGeometry.tableY?o.bounceIn(Math.PI/2,e):void 0}static bounceIn(e,t){let s=new r.Vector3,n=new r.Vector3;return i.rotateApplyUnrotate(e,t.vel,t.rvel,s,n),t.vel.add(s),t.rvel.add(n),s.length()}}t.Cushion=o},"./src/model/physics/knuckle.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Knuckle=void 0;const n=s("./src/view/tablegeometry.ts"),i=s("./src/model/physics/constants.ts");class r{pos;radius;constructor(e,t){this.pos=e,this.radius=t}static willBounce(e,t){return t.distanceTo(e.pos)<.5+e.radius}bounce(e){const t=e.pos.clone().sub(this.pos).normalize();let s=t.dot(e.vel);return e.vel.addScaledVector(t,-2*i.e*s),Math.abs(s)}static willBounceAny(e,t){const s=e.futurePosition(t);return e.onTable()&&n.TableGeometry.knuckles.find((e=>r.willBounce(e,s)))}}t.Knuckle=r},"./src/model/physics/physics.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bounceWithSlipX=t.bounceWithoutSlipX=t.gripInXCushion=t.bounceWithSideX=t.isCushionXGrip=t.rotateApplyUnrotate=t.forceRoll=t.rollingFull=t.slidingFull=t.sliding=t.surfaceVelocityFull=t.surfaceVelocity=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/utils/utils.ts"),r=s("./src/model/physics/constants.ts");function o(e,t){return a(e,t).setZ(0)}function a(e,t){return e.clone().add(i.upCross(t))}t.surfaceVelocity=o,t.surfaceVelocityFull=a,t.sliding=function(e,t,s,n){const a=o(e,t);s.copy(i.norm(a).multiplyScalar(-r.mu*r.g)),n.copy(i.norm(i.upCross(a)).multiplyScalar(2.5*r.mu*r.g)),n.setZ(-2.5*r.Mz*Math.sign(t.z))},t.slidingFull=function(e,t,s,i){const o=new n.Vector3(e.x-t.y,e.y+t.x,0).normalize();s.set(-r.mu*r.g*o.x,-r.mu*r.g*o.y,0),i.set(-2.5*r.mu*r.g*o.y,2.5*r.mu*r.g*o.x,-2.5*r.Mz*Math.sign(t.z))},t.rollingFull=function(e,t,s){const i=new n.Vector3(e.x,e.y,0).length(),o=5/7*r.Mxy/i;t.set(-o*e.y,o*e.x,0),s.set(-o*e.x,-o*e.y,-2.5*r.Mz*Math.sign(e.z))},t.forceRoll=function(e,t){e.sub(o(e,t).multiplyScalar(.5)),t.copy(i.upCross(e))};const l=Math.sin(9.25/32.5),c=Math.cos(9.25/32.5),u=l*l,h=c*c;t.rotateApplyUnrotate=function(e,t,s,n,r){m(t.clone().applyAxisAngle(i.up,e),s.clone().applyAxisAngle(i.up,e),n,r),n.applyAxisAngle(i.up,-e),r.applyAxisAngle(i.up,-e)};const d=7/(2*r.m),p=1/r.m;function m(e,t,s,n){var i=-e.x*r.e,o=e.y+r.R*(-t.z*c*Math.abs(e.x)/30),a=.9*t.x,l=t.z/2;s.set(i-e.x,o-e.y,0),n.set(a-t.x,0-t.y,l-t.z)}t.isCushionXGrip=function(e,t){var s,i=(s=function(e){return-e.y}(e),(1+r.e)*s/p),o=function(e,t){return new n.Vector3(e.x*l-e.z*c+r.R*t.y,-e.y-r.R*t.z*c+r.R*t.x*l)}(e,t).length()/d;return console.log(i+" < "+o+" isGrip = "+(i<o?"true":"false")),i<o},t.bounceWithSideX=m,t.gripInXCushion=function(e,t){var s=Math.abs(e.y+t.z*r.R);console.log(s,s>20?"slip":"grip")},t.bounceWithoutSlipX=function(e,t,s,n){var i=e.x-e.x*(2/7*u+(1+r.e)*h)-2/7*r.R*t.y*l,o=5/7*e.y+2/7*r.R*(t.x*l-t.z*c),a=r.m*(o-e.y),d=r.m*(i-e.x),p=-r.m,m=t.x-r.R/r.I*a*l,f=t.y+r.R/r.I*(d*l-p*c),g=t.z+r.R/r.I*a*c;s.set(i-e.x,o-e.y,0),n.set(m-t.x,f-t.y,g-t.z)},t.bounceWithSlipX=function(e,t,s,n){var i=e.x-e.x*(1+r.e)*c*(r.mu*c*l+c),o=e.y+r.mu*(1+r.e)*c*l*e.x,a=r.m*(o-e.y),u=r.m*(i-e.x),h=-r.m,d=t.x-r.R/r.I*a*l,p=t.y+r.R/r.I*(u*l-h*c),m=t.z+r.R/r.I*a*c;s.set(i-e.x,o-e.y,0),n.set(d-t.x,p-t.y,m-t.z)}},"./src/model/physics/pocket.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pocket=void 0;const n=s("./src/model/ball.ts"),i=s("./src/view/tablegeometry.ts"),r=s("./src/model/physics/constants.ts");class o{pos;radius;constructor(e,t){this.pos=e,this.radius=t}static willFall(e,t){return t.distanceTo(e.pos)<e.radius}fall(e,t){return e.vel.z=-r.g*t,e.state=n.State.Falling,e.pocket=this,e.vel.length()}static willFallAny(e,t){const s=e.futurePosition(t);return e.onTable()&&i.TableGeometry.pocketCenters.find((e=>o.willFall(e,s)))}}t.Pocket=o},"./src/model/table.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Table=void 0;const n=s("./src/model/physics/cushion.ts"),i=s("./src/model/physics/collision.ts"),r=s("./src/model/physics/knuckle.ts"),o=s("./src/model/physics/pocket.ts"),a=s("./src/view/cue.ts"),l=s("./src/model/ball.ts"),c=s("./src/events/aimevent.ts"),u=s("./src/utils/utils.ts"),h=s("./src/view/tablegeometry.ts");class d{balls;cue=new a.Cue;pairs;outcome=[];constructor(e){this.initialiseBalls(e)}initialiseBalls(e){this.balls=e,this.pairs=[],this.balls.forEach((e=>{this.balls.forEach((t=>{e!==t&&this.pairs.push({a:e,b:t})}))}))}advance(e){let t=0;for(;!this.prepareAdvanceAll(e);)if(t++>100)throw new Error("Depth exceeded resolving collisions");this.balls.forEach((t=>{t.update(e)}))}updateBallMesh(e){this.balls.forEach((t=>{t.updateMesh(e)}))}prepareAdvanceAll(e){return this.pairs.length>0?!this.pairs.some((t=>!this.prepareAdvancePair(t.a,t.b,e))):!this.balls.some((t=>!this.prepareAdvanceToCushions(t,e)))}prepareAdvancePair(e,t,s){if(!e.inMotion()&&!t.inMotion())return!0;if(i.Collision.willCollide(e,t,s)){var n=i.Collision.collide(e,t);return this.outcome.push({type:"collision",a:e,b:t,incidentSpeed:n}),!1}return this.prepareAdvanceToCushions(e,s)}prepareAdvanceToCushions(e,t){let s=e.futurePosition(t);if(Math.abs(s.y)<h.TableGeometry.tableY&&Math.abs(s.x)<h.TableGeometry.tableX)return!0;if(n.Cushion.willBounce(e,t)){var i=n.Cushion.bounce(e,t);return this.outcome.push({type:"cushion",a:e,incidentSpeed:i}),!1}let a=r.Knuckle.willBounceAny(e,t);if(a){var l=a.bounce(e);return this.outcome.push({type:"cushion",a:e,incidentSpeed:l}),!1}let c=o.Pocket.willFallAny(e,t);if(c){var u=c.fall(e,t);return this.outcome.push({type:"pot",a:e,incidentSpeed:u}),!1}return!0}allStationary(){return this.balls.every((e=>!e.inMotion()||!e.onTable()))}hit(){let e=this.cue.aim;this.balls[0].vel.copy(u.unitAtAngle(e.angle).multiplyScalar(e.power)),e.spinOnly&&this.balls[0].vel.copy(u.zero),this.balls[0].state=l.State.Sliding;let t=Math.atan2(-e.sideOffset,e.verticalOffset);if(0==t)this.balls[0].rvel.copy(u.zero);else{let s=Math.sqrt(e.verticalOffset*e.verticalOffset+e.sideOffset*e.sideOffset),n=u.unitAtAngle(e.angle),i=u.upCross(n).applyAxisAngle(n,t).multiplyScalar(s*e.power*2);this.balls[0].rvel.copy(i)}e.power=0}serialise(){return{balls:this.balls.map((e=>e.serialise())),aim:this.cue.aim.copy()}}static fromSerialised(e){let t=new d(e.balls.map((e=>l.Ball.fromSerialised(e))));return t.updateFromSerialised(e),t}updateFromSerialised(e){this.balls.forEach(((t,s)=>l.Ball.updateFromSerialised(t,e.balls[s]))),e.aim&&(this.cue.aim=c.AimEvent.fromJson(e.aim))}shortSerialise(){return this.balls.map((e=>[e.pos.x,e.pos.y])).reduce(((e,t)=>e.concat(t)),[])}updateFromShortSerialised(e){this.balls.forEach(((t,s)=>{t.pos.x=e[2*s],t.pos.y=e[2*s+1]}))}}t.Table=d},"./src/utils/gltf.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.downloadObjectAsJson=t.importGltf=t.exportGltf=void 0;const n=s("./node_modules/three/examples/jsm/exporters/GLTFExporter.js"),i=s("./node_modules/three/examples/jsm/loaders/GLTFLoader.js");function r(e,t){var s=document.createElement("a");s.setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))),s.setAttribute("download",t),document.body.appendChild(s),s.click(),s.remove()}t.exportGltf=function(e){(new n.GLTFExporter).parse(e,(e=>{console.log(e),r(e,"scene.gltf")}))},t.importGltf=function(e,t,s){(new i.GLTFLoader).load(e,(e=>{t.add(e.scene),null!==s&&s()}),(e=>console.log(e.loaded+" bytes loaded")),(e=>console.log(e)))},t.downloadObjectAsJson=r},"./src/utils/rack.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rack=void 0;const n=s("./src/model/ball.ts"),i=s("./src/view/tablegeometry.ts"),r=s("./node_modules/three/build/three.module.js"),o=s("./src/utils/utils.ts");class a{static noise=.05;static gap=1+2*a.noise;static up=new r.Vector3(0,0,-1);static jitter(e){return o.roundVec(e.clone().add(new r.Vector3(a.noise*(Math.random()-.5),a.noise*(Math.random()-.5),0)))}static cueBall(){return new n.Ball(new r.Vector3(-11,0,0),16444375)}static diamond(){let e=new r.Vector3(0,a.gap,0),t=e.clone().applyAxisAngle(a.up,1*Math.PI/3),s=new r.Vector3(i.TableGeometry.tableX/2,0,0),o=[];return o.push(a.cueBall()),o.push(new n.Ball(a.jitter(s),14736950)),s.add(t),o.push(new n.Ball(a.jitter(s),16751872)),s.sub(e),o.push(new n.Ball(a.jitter(s),5380369)),s.add(t),o.push(new n.Ball(a.jitter(s),5853696)),s.sub(e),o.push(new n.Ball(a.jitter(s),16711680)),s.addScaledVector(e,2),o.push(new n.Ball(a.jitter(s),328965)),s.add(t).sub(e),o.push(new n.Ball(a.jitter(s),685250)),s.sub(e),o.push(new n.Ball(a.jitter(s),553728)),s.add(t),o.push(new n.Ball(a.jitter(s),4063388)),o}}t.Rack=a},"./src/utils/utils.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.assertNotNaNVec=t.roundVec=t.round=t.unitAtAngle=t.passesThroughZero=t.norm=t.upCross=t.vec=t.up=t.zero=void 0;const n=s("./node_modules/three/build/three.module.js");function i(e){return Math.round(1e3*(e+Number.EPSILON))/1e3}t.zero=new n.Vector3(0,0,0),t.up=new n.Vector3(0,0,1),t.vec=function(e){return new n.Vector3(e.x,e.y,e.z)},t.upCross=function(e){return t.up.clone().cross(e)},t.norm=function(e){return e.clone().normalize()},t.passesThroughZero=function(e,t){return e.clone().add(t).dot(e)<=0},t.unitAtAngle=function(e){return new n.Vector3(1,0,0).applyAxisAngle(t.up,e)},t.round=i,t.roundVec=function(e){return e.x=i(e.x),e.y=i(e.y),e.z=i(e.z),e},t.assertNotNaNVec=function(e,t){if(isNaN(e.x)||isNaN(e.y)||isNaN(e.z))throw t?console.log(t):console.log(e),new Error("Error vector contains NaN")}},"./src/view/aiminputs.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AimInputs=void 0;const n=s("./src/events/input.ts");t.AimInputs=class{cueBallElement;cueTipElement;cuePowerElement;cueHitElement;container;constructor(e){this.container=e,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cueBallElement?.addEventListener("pointermove",this.mousemove),this.cueBallElement?.addEventListener("click",this.click),this.cuePowerElement=document.getElementById("cuePower"),document.addEventListener("wheel",this.mousewheel),this.cueHitElement=document.getElementById("cueHit"),this.cueHitElement?.addEventListener("click",this.hit),document.addEventListener("dblclick",this.hit)}click=e=>{this.adjustSpin(e)};mousemove=e=>{1===e.buttons&&this.adjustSpin(e)};adjustSpin(e){const t=this.cueBallElement.offsetWidth,s=this.cueTipElement.offsetWidth/2;let n=this.container.table.cue.setSpin(-(e.offsetX-t/2)/t,-(e.offsetY-t/2)/t);this.cueTipElement.style.left=(.5-n.x)*t-s+"px",this.cueTipElement.style.top=(.5-n.y)*t-s+"px"}hit=e=>{this.container.table.cue.setPower(this.cuePowerElement.value/100),this.container.inputQueue.push(new n.Input(0,"SpaceUp"))};mousewheel=e=>{this.cuePowerElement.value-=10*Math.sign(e.deltaY)}}},"./src/view/ballmesh.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BallMesh=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/model/ball.ts"),r=s("./src/utils/utils.ts");t.BallMesh=class{mesh;shadow;spinAxisArrow;constructor(e){this.initialiseMesh(e)}updatePosition(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}m=new n.Matrix4;updateRotation(e,t){let s=e.length()*t*Math.PI/2,n=this.m.identity().makeRotationAxis(r.norm(e),s);this.mesh.geometry.applyMatrix4(n)}updateArrows(e,t,s){this.spinAxisArrow.setLength(.4+t.length()/2,.1,.1),this.spinAxisArrow.position.copy(e),this.spinAxisArrow.setDirection(r.norm(t)),s==i.State.Rolling?this.spinAxisArrow.setColor(16711680):this.spinAxisArrow.setColor(65280)}initialiseMesh(e){var t=new n.IcosahedronGeometry(.5,1),s=new n.MeshPhongMaterial({color:e,emissive:0,flatShading:!0});this.mesh=new n.Mesh(t,s),this.mesh.name="ball";const i=new n.CircleGeometry(.45,9);i.applyMatrix4((new n.Matrix4).identity().makeTranslation(0,0,-.49));const o=new n.MeshBasicMaterial({color:1118498});this.shadow=new n.Mesh(i,o),this.spinAxisArrow=new n.ArrowHelper(r.up,r.zero,2,0)}}},"./src/view/camera.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Camera=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/utils/utils.ts");t.Camera=class{constructor(e){this.camera=new n.PerspectiveCamera(35,e,.1,1e3)}camera;mode=this.topView;mainMode=this.aimView;topViewPoint=new n.Vector3(0,-.1,49);height=4;elapsed;update(e,t){this.elapsed=e,this.mode(t)}topView(e){this.camera.position.lerp(this.topViewPoint,.9),this.camera.up=i.up,this.camera.lookAt(i.zero)}aimView(e,t=.08){this.camera.position.lerp(e.pos.clone().addScaledVector(i.unitAtAngle(e.angle),-9),t),this.camera.position.z=this.height,this.camera.up=i.up,this.camera.lookAt(e.pos.clone().addScaledVector(i.up,1)),this.standback=9}standback=9;afterHitView(e){this.camera.position.lerp(e.pos.clone().addScaledVector(i.unitAtAngle(e.angle),-this.standback),.5),this.camera.position.z=this.height+(this.standback-9),this.camera.up=i.up,this.camera.lookAt(e.pos.clone().addScaledVector(i.up,1))}adjustHeight(e){this.height=n.MathUtils.clamp(this.height+e,1,6)}suggestMode(e){this.mainMode===this.aimView&&(this.mode=e)}forceMode(e){this.mode=e,this.mainMode=e}forceMove(e){this.mode===this.aimView&&this.aimView(e,1)}toggleMode(){this.mode===this.topView?this.mode=this.aimView:this.mode=this.topView,this.mainMode=this.mode}}},"./src/view/cue.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cue=void 0;const n=s("./src/view/tablegeometry.ts"),i=s("./src/utils/utils.ts"),r=s("./src/events/aimevent.ts"),o=s("./node_modules/three/build/three.module.js");class a{mesh;helperMesh;limit=.4;maxPower=60;t=0;aim=new r.AimEvent;length=1*n.TableGeometry.tableX;static material=new o.MeshPhongMaterial({color:8934775,wireframe:!1,flatShading:!1});static helpermaterial=new o.MeshPhongMaterial({color:8934775,wireframe:!1,flatShading:!0,transparent:!0,opacity:.3});constructor(){this.initialise(.05,.15,this.length)}createHelper(){var e=new o.CylinderGeometry(.5,.5,30,12);this.helperMesh=new o.Mesh(e,a.helpermaterial),this.helperMesh.geometry.applyMatrix4((new o.Matrix4).identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4((new o.Matrix4).identity().makeTranslation(15,0,0)),this.helperMesh.visible=!1}initialise(e,t,s){var n=new o.CylinderGeometry(e,t,s,11);this.mesh=new o.Mesh(n,a.material),this.mesh.castShadow=!1,this.mesh.geometry.applyMatrix4((new o.Matrix4).identity().makeRotationAxis(new o.Vector3(1,0,0),-.1)).applyMatrix4((new o.Matrix4).identity().makeRotationAxis(i.up,-Math.PI/2)).applyMatrix4((new o.Matrix4).identity().makeTranslation(-s/2-.5,0,1)),this.mesh.rotation.z=this.aim.angle,this.createHelper()}rotateAim(e){this.aim.angle+=e,this.mesh.rotation.z=this.aim.angle,this.helperMesh.rotation.z=this.aim.angle}adjustHeight(e){this.aim.verticalOffset=o.MathUtils.clamp(this.aim.verticalOffset+e,-this.limit,this.limit),this.mesh.position.z=this.aim.verticalOffset}adjustSide(e){this.aim.sideOffset=o.MathUtils.clamp(this.aim.sideOffset+e,-this.limit,this.limit)}adjustPower(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e)}setPower(e){this.aim.power=e*this.maxPower}setSpin(e,t){return this.aim.verticalOffset=o.MathUtils.clamp(t,-this.limit,this.limit),this.aim.sideOffset=o.MathUtils.clamp(e,-this.limit,this.limit),{x:this.aim.sideOffset,y:this.aim.verticalOffset}}moveTo(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle;let t=i.upCross(i.unitAtAngle(this.aim.angle)).multiplyScalar(this.aim.sideOffset).setZ(this.aim.verticalOffset),s=.25*(Math.sin(this.t/3)-1),n=i.unitAtAngle(this.aim.angle).clone().multiplyScalar(s-this.aim.power/this.maxPower*3);this.mesh.position.copy(e.clone().add(t).add(n)),this.helperMesh.position.copy(e)}update(e){this.t+=e,this.moveTo(this.aim.pos)}intersectsAnything(e){let t=e.balls[0].pos.clone().addScaledVector(i.unitAtAngle(this.aim.angle),-this.length/2);t.z=this.aim.verticalOffset;let s=i.unitAtAngle(this.aim.angle);return new o.Raycaster(t,s,0,this.length/2-.6).intersectObjects(e.balls.map((e=>e.ballmesh.mesh))).length>0}}t.Cue=a},"./src/view/grid.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Grid=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/model/physics/constants.ts"),r=s("./src/view/tablegeometry.ts");t.Grid=class{z=-.49;material=new n.LineBasicMaterial({color:132,opacity:.3,transparent:!0});generateLineSegments(){const e=[this.point(0,-11.13),this.point(0,11.13)],t=(r.TableGeometry.tableX+2*i.R)/4,s=r.TableGeometry.tableY+i.R;[1,2,3,-1,-2,-3].forEach((n=>{e.push(this.point(n*t,-s)),e.push(this.point(n*t,s))}));const o=(r.TableGeometry.tableY+2*i.R)/2,a=r.TableGeometry.tableX+i.R;[-1,0,1].forEach((t=>{e.push(this.point(-a,t*o)),e.push(this.point(a,t*o))}));const l=(new n.BufferGeometry).setFromPoints(e);return new n.LineSegments(l,this.material)}point(e,t){return new n.Vector3(e,t,-.485)}}},"./src/view/overheadcamera.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverheadCamera=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/utils/utils.ts");t.OverheadCamera=class{constructor(e){this.camera=new n.PerspectiveCamera(35,e,.1,1e3),this.camera.position.copy(this.topViewPoint),this.camera.up=i.up,this.camera.lookAt(i.zero)}camera;topViewPoint=new n.Vector3(0,-.1,48);aspect(e,t){const s=500,n=Math.min(s,.4*e),i=1/e,r=1/t*.59;return t>1.5*e?{x:i*e,y:r*e}:.4*e>s?{x:i*s,y:r*s}:{x:i*n,y:r*n}}}},"./src/view/sound.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Sound=void 0;const n=s("./node_modules/three/build/three.module.js");t.Sound=class{listener=new n.AudioListener;audioLoader=new n.AudioLoader;ballcollision;cue;cushion;pot;constructor(e){e.add(this.listener),this.ballcollision=new n.Audio(this.listener),this.load("sounds/ballcollision.ogg",this.ballcollision),this.cue=new n.Audio(this.listener),this.load("sounds/cue.ogg",this.cue),this.cushion=new n.Audio(this.listener),this.load("sounds/cushion.ogg",this.cushion),this.pot=new n.Audio(this.listener),this.load("sounds/pot.ogg",this.pot)}load(e,t){this.audioLoader.load(e,(e=>{t.setBuffer(e),t.setLoop(!1)}))}play(e,t){e.setVolume(t),e.isPlaying&&e.stop(),e.play(n.MathUtils.randFloat(0,.01))}eventToSounds(e){"collision"===e.type&&(this.play(this.ballcollision,e.incidentSpeed/60),this.ballcollision.setDetune(10*e.incidentSpeed)),"pot"===e.type&&(this.play(this.pot,e.incidentSpeed/60),this.pot.setDetune(10*e.incidentSpeed-1e3)),"cushion"===e.type&&this.play(this.cushion,e.incidentSpeed/120),"hit"===e.type&&this.play(this.cue,e.incidentSpeed/60)}}},"./src/view/tablegeometry.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TableGeometry=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./node_modules/three/build/three.module.js"),r=s("./src/model/physics/knuckle.ts"),o=s("./src/model/physics/pocket.ts");class a{static tableX=21.5;static tableY=10.5;static X=a.tableX+.5;static Y=a.tableY+.5;static PX=a.tableX+.8;static PY=a.tableY+.8;static knuckleInset=1.6;static knuckleRadius=.31;static middleKnuckleInset=1.385;static middleKnuckleRadius=.2;static cornerRadius=1.1;static middleRadius=.9;static pockets={pocketNW:{pocket:new o.Pocket(new n.Vector3(-a.PX,a.PY,0),a.cornerRadius),knuckleNE:new r.Knuckle(new n.Vector3(-a.X+a.knuckleInset,a.Y+a.knuckleRadius,0),a.knuckleRadius),knuckleSW:new r.Knuckle(new n.Vector3(-a.X-a.knuckleRadius,a.Y-a.knuckleInset,0),a.knuckleRadius)},pocketN:{pocket:new o.Pocket(new n.Vector3(0,a.PY+.7,0),a.middleRadius),knuckleNE:new r.Knuckle(new n.Vector3(a.middleKnuckleInset,a.Y+a.middleKnuckleRadius,0),a.middleKnuckleRadius),knuckleNW:new r.Knuckle(new n.Vector3(-a.middleKnuckleInset,a.Y+a.middleKnuckleRadius,0),a.middleKnuckleRadius)},pocketS:{pocket:new o.Pocket(new n.Vector3(0,-a.PY-.7,0),a.middleRadius),knuckleSE:new r.Knuckle(new n.Vector3(a.middleKnuckleInset,-a.Y-a.middleKnuckleRadius,0),a.middleKnuckleRadius),knuckleSW:new r.Knuckle(new n.Vector3(-a.middleKnuckleInset,-a.Y-a.middleKnuckleRadius,0),a.middleKnuckleRadius)},pocketNE:{pocket:new o.Pocket(new n.Vector3(a.PX,a.PY,0),a.cornerRadius),knuckleNW:new r.Knuckle(new n.Vector3(a.X-a.knuckleInset,a.Y+a.knuckleRadius,0),a.knuckleRadius),knuckleSE:new r.Knuckle(new n.Vector3(a.X+a.knuckleRadius,a.Y-a.knuckleInset,0),a.knuckleRadius)},pocketSE:{pocket:new o.Pocket(new n.Vector3(a.PX,-a.PY,0),a.cornerRadius),knuckleNE:new r.Knuckle(new n.Vector3(a.X+a.knuckleRadius,-a.Y+a.knuckleInset,0),a.knuckleRadius),knuckleSW:new r.Knuckle(new n.Vector3(a.X-a.knuckleInset,-a.Y-a.knuckleRadius,0),a.knuckleRadius)},pocketSW:{pocket:new o.Pocket(new n.Vector3(-a.PX,-a.PY,0),a.cornerRadius),knuckleSE:new r.Knuckle(new n.Vector3(-a.X+a.knuckleInset,-a.Y-a.knuckleRadius,0),a.knuckleRadius),knuckleNW:new r.Knuckle(new n.Vector3(-a.X-a.knuckleRadius,-a.Y+a.knuckleInset,0),a.knuckleRadius)}};static knuckles=[a.pockets.pocketNW.knuckleNE,a.pockets.pocketNW.knuckleSW,a.pockets.pocketN.knuckleNW,a.pockets.pocketN.knuckleNE,a.pockets.pocketS.knuckleSW,a.pockets.pocketS.knuckleSE,a.pockets.pocketNE.knuckleNW,a.pockets.pocketNE.knuckleSE,a.pockets.pocketSE.knuckleNE,a.pockets.pocketSE.knuckleSW,a.pockets.pocketSW.knuckleSE,a.pockets.pocketSW.knuckleNW];static pocketCenters=[a.pockets.pocketNW.pocket,a.pockets.pocketSW.pocket,a.pockets.pocketN.pocket,a.pockets.pocketS.pocket,a.pockets.pocketNE.pocket,a.pockets.pocketSE.pocket];static addToScene(e){a.knuckles.forEach((t=>a.knuckleCylinder(t,e))),a.pocketCenters.forEach((t=>a.knuckleCylinder(t,e)))}static material=new i.MeshPhongMaterial({color:4478361,wireframe:!1,flatShading:!0,transparent:!0,opacity:.4});static knuckleCylinder(e,t){a.cylinder(e.pos,e.radius,.75,t).position.setZ(-.125)}static cylinder(e,t,s,r){var o=new i.CylinderGeometry(t,t,s,16),l=new i.Mesh(o,a.material);return l.position.copy(e),l.geometry.applyMatrix4((new n.Matrix4).identity().makeRotationAxis(new n.Vector3(1,0,0),Math.PI/2)),r.add(l),l}static addCushions(e){a.plane(new n.Vector3(0,0,-5.5),2*a.X,2*a.Y,10,e);let t=.75,s=-.125,i=Math.abs(a.pockets.pocketNW.knuckleNE.pos.x-a.pockets.pocketN.knuckleNW.pos.x),r=Math.abs(a.pockets.pocketNW.knuckleSW.pos.y-a.pockets.pocketSW.knuckleNW.pos.y);a.plane(new n.Vector3(a.X+.5,0,s),1,r,t,e),a.plane(new n.Vector3(-a.X-.5,0,s),1,r,t,e),a.plane(new n.Vector3(-a.X/2,a.Y+.5,s),i,1,t,e),a.plane(new n.Vector3(-a.X/2,-a.Y-.5,s),i,1,t,e),a.plane(new n.Vector3(a.X/2,a.Y+.5,s),i,1,t,e),a.plane(new n.Vector3(a.X/2,-a.Y-.5,s),i,1,t,e)}static plane(e,t,s,n,r){var o=new i.BoxGeometry(t,s,n),l=new i.Mesh(o,a.material);l.receiveShadow=!0,l.position.copy(e),r.add(l)}}t.TableGeometry=a},"./src/view/view.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=void 0;const n=s("./node_modules/three/build/three.module.js"),i=s("./src/view/camera.ts"),r=s("./src/view/overheadcamera.ts"),o=s("./src/utils/gltf.ts"),a=s("./src/view/grid.ts");t.View=class{scene=new n.Scene;renderer;camera;overheadCamera;windowWidth=1;windowHeight=1;element;table;constructor(e,t){this.element=e,e&&this.initialiseScene(e,e.offsetWidth,e.offsetHeight),this.camera=new i.Camera(e?e.offsetWidth/e.offsetHeight:1),this.overheadCamera=new r.OverheadCamera(e?e.offsetWidth/e.offsetHeight:1),this.addTable(t)}update(e,t){this.camera.update(e,t)}updateSize(){this.windowWidth==this.element.offsetWidth&&this.windowHeight==this.element.offsetHeight||(this.windowWidth=this.element.offsetWidth,this.windowHeight=this.element.offsetHeight,this.renderer.setSize(this.windowWidth,this.windowHeight))}views=[{left:0,bottom:0,width:1,height:1},{left:.7,bottom:0,width:.3,height:.3}];render(){this.updateSize(),this.isInMotionNotVisible()&&(this.camera.suggestMode(this.camera.topView),this.camera.standback+=1),this.renderCamera(this.camera,this.views[0]);let e=this.overheadCamera.aspect(this.windowWidth,this.windowHeight);this.views[1].width=e.x,this.views[1].height=e.y,this.views[1].left=1-1.01*e.x,this.views[1].bottom=.01*e.y}renderCamera(e,t){this.updateSize();const s=Math.floor(this.windowWidth*t.left),n=Math.floor(this.windowHeight*t.bottom),i=Math.floor(this.windowWidth*t.width),r=Math.floor(this.windowHeight*t.height);this.renderer.setViewport(s,n,i,r),this.renderer.setScissor(s,n,i,r),this.renderer.setScissorTest(!0),e.camera.aspect=i/r,e.camera.updateProjectionMatrix(),this.renderer.render(this.scene,e.camera)}initialiseScene(e,t,s){this.renderer=new n.WebGLRenderer({antialias:!0}),this.renderer.setSize(t,s),this.renderer.shadowMap.enabled=!1,e.appendChild(this.renderer.domElement)}addTable(e){this.scene.add(new n.AmbientLight(3158064,1)),o.importGltf("models/p8.gltf",this.scene,e),this.scene.add((new a.Grid).generateLineSegments())}addMesh(e){this.scene.add(e)}ballToCheck=0;isInMotionNotVisible(){var e=this.viewFrustrum(),t=this.table.balls[this.ballToCheck++%this.table.balls.length];return t.inMotion()&&!e.intersectsObject(t.ballmesh.mesh)}viewFrustrum(){var e=this.camera.camera,t=new n.Frustum;return t.setFromProjectionMatrix((new n.Matrix4).multiplyMatrices(e.projectionMatrix,e.matrixWorldInverse)),t}}}},e=>{"use strict";var t;t="./src/index.ts",e(e.s=t)}]);