(self.webpackChunkbilliards=self.webpackChunkbilliards||[]).push([[826],{"./node_modules/three/examples/jsm/exporters/GLTFExporter.js":(e,t,s)=>{"use strict";s.r(t),s.d(t,{GLTFExporter:()=>n});var r=s("./node_modules/three/build/three.module.js"),n=function(){function e(){this.pluginCallbacks=[],this.register((function(e){return new _(e)})),this.register((function(e){return new I(e)})),this.register((function(e){return new L(e)}))}e.prototype={constructor:e,register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,s){for(var r=new R,n=[],i=0,a=this.pluginCallbacks.length;i<a;i++)n.push(this.pluginCallbacks[i](r));r.setPlugins(n),r.write(e,t,s)}};var t=0,s=1,n=2,i=3,a=4,o=5121,l=5123,c=5126,u=5125,h=34962,p=34963,d=9728,m=9729,f=9984,v=9985,g=9986,y=9987,b=33071,w=33648,T=10497,x={};x[r.NearestFilter]=d,x[r.NearestMipmapNearestFilter]=f,x[r.NearestMipmapLinearFilter]=g,x[r.LinearFilter]=m,x[r.LinearMipmapNearestFilter]=v,x[r.LinearMipmapLinearFilter]=y,x[r.ClampToEdgeWrapping]=b,x[r.RepeatWrapping]=T,x[r.MirroredRepeatWrapping]=w;var M={scale:"scale",position:"translation",quaternion:"rotation",morphTargetInfluences:"weights"};function S(e,t){return e.length===t.length&&e.every((function(e,s){return e===t[s]}))}function E(e){return 4*Math.ceil(e/4)}function k(e,t){t=t||0;var s=E(e.byteLength);if(s!==e.byteLength){var r=new Uint8Array(s);if(r.set(new Uint8Array(e)),0!==t)for(var n=e.byteLength;n<s;n++)r[n]=t;return r.buffer}return e}var A=null;function R(){this.plugins=[],this.options={},this.pending=[],this.buffers=[],this.byteOffset=0,this.buffers=[],this.nodeMap=new Map,this.skins=[],this.extensionsUsed={},this.uids=new Map,this.uid=0,this.json={asset:{version:"2.0",generator:"THREE.GLTFExporter"}},this.cache={meshes:new Map,attributes:new Map,attributesNormalized:new Map,materials:new Map,textures:new Map,images:new Map}}function _(e){this.writer=e,this.name="KHR_lights_punctual"}function I(e){this.writer=e,this.name="KHR_materials_unlit"}function L(e){this.writer=e,this.name="KHR_materials_pbrSpecularGlossiness"}return R.prototype={constructor:R,setPlugins:function(e){this.plugins=e},write:function(e,t,s){this.options=Object.assign({},{binary:!1,trs:!1,onlyVisible:!0,truncateDrawRange:!0,embedImages:!0,maxTextureSize:1/0,animations:[],includeCustomExtensions:!1},s),this.options.animations.length>0&&(this.options.trs=!0),this.processInput(e);var r=this;Promise.all(this.pending).then((function(){var e,s=r.buffers,n=r.json,i=r.options,a=r.extensionsUsed,o=new Blob(s,{type:"application/octet-stream"}),l=Object.keys(a);(l.length>0&&(n.extensionsUsed=l),n.buffers&&n.buffers.length>0&&(n.buffers[0].byteLength=o.size),!0===i.binary)?((e=new window.FileReader).readAsArrayBuffer(o),e.onloadend=function(){var s=k(e.result),r=new DataView(new ArrayBuffer(8));r.setUint32(0,s.byteLength,!0),r.setUint32(4,5130562,!0);var i=k(function(e){if(void 0!==window.TextEncoder)return(new TextEncoder).encode(e).buffer;for(var t=new Uint8Array(new ArrayBuffer(e.length)),s=0,r=e.length;s<r;s++){var n=e.charCodeAt(s);t[s]=n>255?32:n}return t.buffer}(JSON.stringify(n)),32),a=new DataView(new ArrayBuffer(8));a.setUint32(0,i.byteLength,!0),a.setUint32(4,1313821514,!0);var o=new ArrayBuffer(12),l=new DataView(o);l.setUint32(0,1179937895,!0),l.setUint32(4,2,!0);var c=12+a.byteLength+i.byteLength+r.byteLength+s.byteLength;l.setUint32(8,c,!0);var u=new Blob([o,a,i,r,s],{type:"application/octet-stream"}),h=new window.FileReader;h.readAsArrayBuffer(u),h.onloadend=function(){t(h.result)}}):n.buffers&&n.buffers.length>0?((e=new window.FileReader).readAsDataURL(o),e.onloadend=function(){var s=e.result;n.buffers[0].uri=s,t(n)}):t(n)}))},serializeUserData:function(e,t){if(0!==Object.keys(e.userData).length){var s=this.options,r=this.extensionsUsed;try{var n=JSON.parse(JSON.stringify(e.userData));if(s.includeCustomExtensions&&n.gltfExtensions){for(var i in void 0===t.extensions&&(t.extensions={}),n.gltfExtensions)t.extensions[i]=n.gltfExtensions[i],r[i]=!0;delete n.gltfExtensions}Object.keys(n).length>0&&(t.extras=n)}catch(t){console.warn("THREE.GLTFExporter: userData of '"+e.name+"' won't be serialized because of JSON.stringify error - "+t.message)}}},getUID:function(e){return this.uids.has(e)||this.uids.set(e,this.uid++),this.uids.get(e)},isNormalizedNormalAttribute:function(e){if(this.cache.attributesNormalized.has(e))return!1;for(var t=new r.Vector3,s=0,n=e.count;s<n;s++)if(Math.abs(t.fromBufferAttribute(e,s).length()-1)>5e-4)return!1;return!0},createNormalizedNormalAttribute:function(e){var t=this.cache;if(t.attributesNormalized.has(e))return t.attributesNormalized.get(e);for(var s=e.clone(),n=new r.Vector3,i=0,a=s.count;i<a;i++)n.fromBufferAttribute(s,i),0===n.x&&0===n.y&&0===n.z?n.setX(1):n.normalize(),s.setXYZ(i,n.x,n.y,n.z);return t.attributesNormalized.set(e,s),s},applyTextureTransform:function(e,t){var s=!1,r={};0===t.offset.x&&0===t.offset.y||(r.offset=t.offset.toArray(),s=!0),0!==t.rotation&&(r.rotation=t.rotation,s=!0),1===t.repeat.x&&1===t.repeat.y||(r.scale=t.repeat.toArray(),s=!0),s&&(e.extensions=e.extensions||{},e.extensions.KHR_texture_transform=r,this.extensionsUsed.KHR_texture_transform=!0)},processBuffer:function(e){var t=this.json,s=this.buffers;return t.buffers||(t.buffers=[{byteLength:0}]),s.push(e),0},processBufferView:function(e,t,s,r,n){var i,a=this.json;a.bufferViews||(a.bufferViews=[]),i=t===o?1:t===l?2:4;for(var p=E(r*e.itemSize*i),d=new DataView(new ArrayBuffer(p)),m=0,f=s;f<s+r;f++)for(var v=0;v<e.itemSize;v++){var g;e.itemSize>4?g=e.array[f*e.itemSize+v]:0===v?g=e.getX(f):1===v?g=e.getY(f):2===v?g=e.getZ(f):3===v&&(g=e.getW(f)),t===c?d.setFloat32(m,g,!0):t===u?d.setUint32(m,g,!0):t===l?d.setUint16(m,g,!0):t===o&&d.setUint8(m,g),m+=i}var y={buffer:this.processBuffer(d.buffer),byteOffset:this.byteOffset,byteLength:p};return void 0!==n&&(y.target=n),n===h&&(y.byteStride=e.itemSize*i),this.byteOffset+=p,a.bufferViews.push(y),{id:a.bufferViews.length-1,byteLength:0}},processBufferViewImage:function(e){var t=this,s=t.json;return s.bufferViews||(s.bufferViews=[]),new Promise((function(r){var n=new window.FileReader;n.readAsArrayBuffer(e),n.onloadend=function(){var e=k(n.result),i={buffer:t.processBuffer(e),byteOffset:t.byteOffset,byteLength:e.byteLength};t.byteOffset+=e.byteLength,r(s.bufferViews.push(i)-1)}}))},processAccessor:function(e,t,s,r){var n,i=this.options,a=this.json;if(e.array.constructor===Float32Array)n=c;else if(e.array.constructor===Uint32Array)n=u;else if(e.array.constructor===Uint16Array)n=l;else{if(e.array.constructor!==Uint8Array)throw new Error("THREE.GLTFExporter: Unsupported bufferAttribute component type.");n=o}if(void 0===s&&(s=0),void 0===r&&(r=e.count),i.truncateDrawRange&&void 0!==t&&null===t.index){var d=s+r,m=t.drawRange.count===1/0?e.count:t.drawRange.start+t.drawRange.count;s=Math.max(s,t.drawRange.start),(r=Math.min(d,m)-s)<0&&(r=0)}if(0===r)return null;var f,v=function(e,t,s){for(var r={min:new Array(e.itemSize).fill(Number.POSITIVE_INFINITY),max:new Array(e.itemSize).fill(Number.NEGATIVE_INFINITY)},n=t;n<t+s;n++)for(var i=0;i<e.itemSize;i++){var a;e.itemSize>4?a=e.array[n*e.itemSize+i]:0===i?a=e.getX(n):1===i?a=e.getY(n):2===i?a=e.getZ(n):3===i&&(a=e.getW(n)),r.min[i]=Math.min(r.min[i],a),r.max[i]=Math.max(r.max[i],a)}return r}(e,s,r);void 0!==t&&(f=e===t.index?p:h);var g=this.processBufferView(e,n,s,r,f),y={bufferView:g.id,byteOffset:g.byteOffset,componentType:n,count:r,max:v.max,min:v.min,type:{1:"SCALAR",2:"VEC2",3:"VEC3",4:"VEC4",16:"MAT4"}[e.itemSize]};return!0===e.normalized&&(y.normalized=!0),a.accessors||(a.accessors=[]),a.accessors.push(y)-1},processImage:function(e,t,s){var n=this,i=n.cache,a=n.json,o=n.options,l=n.pending;i.images.has(e)||i.images.set(e,{});var c=i.images.get(e),u=t===r.RGBAFormat?"image/png":"image/jpeg",h=u+":flipY/"+s.toString();if(void 0!==c[h])return c[h];a.images||(a.images=[]);var p={mimeType:u};if(o.embedImages){var d=A=A||document.createElement("canvas");d.width=Math.min(e.width,o.maxTextureSize),d.height=Math.min(e.height,o.maxTextureSize);var m=d.getContext("2d");if(!0===s&&(m.translate(0,d.height),m.scale(1,-1)),"undefined"!=typeof HTMLImageElement&&e instanceof HTMLImageElement||"undefined"!=typeof HTMLCanvasElement&&e instanceof HTMLCanvasElement||"undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas||"undefined"!=typeof ImageBitmap&&e instanceof ImageBitmap)m.drawImage(e,0,0,d.width,d.height);else{t!==r.RGBAFormat&&t!==r.RGBFormat&&console.error("GLTFExporter: Only RGB and RGBA formats are supported."),(e.width>o.maxTextureSize||e.height>o.maxTextureSize)&&console.warn("GLTFExporter: Image size is bigger than maxTextureSize",e);var f=e.data;if(t===r.RGBFormat){f=new Uint8ClampedArray(e.height*e.width*4);for(var v=0,g=0;v<f.length;v+=4,g+=3)f[v+0]=e.data[g+0],f[v+1]=e.data[g+1],f[v+2]=e.data[g+2],f[v+3]=255}m.putImageData(new ImageData(f,e.width,e.height),0,0)}!0===o.binary?l.push(new Promise((function(e){d.toBlob((function(t){n.processBufferViewImage(t).then((function(t){p.bufferView=t,e()}))}),u)}))):p.uri=d.toDataURL(u)}else p.uri=e.src;var y=a.images.push(p)-1;return c[h]=y,y},processSampler:function(e){var t=this.json;t.samplers||(t.samplers=[]);var s={magFilter:x[e.magFilter],minFilter:x[e.minFilter],wrapS:x[e.wrapS],wrapT:x[e.wrapT]};return t.samplers.push(s)-1},processTexture:function(e){var t=this.cache,s=this.json;if(t.textures.has(e))return t.textures.get(e);s.textures||(s.textures=[]);var r={sampler:this.processSampler(e),source:this.processImage(e.image,e.format,e.flipY)};e.name&&(r.name=e.name),this._invokeAll((function(t){t.writeTexture&&t.writeTexture(e,r)}));var n=s.textures.push(r)-1;return t.textures.set(e,n),n},processMaterial:function(e){var t=this.cache,s=this.json;if(t.materials.has(e))return t.materials.get(e);if(e.isShaderMaterial)return console.warn("GLTFExporter: THREE.ShaderMaterial not supported."),null;s.materials||(s.materials=[]);var n={pbrMetallicRoughness:{}};!0!==e.isMeshStandardMaterial&&!0!==e.isMeshBasicMaterial&&console.warn("GLTFExporter: Use MeshStandardMaterial or MeshBasicMaterial for best results.");var i=e.color.toArray().concat([e.opacity]);if(S(i,[1,1,1,1])||(n.pbrMetallicRoughness.baseColorFactor=i),e.isMeshStandardMaterial?(n.pbrMetallicRoughness.metallicFactor=e.metalness,n.pbrMetallicRoughness.roughnessFactor=e.roughness):(n.pbrMetallicRoughness.metallicFactor=.5,n.pbrMetallicRoughness.roughnessFactor=.5),e.metalnessMap||e.roughnessMap)if(e.metalnessMap===e.roughnessMap){var a={index:this.processTexture(e.metalnessMap)};this.applyTextureTransform(a,e.metalnessMap),n.pbrMetallicRoughness.metallicRoughnessTexture=a}else console.warn("THREE.GLTFExporter: Ignoring metalnessMap and roughnessMap because they are not the same Texture.");if(e.map){var o={index:this.processTexture(e.map)};this.applyTextureTransform(o,e.map),n.pbrMetallicRoughness.baseColorTexture=o}if(e.emissive){var l=e.emissive.clone().multiplyScalar(e.emissiveIntensity).toArray();if(S(l,[0,0,0])||(n.emissiveFactor=l),e.emissiveMap){var c={index:this.processTexture(e.emissiveMap)};this.applyTextureTransform(c,e.emissiveMap),n.emissiveTexture=c}}if(e.normalMap){var u={index:this.processTexture(e.normalMap)};e.normalScale&&-1!==e.normalScale.x&&(e.normalScale.x!==e.normalScale.y&&console.warn("THREE.GLTFExporter: Normal scale components are different, ignoring Y and exporting X."),u.scale=e.normalScale.x),this.applyTextureTransform(u,e.normalMap),n.normalTexture=u}if(e.aoMap){var h={index:this.processTexture(e.aoMap),texCoord:1};1!==e.aoMapIntensity&&(h.strength=e.aoMapIntensity),this.applyTextureTransform(h,e.aoMap),n.occlusionTexture=h}e.transparent?n.alphaMode="BLEND":e.alphaTest>0&&(n.alphaMode="MASK",n.alphaCutoff=e.alphaTest),e.side===r.DoubleSide&&(n.doubleSided=!0),""!==e.name&&(n.name=e.name),this.serializeUserData(e,n),this._invokeAll((function(t){t.writeMaterial&&t.writeMaterial(e,n)}));var p=s.materials.push(n)-1;return t.materials.set(e,p),p},processMesh:function(e){var o=this.cache,l=this.json,c=[e.geometry.uuid];if(Array.isArray(e.material))for(var u=0,h=e.material.length;u<h;u++)c.push(e.material[u].uuid);else c.push(e.material.uuid);var p=c.join(":");if(o.meshes.has(p))return o.meshes.get(p);var d,m=e.geometry;if(d=e.isLineSegments?s:e.isLineLoop?n:e.isLine?i:e.isPoints?t:e.material.wireframe?s:a,!0!==m.isBufferGeometry)throw new Error("THREE.GLTFExporter: Geometry is not of type THREE.BufferGeometry.");var f={},v={},g=[],y=[],b={uv:"TEXCOORD_0",uv2:"TEXCOORD_1",color:"COLOR_0",skinWeight:"WEIGHTS_0",skinIndex:"JOINTS_0"},w=m.getAttribute("normal");void 0===w||this.isNormalizedNormalAttribute(w)||(console.warn("THREE.GLTFExporter: Creating normalized normal attribute from the non-normalized one."),m.setAttribute("normal",this.createNormalizedNormalAttribute(w)));var T=null;for(var x in m.attributes)if("morph"!==x.substr(0,5)){var M=m.attributes[x];x=b[x]||x.toUpperCase();if(/^(POSITION|NORMAL|TANGENT|TEXCOORD_\d+|COLOR_\d+|JOINTS_\d+|WEIGHTS_\d+)$/.test(x)||(x="_"+x),o.attributes.has(this.getUID(M)))v[x]=o.attributes.get(this.getUID(M));else{T=null;var S=M.array;"JOINTS_0"!==x||S instanceof Uint16Array||S instanceof Uint8Array||(console.warn('GLTFExporter: Attribute "skinIndex" converted to type UNSIGNED_SHORT.'),T=new r.BufferAttribute(new Uint16Array(S),M.itemSize,M.normalized));var E=this.processAccessor(T||M,m);null!==E&&(v[x]=E,o.attributes.set(this.getUID(M),E))}}if(void 0!==w&&m.setAttribute("normal",w),0===Object.keys(v).length)return null;if(void 0!==e.morphTargetInfluences&&e.morphTargetInfluences.length>0){var k=[],A=[],R={};if(void 0!==e.morphTargetDictionary)for(var _ in e.morphTargetDictionary)R[e.morphTargetDictionary[_]]=_;for(u=0;u<e.morphTargetInfluences.length;++u){var I={},L=!1;for(var x in m.morphAttributes)if("position"===x||"normal"===x){M=m.morphAttributes[x][u];var P=x.toUpperCase(),O=m.attributes[x];if(o.attributes.has(this.getUID(M)))I[P]=o.attributes.get(this.getUID(M));else{var C=M.clone();if(!m.morphTargetsRelative)for(var N=0,B=M.count;N<B;N++)C.setXYZ(N,M.getX(N)-O.getX(N),M.getY(N)-O.getY(N),M.getZ(N)-O.getZ(N));I[P]=this.processAccessor(C,m),o.attributes.set(this.getUID(O),I[P])}}else L||(console.warn("GLTFExporter: Only POSITION and NORMAL morph are supported."),L=!0);y.push(I),k.push(e.morphTargetInfluences[u]),void 0!==e.morphTargetDictionary&&A.push(R[u])}f.weights=k,A.length>0&&(f.extras={},f.extras.targetNames=A)}var F=Array.isArray(e.material);if(F&&0===m.groups.length)return null;for(var j=F?e.material:[e.material],U=F?m.groups:[{materialIndex:0,start:void 0,count:void 0}],H=(u=0,U.length);u<H;u++){var V={mode:d,attributes:v};if(this.serializeUserData(m,V),y.length>0&&(V.targets=y),null!==m.index){var G=this.getUID(m.index);void 0===U[u].start&&void 0===U[u].count||(G+=":"+U[u].start+":"+U[u].count),o.attributes.has(G)?V.indices=o.attributes.get(G):(V.indices=this.processAccessor(m.index,m,U[u].start,U[u].count),o.attributes.set(G,V.indices)),null===V.indices&&delete V.indices}var D=this.processMaterial(j[U[u].materialIndex]);null!==D&&(V.material=D),g.push(V)}f.primitives=g,l.meshes||(l.meshes=[]),this._invokeAll((function(t){t.writeMesh&&t.writeMesh(e,f)}));var z=l.meshes.push(f)-1;return o.meshes.set(p,z),z},processCamera:function(e){var t=this.json;t.cameras||(t.cameras=[]);var s=e.isOrthographicCamera,n={type:s?"orthographic":"perspective"};return s?n.orthographic={xmag:2*e.right,ymag:2*e.top,zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near}:n.perspective={aspectRatio:e.aspect,yfov:r.MathUtils.degToRad(e.fov),zfar:e.far<=0?.001:e.far,znear:e.near<0?0:e.near},""!==e.name&&(n.name=e.type),t.cameras.push(n)-1},processAnimation:function(t,s){var n=this.json,i=this.nodeMap;n.animations||(n.animations=[]);for(var a=(t=e.Utils.mergeMorphTargetTracks(t.clone(),s)).tracks,o=[],l=[],c=0;c<a.length;++c){var u=a[c],h=r.PropertyBinding.parseTrackName(u.name),p=r.PropertyBinding.findNode(s,h.nodeName),d=M[h.propertyName];if("bones"===h.objectName&&(p=!0===p.isSkinnedMesh?p.skeleton.getBoneByName(h.objectIndex):void 0),!p||!d)return console.warn('THREE.GLTFExporter: Could not export animation track "%s".',u.name),null;var m,f=u.values.length/u.times.length;d===M.morphTargetInfluences&&(f/=p.morphTargetInfluences.length),!0===u.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline?(m="CUBICSPLINE",f/=3):m=u.getInterpolation()===r.InterpolateDiscrete?"STEP":"LINEAR",l.push({input:this.processAccessor(new r.BufferAttribute(u.times,1)),output:this.processAccessor(new r.BufferAttribute(u.values,f)),interpolation:m}),o.push({sampler:l.length-1,target:{node:i.get(p),path:d}})}return n.animations.push({name:t.name||"clip_"+n.animations.length,samplers:l,channels:o}),n.animations.length-1},processSkin:function(e){var t=this.json,s=this.nodeMap,n=t.nodes[s.get(e)],i=e.skeleton;if(void 0===i)return null;var a=e.skeleton.bones[0];if(void 0===a)return null;for(var o=[],l=new Float32Array(16*i.bones.length),c=new r.Matrix4,u=0;u<i.bones.length;++u)o.push(s.get(i.bones[u])),c.copy(i.boneInverses[u]),c.multiply(e.bindMatrix).toArray(l,16*u);return void 0===t.skins&&(t.skins=[]),t.skins.push({inverseBindMatrices:this.processAccessor(new r.BufferAttribute(l,16)),joints:o,skeleton:s.get(a)}),n.skin=t.skins.length-1},processNode:function(e){var t=this.json,s=this.options,r=this.nodeMap;t.nodes||(t.nodes=[]);var n={};if(s.trs){var i=e.quaternion.toArray(),a=e.position.toArray(),o=e.scale.toArray();S(i,[0,0,0,1])||(n.rotation=i),S(a,[0,0,0])||(n.translation=a),S(o,[1,1,1])||(n.scale=o)}else e.matrixAutoUpdate&&e.updateMatrix(),!1===S(e.matrix.elements,[1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1])&&(n.matrix=e.matrix.elements);if(""!==e.name&&(n.name=String(e.name)),this.serializeUserData(e,n),e.isMesh||e.isLine||e.isPoints){var l=this.processMesh(e);null!==l&&(n.mesh=l)}else e.isCamera&&(n.camera=this.processCamera(e));if(e.isSkinnedMesh&&this.skins.push(e),e.children.length>0){for(var c=[],u=0,h=e.children.length;u<h;u++){var p=e.children[u];if(p.visible||!1===s.onlyVisible)null!==(d=this.processNode(p))&&c.push(d)}c.length>0&&(n.children=c)}this._invokeAll((function(t){t.writeNode&&t.writeNode(e,n)}));var d=t.nodes.push(n)-1;return r.set(e,d),d},processScene:function(e){var t=this.json,s=this.options;t.scenes||(t.scenes=[],t.scene=0);var r={};""!==e.name&&(r.name=e.name),t.scenes.push(r);for(var n=[],i=0,a=e.children.length;i<a;i++){var o=e.children[i];if(o.visible||!1===s.onlyVisible){var l=this.processNode(o);null!==l&&n.push(l)}}n.length>0&&(r.nodes=n),this.serializeUserData(e,r)},processObjects:function(e){var t=new r.Scene;t.name="AuxScene";for(var s=0;s<e.length;s++)t.children.push(e[s]);this.processScene(t)},processInput:function(e){var t=this.options;e=e instanceof Array?e:[e],this._invokeAll((function(t){t.beforeParse&&t.beforeParse(e)}));for(var s=[],n=0;n<e.length;n++)e[n]instanceof r.Scene?this.processScene(e[n]):s.push(e[n]);s.length>0&&this.processObjects(s);for(n=0;n<this.skins.length;++n)this.processSkin(this.skins[n]);for(n=0;n<t.animations.length;++n)this.processAnimation(t.animations[n],e[0]);this._invokeAll((function(t){t.afterParse&&t.afterParse(e)}))},_invokeAll:function(e){for(var t=0,s=this.plugins.length;t<s;t++)e(this.plugins[t])}},_.prototype={constructor:_,writeNode:function(e,t){if(e.isLight)if(e.isDirectionalLight||e.isPointLight||e.isSpotLight){var s=this.writer,r=s.json,n=s.extensionsUsed,i={};e.name&&(i.name=e.name),i.color=e.color.toArray(),i.intensity=e.intensity,e.isDirectionalLight?i.type="directional":e.isPointLight?(i.type="point",e.distance>0&&(i.range=e.distance)):e.isSpotLight&&(i.type="spot",e.distance>0&&(i.range=e.distance),i.spot={},i.spot.innerConeAngle=(e.penumbra-1)*e.angle*-1,i.spot.outerConeAngle=e.angle),void 0!==e.decay&&2!==e.decay&&console.warn("THREE.GLTFExporter: Light decay may be lost. glTF is physically-based, and expects light.decay=2."),!e.target||e.target.parent===e&&0===e.target.position.x&&0===e.target.position.y&&-1===e.target.position.z||console.warn("THREE.GLTFExporter: Light direction may be lost. For best results, make light.target a child of the light with position 0,0,-1."),n[this.name]||(r.extensions=r.extensions||{},r.extensions[this.name]={lights:[]},n[this.name]=!0);var a=r.extensions[this.name].lights;a.push(i),t.extensions=t.extensions||{},t.extensions[this.name]={light:a.length-1}}else console.warn("THREE.GLTFExporter: Only directional, point, and spot lights are supported.",e)}},I.prototype={constructor:I,writeMaterial:function(e,t){if(e.isMeshBasicMaterial){var s=this.writer.extensionsUsed;t.extensions=t.extensions||{},t.extensions[this.name]={},s[this.name]=!0,t.pbrMetallicRoughness.metallicFactor=0,t.pbrMetallicRoughness.roughnessFactor=.9}}},L.prototype={constructor:L,writeMaterial:function(e,t){if(e.isGLTFSpecularGlossinessMaterial){var s=this.writer,r=s.extensionsUsed,n={};t.pbrMetallicRoughness.baseColorFactor&&(n.diffuseFactor=t.pbrMetallicRoughness.baseColorFactor);var i=[1,1,1];if(e.specular.toArray(i,0),n.specularFactor=i,n.glossinessFactor=e.glossiness,t.pbrMetallicRoughness.baseColorTexture&&(n.diffuseTexture=t.pbrMetallicRoughness.baseColorTexture),e.specularMap){var a={index:s.processTexture(e.specularMap)};s.applyTextureTransform(a,e.specularMap),n.specularGlossinessTexture=a}t.extensions=t.extensions||{},t.extensions[this.name]=n,r[this.name]=!0}}},e.Utils={insertKeyframe:function(e,t){var s,r=.001,n=e.getValueSize(),i=new e.TimeBufferType(e.times.length+1),a=new e.ValueBufferType(e.values.length+n),o=e.createInterpolant(new e.ValueBufferType(n));if(0===e.times.length){i[0]=t;for(var l=0;l<n;l++)a[l]=0;s=0}else if(t<e.times[0]){if(Math.abs(e.times[0]-t)<r)return 0;i[0]=t,i.set(e.times,1),a.set(o.evaluate(t),0),a.set(e.values,n),s=0}else if(t>e.times[e.times.length-1]){if(Math.abs(e.times[e.times.length-1]-t)<r)return e.times.length-1;i[i.length-1]=t,i.set(e.times,0),a.set(e.values,0),a.set(o.evaluate(t),e.values.length),s=i.length-1}else for(l=0;l<e.times.length;l++){if(Math.abs(e.times[l]-t)<r)return l;if(e.times[l]<t&&e.times[l+1]>t){i.set(e.times.slice(0,l+1),0),i[l+1]=t,i.set(e.times.slice(l+1),l+2),a.set(e.values.slice(0,(l+1)*n),0),a.set(o.evaluate(t),(l+1)*n),a.set(e.values.slice((l+1)*n),(l+2)*n),s=l+1;break}}return e.times=i,e.values=a,s},mergeMorphTargetTracks:function(e,t){for(var s=[],n={},i=e.tracks,a=0;a<i.length;++a){var o=i[a],l=r.PropertyBinding.parseTrackName(o.name),c=r.PropertyBinding.findNode(t,l.nodeName);if("morphTargetInfluences"===l.propertyName&&void 0!==l.propertyIndex){if(o.createInterpolant!==o.InterpolantFactoryMethodDiscrete&&o.createInterpolant!==o.InterpolantFactoryMethodLinear){if(o.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline)throw new Error("THREE.GLTFExporter: Cannot merge tracks with glTF CUBICSPLINE interpolation.");console.warn("THREE.GLTFExporter: Morph target interpolation mode not yet supported. Using LINEAR instead."),(o=o.clone()).setInterpolation(r.InterpolateLinear)}var u,h=c.morphTargetInfluences.length,p=c.morphTargetDictionary[l.propertyIndex];if(void 0===p)throw new Error("THREE.GLTFExporter: Morph target name not found: "+l.propertyIndex);if(void 0!==n[c.uuid]){var d=o.createInterpolant(new o.ValueBufferType(1));u=n[c.uuid];for(v=0;v<u.times.length;v++)u.values[v*h+p]=d.evaluate(u.times[v]);for(v=0;v<o.times.length;v++){var m=this.insertKeyframe(u,o.times[v]);u.values[m*h+p]=o.values[v]}}else{for(var f=new((u=o.clone()).ValueBufferType)(h*u.times.length),v=0;v<u.times.length;v++)f[v*h+p]=u.values[v];u.name=(l.nodeName||"")+".morphTargetInfluences",u.values=f,n[c.uuid]=u,s.push(u)}}else s.push(o)}return e.tracks=s,e}},e}()},"./node_modules/three/examples/jsm/loaders/GLTFLoader.js":(e,t,s)=>{"use strict";s.r(t),s.d(t,{GLTFLoader:()=>n});var r=s("./node_modules/three/build/three.module.js"),n=function(){function e(e){r.Loader.call(this,e),this.dracoLoader=null,this.ktx2Loader=null,this.meshoptDecoder=null,this.pluginCallbacks=[],this.register((function(e){return new a(e)})),this.register((function(e){return new l(e)})),this.register((function(e){return new c(e)})),this.register((function(e){return new o(e)})),this.register((function(e){return new n(e)})),this.register((function(e){return new u(e)}))}function t(){var e={};return{get:function(t){return e[t]},add:function(t,s){e[t]=s},remove:function(t){delete e[t]},removeAll:function(){e={}}}}e.prototype=Object.assign(Object.create(r.Loader.prototype),{constructor:e,load:function(e,t,s,n){var i,a=this;i=""!==this.resourcePath?this.resourcePath:""!==this.path?this.path:r.LoaderUtils.extractUrlBase(e),this.manager.itemStart(e);var o=function(t){n?n(t):console.error(t),a.manager.itemError(e),a.manager.itemEnd(e)},l=new r.FileLoader(this.manager);l.setPath(this.path),l.setResponseType("arraybuffer"),l.setRequestHeader(this.requestHeader),l.setWithCredentials(this.withCredentials),l.load(e,(function(s){try{a.parse(s,i,(function(s){t(s),a.manager.itemEnd(e)}),o)}catch(e){o(e)}}),s,o)},setDRACOLoader:function(e){return this.dracoLoader=e,this},setDDSLoader:function(){throw new Error('THREE.GLTFLoader: "MSFT_texture_dds" no longer supported. Please update to "KHR_texture_basisu".')},setKTX2Loader:function(e){return this.ktx2Loader=e,this},setMeshoptDecoder:function(e){return this.meshoptDecoder=e,this},register:function(e){return-1===this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.push(e),this},unregister:function(e){return-1!==this.pluginCallbacks.indexOf(e)&&this.pluginCallbacks.splice(this.pluginCallbacks.indexOf(e),1),this},parse:function(e,t,n,a){var o,l={},c={};if("string"==typeof e)o=e;else if(r.LoaderUtils.decodeText(new Uint8Array(e,0,4))===h){try{l[s.KHR_BINARY_GLTF]=new m(e)}catch(e){return void(a&&a(e))}o=l[s.KHR_BINARY_GLTF].content}else o=r.LoaderUtils.decodeText(new Uint8Array(e));var u=JSON.parse(o);if(void 0===u.asset||u.asset.version[0]<2)a&&a(new Error("THREE.GLTFLoader: Unsupported asset. glTF versions >=2.0 are supported."));else{var p=new D(u,{path:t||this.resourcePath||"",crossOrigin:this.crossOrigin,requestHeader:this.requestHeader,manager:this.manager,ktx2Loader:this.ktx2Loader,meshoptDecoder:this.meshoptDecoder});p.fileLoader.setRequestHeader(this.requestHeader);for(var d=0;d<this.pluginCallbacks.length;d++){var g=this.pluginCallbacks[d](p);c[g.name]=g,l[g.name]=!0}if(u.extensionsUsed)for(d=0;d<u.extensionsUsed.length;++d){var w=u.extensionsUsed[d],T=u.extensionsRequired||[];switch(w){case s.KHR_MATERIALS_UNLIT:l[w]=new i;break;case s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:l[w]=new y;break;case s.KHR_DRACO_MESH_COMPRESSION:l[w]=new f(u,this.dracoLoader);break;case s.KHR_TEXTURE_TRANSFORM:l[w]=new v;break;case s.KHR_MESH_QUANTIZATION:l[w]=new b;break;default:T.indexOf(w)>=0&&void 0===c[w]&&console.warn('THREE.GLTFLoader: Unknown extension "'+w+'".')}}p.setExtensions(l),p.setPlugins(c),p.parse(n,a)}}});var s={KHR_BINARY_GLTF:"KHR_binary_glTF",KHR_DRACO_MESH_COMPRESSION:"KHR_draco_mesh_compression",KHR_LIGHTS_PUNCTUAL:"KHR_lights_punctual",KHR_MATERIALS_CLEARCOAT:"KHR_materials_clearcoat",KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS:"KHR_materials_pbrSpecularGlossiness",KHR_MATERIALS_TRANSMISSION:"KHR_materials_transmission",KHR_MATERIALS_UNLIT:"KHR_materials_unlit",KHR_TEXTURE_BASISU:"KHR_texture_basisu",KHR_TEXTURE_TRANSFORM:"KHR_texture_transform",KHR_MESH_QUANTIZATION:"KHR_mesh_quantization",EXT_TEXTURE_WEBP:"EXT_texture_webp",EXT_MESHOPT_COMPRESSION:"EXT_meshopt_compression"};function n(e){this.parser=e,this.name=s.KHR_LIGHTS_PUNCTUAL,this.cache={refs:{},uses:{}}}function i(){this.name=s.KHR_MATERIALS_UNLIT}function a(e){this.parser=e,this.name=s.KHR_MATERIALS_CLEARCOAT}function o(e){this.parser=e,this.name=s.KHR_MATERIALS_TRANSMISSION}function l(e){this.parser=e,this.name=s.KHR_TEXTURE_BASISU}function c(e){this.parser=e,this.name=s.EXT_TEXTURE_WEBP,this.isSupported=null}function u(e){this.name=s.EXT_MESHOPT_COMPRESSION,this.parser=e}n.prototype._markDefs=function(){for(var e=this.parser,t=this.parser.json.nodes||[],s=0,r=t.length;s<r;s++){var n=t[s];n.extensions&&n.extensions[this.name]&&void 0!==n.extensions[this.name].light&&e._addNodeRef(this.cache,n.extensions[this.name].light)}},n.prototype._loadLight=function(e){var t=this.parser,s="light:"+e,n=t.cache.get(s);if(n)return n;var i,a=t.json,o=((a.extensions&&a.extensions[this.name]||{}).lights||[])[e],l=new r.Color(16777215);void 0!==o.color&&l.fromArray(o.color);var c=void 0!==o.range?o.range:0;switch(o.type){case"directional":(i=new r.DirectionalLight(l)).target.position.set(0,0,-1),i.add(i.target);break;case"point":(i=new r.PointLight(l)).distance=c;break;case"spot":(i=new r.SpotLight(l)).distance=c,o.spot=o.spot||{},o.spot.innerConeAngle=void 0!==o.spot.innerConeAngle?o.spot.innerConeAngle:0,o.spot.outerConeAngle=void 0!==o.spot.outerConeAngle?o.spot.outerConeAngle:Math.PI/4,i.angle=o.spot.outerConeAngle,i.penumbra=1-o.spot.innerConeAngle/o.spot.outerConeAngle,i.target.position.set(0,0,-1),i.add(i.target);break;default:throw new Error("THREE.GLTFLoader: Unexpected light type: "+o.type)}return i.position.set(0,0,0),i.decay=2,void 0!==o.intensity&&(i.intensity=o.intensity),i.name=t.createUniqueName(o.name||"light_"+e),n=Promise.resolve(i),t.cache.add(s,n),n},n.prototype.createNodeAttachment=function(e){var t=this,s=this.parser,r=s.json.nodes[e],n=(r.extensions&&r.extensions[this.name]||{}).light;return void 0===n?null:this._loadLight(n).then((function(e){return s._getNodeRef(t.cache,n,e)}))},i.prototype.getMaterialType=function(){return r.MeshBasicMaterial},i.prototype.extendParams=function(e,t,s){var n=[];e.color=new r.Color(1,1,1),e.opacity=1;var i=t.pbrMetallicRoughness;if(i){if(Array.isArray(i.baseColorFactor)){var a=i.baseColorFactor;e.color.fromArray(a),e.opacity=a[3]}void 0!==i.baseColorTexture&&n.push(s.assignTexture(e,"map",i.baseColorTexture))}return Promise.all(n)},a.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.MeshPhysicalMaterial:null},a.prototype.extendMaterialParams=function(e,t){var s=this.parser,n=s.json.materials[e];if(!n.extensions||!n.extensions[this.name])return Promise.resolve();var i=[],a=n.extensions[this.name];if(void 0!==a.clearcoatFactor&&(t.clearcoat=a.clearcoatFactor),void 0!==a.clearcoatTexture&&i.push(s.assignTexture(t,"clearcoatMap",a.clearcoatTexture)),void 0!==a.clearcoatRoughnessFactor&&(t.clearcoatRoughness=a.clearcoatRoughnessFactor),void 0!==a.clearcoatRoughnessTexture&&i.push(s.assignTexture(t,"clearcoatRoughnessMap",a.clearcoatRoughnessTexture)),void 0!==a.clearcoatNormalTexture&&(i.push(s.assignTexture(t,"clearcoatNormalMap",a.clearcoatNormalTexture)),void 0!==a.clearcoatNormalTexture.scale)){var o=a.clearcoatNormalTexture.scale;t.clearcoatNormalScale=new r.Vector2(o,-o)}return Promise.all(i)},o.prototype.getMaterialType=function(e){var t=this.parser.json.materials[e];return t.extensions&&t.extensions[this.name]?r.MeshPhysicalMaterial:null},o.prototype.extendMaterialParams=function(e,t){var s=this.parser,r=s.json.materials[e];if(!r.extensions||!r.extensions[this.name])return Promise.resolve();var n=[],i=r.extensions[this.name];return void 0!==i.transmissionFactor&&(t.transmission=i.transmissionFactor),void 0!==i.transmissionTexture&&n.push(s.assignTexture(t,"transmissionMap",i.transmissionTexture)),Promise.all(n)},l.prototype.loadTexture=function(e){var t=this.parser,s=t.json,r=s.textures[e];if(!r.extensions||!r.extensions[this.name])return null;var n=r.extensions[this.name],i=s.images[n.source],a=t.options.ktx2Loader;if(!a){if(s.extensionsRequired&&s.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setKTX2Loader must be called before loading KTX2 textures");return null}return t.loadTextureImage(e,i,a)},c.prototype.loadTexture=function(e){var t=this.name,s=this.parser,r=s.json,n=r.textures[e];if(!n.extensions||!n.extensions[t])return null;var i=n.extensions[t],a=r.images[i.source],o=s.textureLoader;if(a.uri){var l=s.options.manager.getHandler(a.uri);null!==l&&(o=l)}return this.detectSupport().then((function(n){if(n)return s.loadTextureImage(e,a,o);if(r.extensionsRequired&&r.extensionsRequired.indexOf(t)>=0)throw new Error("THREE.GLTFLoader: WebP required by asset but unsupported.");return s.loadTexture(e)}))},c.prototype.detectSupport=function(){return this.isSupported||(this.isSupported=new Promise((function(e){var t=new Image;t.src="data:image/webp;base64,UklGRiIAAABXRUJQVlA4IBYAAAAwAQCdASoBAAEADsD+JaQAA3AAAAAA",t.onload=t.onerror=function(){e(1===t.height)}}))),this.isSupported},u.prototype.loadBufferView=function(e){var t=this.parser.json,s=t.bufferViews[e];if(s.extensions&&s.extensions[this.name]){var r=s.extensions[this.name],n=this.parser.getDependency("buffer",r.buffer),i=this.parser.options.meshoptDecoder;if(!i||!i.supported){if(t.extensionsRequired&&t.extensionsRequired.indexOf(this.name)>=0)throw new Error("THREE.GLTFLoader: setMeshoptDecoder must be called before loading compressed files");return null}return Promise.all([n,i.ready]).then((function(e){var t=r.byteOffset||0,s=r.byteLength||0,n=r.count,a=r.byteStride,o=new ArrayBuffer(n*a),l=new Uint8Array(e[0],t,s);return i.decodeGltfBuffer(new Uint8Array(o),n,a,l,r.mode,r.filter),o}))}return null};var h="glTF",p=1313821514,d=5130562;function m(e){this.name=s.KHR_BINARY_GLTF,this.content=null,this.body=null;var t=new DataView(e,0,12);if(this.header={magic:r.LoaderUtils.decodeText(new Uint8Array(e.slice(0,4))),version:t.getUint32(4,!0),length:t.getUint32(8,!0)},this.header.magic!==h)throw new Error("THREE.GLTFLoader: Unsupported glTF-Binary header.");if(this.header.version<2)throw new Error("THREE.GLTFLoader: Legacy binary file detected.");for(var n=this.header.length-12,i=new DataView(e,12),a=0;a<n;){var o=i.getUint32(a,!0);a+=4;var l=i.getUint32(a,!0);if(a+=4,l===p){var c=new Uint8Array(e,12+a,o);this.content=r.LoaderUtils.decodeText(c)}else if(l===d){var u=12+a;this.body=e.slice(u,u+o)}a+=o}if(null===this.content)throw new Error("THREE.GLTFLoader: JSON content not found.")}function f(e,t){if(!t)throw new Error("THREE.GLTFLoader: No DRACOLoader instance provided.");this.name=s.KHR_DRACO_MESH_COMPRESSION,this.json=e,this.dracoLoader=t,this.dracoLoader.preload()}function v(){this.name=s.KHR_TEXTURE_TRANSFORM}function g(e){r.MeshStandardMaterial.call(this),this.isGLTFSpecularGlossinessMaterial=!0;var t=["#ifdef USE_SPECULARMAP","\tuniform sampler2D specularMap;","#endif"].join("\n"),s=["#ifdef USE_GLOSSINESSMAP","\tuniform sampler2D glossinessMap;","#endif"].join("\n"),n=["vec3 specularFactor = specular;","#ifdef USE_SPECULARMAP","\tvec4 texelSpecular = texture2D( specularMap, vUv );","\ttexelSpecular = sRGBToLinear( texelSpecular );","\t// reads channel RGB, compatible with a glTF Specular-Glossiness (RGBA) texture","\tspecularFactor *= texelSpecular.rgb;","#endif"].join("\n"),i=["float glossinessFactor = glossiness;","#ifdef USE_GLOSSINESSMAP","\tvec4 texelGlossiness = texture2D( glossinessMap, vUv );","\t// reads channel A, compatible with a glTF Specular-Glossiness (RGBA) texture","\tglossinessFactor *= texelGlossiness.a;","#endif"].join("\n"),a=["PhysicalMaterial material;","material.diffuseColor = diffuseColor.rgb * ( 1. - max( specularFactor.r, max( specularFactor.g, specularFactor.b ) ) );","vec3 dxy = max( abs( dFdx( geometryNormal ) ), abs( dFdy( geometryNormal ) ) );","float geometryRoughness = max( max( dxy.x, dxy.y ), dxy.z );","material.specularRoughness = max( 1.0 - glossinessFactor, 0.0525 ); // 0.0525 corresponds to the base mip of a 256 cubemap.","material.specularRoughness += geometryRoughness;","material.specularRoughness = min( material.specularRoughness, 1.0 );","material.specularColor = specularFactor;"].join("\n"),o={specular:{value:(new r.Color).setHex(16777215)},glossiness:{value:1},specularMap:{value:null},glossinessMap:{value:null}};this._extraUniforms=o,this.onBeforeCompile=function(e){for(var r in o)e.uniforms[r]=o[r];e.fragmentShader=e.fragmentShader.replace("uniform float roughness;","uniform vec3 specular;").replace("uniform float metalness;","uniform float glossiness;").replace("#include <roughnessmap_pars_fragment>",t).replace("#include <metalnessmap_pars_fragment>",s).replace("#include <roughnessmap_fragment>",n).replace("#include <metalnessmap_fragment>",i).replace("#include <lights_physical_fragment>",a)},Object.defineProperties(this,{specular:{get:function(){return o.specular.value},set:function(e){o.specular.value=e}},specularMap:{get:function(){return o.specularMap.value},set:function(e){o.specularMap.value=e,e?this.defines.USE_SPECULARMAP="":delete this.defines.USE_SPECULARMAP}},glossiness:{get:function(){return o.glossiness.value},set:function(e){o.glossiness.value=e}},glossinessMap:{get:function(){return o.glossinessMap.value},set:function(e){o.glossinessMap.value=e,e?(this.defines.USE_GLOSSINESSMAP="",this.defines.USE_UV=""):(delete this.defines.USE_GLOSSINESSMAP,delete this.defines.USE_UV)}}}),delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this.setValues(e)}function y(){return{name:s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS,specularGlossinessParams:["color","map","lightMap","lightMapIntensity","aoMap","aoMapIntensity","emissive","emissiveIntensity","emissiveMap","bumpMap","bumpScale","normalMap","normalMapType","displacementMap","displacementScale","displacementBias","specularMap","specular","glossinessMap","glossiness","alphaMap","envMap","envMapIntensity","refractionRatio"],getMaterialType:function(){return g},extendParams:function(e,t,s){var n=t.extensions[this.name];e.color=new r.Color(1,1,1),e.opacity=1;var i=[];if(Array.isArray(n.diffuseFactor)){var a=n.diffuseFactor;e.color.fromArray(a),e.opacity=a[3]}if(void 0!==n.diffuseTexture&&i.push(s.assignTexture(e,"map",n.diffuseTexture)),e.emissive=new r.Color(0,0,0),e.glossiness=void 0!==n.glossinessFactor?n.glossinessFactor:1,e.specular=new r.Color(1,1,1),Array.isArray(n.specularFactor)&&e.specular.fromArray(n.specularFactor),void 0!==n.specularGlossinessTexture){var o=n.specularGlossinessTexture;i.push(s.assignTexture(e,"glossinessMap",o)),i.push(s.assignTexture(e,"specularMap",o))}return Promise.all(i)},createMaterial:function(e){var t=new g(e);return t.fog=!0,t.color=e.color,t.map=void 0===e.map?null:e.map,t.lightMap=null,t.lightMapIntensity=1,t.aoMap=void 0===e.aoMap?null:e.aoMap,t.aoMapIntensity=1,t.emissive=e.emissive,t.emissiveIntensity=1,t.emissiveMap=void 0===e.emissiveMap?null:e.emissiveMap,t.bumpMap=void 0===e.bumpMap?null:e.bumpMap,t.bumpScale=1,t.normalMap=void 0===e.normalMap?null:e.normalMap,t.normalMapType=r.TangentSpaceNormalMap,e.normalScale&&(t.normalScale=e.normalScale),t.displacementMap=null,t.displacementScale=1,t.displacementBias=0,t.specularMap=void 0===e.specularMap?null:e.specularMap,t.specular=e.specular,t.glossinessMap=void 0===e.glossinessMap?null:e.glossinessMap,t.glossiness=e.glossiness,t.alphaMap=null,t.envMap=void 0===e.envMap?null:e.envMap,t.envMapIntensity=1,t.refractionRatio=.98,t}}}function b(){this.name=s.KHR_MESH_QUANTIZATION}function w(e,t,s,n){r.Interpolant.call(this,e,t,s,n)}f.prototype.decodePrimitive=function(e,t){var s=this.json,r=this.dracoLoader,n=e.extensions[this.name].bufferView,i=e.extensions[this.name].attributes,a={},o={},l={};for(var c in i){var u=P[c]||c.toLowerCase();a[u]=i[c]}for(c in e.attributes){u=P[c]||c.toLowerCase();if(void 0!==i[c]){var h=s.accessors[e.attributes[c]],p=R[h.componentType];l[u]=p,o[u]=!0===h.normalized}}return t.getDependency("bufferView",n).then((function(e){return new Promise((function(t){r.decodeDracoFile(e,(function(e){for(var s in e.attributes){var r=e.attributes[s],n=o[s];void 0!==n&&(r.normalized=n)}t(e)}),a,l)}))}))},v.prototype.extendTexture=function(e,t){return e=e.clone(),void 0!==t.offset&&e.offset.fromArray(t.offset),void 0!==t.rotation&&(e.rotation=t.rotation),void 0!==t.scale&&e.repeat.fromArray(t.scale),void 0!==t.texCoord&&console.warn('THREE.GLTFLoader: Custom UV sets in "'+this.name+'" extension not yet supported.'),e.needsUpdate=!0,e},g.prototype=Object.create(r.MeshStandardMaterial.prototype),g.prototype.constructor=g,g.prototype.copy=function(e){return r.MeshStandardMaterial.prototype.copy.call(this,e),this.specularMap=e.specularMap,this.specular.copy(e.specular),this.glossinessMap=e.glossinessMap,this.glossiness=e.glossiness,delete this.metalness,delete this.roughness,delete this.metalnessMap,delete this.roughnessMap,this},w.prototype=Object.create(r.Interpolant.prototype),w.prototype.constructor=w,w.prototype.copySampleValue_=function(e){for(var t=this.resultBuffer,s=this.sampleValues,r=this.valueSize,n=e*r*3+r,i=0;i!==r;i++)t[i]=s[n+i];return t},w.prototype.beforeStart_=w.prototype.copySampleValue_,w.prototype.afterEnd_=w.prototype.copySampleValue_,w.prototype.interpolate_=function(e,t,s,r){for(var n=this.resultBuffer,i=this.sampleValues,a=this.valueSize,o=2*a,l=3*a,c=r-t,u=(s-t)/c,h=u*u,p=h*u,d=e*l,m=d-l,f=-2*p+3*h,v=p-h,g=1-f,y=v-h+u,b=0;b!==a;b++){var w=i[m+b+a],T=i[m+b+o]*c,x=i[d+b+a],M=i[d+b]*c;n[b]=g*w+y*T+f*x+v*M}return n};var T=0,x=1,M=2,S=3,E=4,k=5,A=6,R={5120:Int8Array,5121:Uint8Array,5122:Int16Array,5123:Uint16Array,5125:Uint32Array,5126:Float32Array},_={9728:r.NearestFilter,9729:r.LinearFilter,9984:r.NearestMipmapNearestFilter,9985:r.LinearMipmapNearestFilter,9986:r.NearestMipmapLinearFilter,9987:r.LinearMipmapLinearFilter},I={33071:r.ClampToEdgeWrapping,33648:r.MirroredRepeatWrapping,10497:r.RepeatWrapping},L={SCALAR:1,VEC2:2,VEC3:3,VEC4:4,MAT2:4,MAT3:9,MAT4:16},P={POSITION:"position",NORMAL:"normal",TANGENT:"tangent",TEXCOORD_0:"uv",TEXCOORD_1:"uv2",COLOR_0:"color",WEIGHTS_0:"skinWeight",JOINTS_0:"skinIndex"},O={scale:"scale",translation:"position",rotation:"quaternion",weights:"morphTargetInfluences"},C={CUBICSPLINE:void 0,LINEAR:r.InterpolateLinear,STEP:r.InterpolateDiscrete},N="OPAQUE",B="MASK",F="BLEND";function j(e,t){return"string"!=typeof e||""===e?"":(/^https?:\/\//i.test(t)&&/^\//.test(e)&&(t=t.replace(/(^https?:\/\/[^\/]+).*/i,"$1")),/^(https?:)?\/\//i.test(e)||/^data:.*,.*$/i.test(e)||/^blob:.*$/i.test(e)?e:t+e)}function U(e,t,s){for(var r in s.extensions)void 0===e[r]&&(t.userData.gltfExtensions=t.userData.gltfExtensions||{},t.userData.gltfExtensions[r]=s.extensions[r])}function H(e,t){void 0!==t.extras&&("object"==typeof t.extras?Object.assign(e.userData,t.extras):console.warn("THREE.GLTFLoader: Ignoring primitive type .extras, "+t.extras))}function V(e,t){if(e.updateMorphTargets(),void 0!==t.weights)for(var s=0,r=t.weights.length;s<r;s++)e.morphTargetInfluences[s]=t.weights[s];if(t.extras&&Array.isArray(t.extras.targetNames)){var n=t.extras.targetNames;if(e.morphTargetInfluences.length===n.length){e.morphTargetDictionary={};for(s=0,r=n.length;s<r;s++)e.morphTargetDictionary[n[s]]=s}else console.warn("THREE.GLTFLoader: Invalid extras.targetNames length. Ignoring names.")}}function G(e){for(var t="",s=Object.keys(e).sort(),r=0,n=s.length;r<n;r++)t+=s[r]+":"+e[s[r]]+";";return t}function D(e,s){this.json=e||{},this.extensions={},this.plugins={},this.options=s||{},this.cache=new t,this.associations=new Map,this.primitiveCache={},this.meshCache={refs:{},uses:{}},this.cameraCache={refs:{},uses:{}},this.lightCache={refs:{},uses:{}},this.nodeNamesUsed={},"undefined"!=typeof createImageBitmap&&!1===/Firefox/.test(navigator.userAgent)?this.textureLoader=new r.ImageBitmapLoader(this.options.manager):this.textureLoader=new r.TextureLoader(this.options.manager),this.textureLoader.setCrossOrigin(this.options.crossOrigin),this.textureLoader.setRequestHeader(this.options.requestHeader),this.fileLoader=new r.FileLoader(this.options.manager),this.fileLoader.setResponseType("arraybuffer"),"use-credentials"===this.options.crossOrigin&&this.fileLoader.setWithCredentials(!0)}function z(e,t,s){var n=t.attributes,i=[];function a(t,r){return s.getDependency("accessor",t).then((function(t){e.setAttribute(r,t)}))}for(var o in n){var l=P[o]||o.toLowerCase();l in e.attributes||i.push(a(n[o],l))}if(void 0!==t.indices&&!e.index){var c=s.getDependency("accessor",t.indices).then((function(t){e.setIndex(t)}));i.push(c)}return H(e,t),function(e,t,s){var n=t.attributes,i=new r.Box3;if(void 0!==n.POSITION){var a=(d=s.json.accessors[n.POSITION]).min,o=d.max;if(void 0!==a&&void 0!==o){i.set(new r.Vector3(a[0],a[1],a[2]),new r.Vector3(o[0],o[1],o[2]));var l=t.targets;if(void 0!==l){for(var c=new r.Vector3,u=new r.Vector3,h=0,p=l.length;h<p;h++){var d,m=l[h];if(void 0!==m.POSITION)a=(d=s.json.accessors[m.POSITION]).min,o=d.max,void 0!==a&&void 0!==o?(u.setX(Math.max(Math.abs(a[0]),Math.abs(o[0]))),u.setY(Math.max(Math.abs(a[1]),Math.abs(o[1]))),u.setZ(Math.max(Math.abs(a[2]),Math.abs(o[2]))),c.max(u)):console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}i.expandByVector(c)}e.boundingBox=i;var f=new r.Sphere;i.getCenter(f.center),f.radius=i.min.distanceTo(i.max)/2,e.boundingSphere=f}else console.warn("THREE.GLTFLoader: Missing min/max properties for accessor POSITION.")}}(e,t,s),Promise.all(i).then((function(){return void 0!==t.targets?function(e,t,s){for(var r=!1,n=!1,i=0,a=t.length;i<a&&(void 0!==(c=t[i]).POSITION&&(r=!0),void 0!==c.NORMAL&&(n=!0),!r||!n);i++);if(!r&&!n)return Promise.resolve(e);var o=[],l=[];for(i=0,a=t.length;i<a;i++){var c=t[i];if(r){var u=void 0!==c.POSITION?s.getDependency("accessor",c.POSITION):e.attributes.position;o.push(u)}n&&(u=void 0!==c.NORMAL?s.getDependency("accessor",c.NORMAL):e.attributes.normal,l.push(u))}return Promise.all([Promise.all(o),Promise.all(l)]).then((function(t){var s=t[0],i=t[1];return r&&(e.morphAttributes.position=s),n&&(e.morphAttributes.normal=i),e.morphTargetsRelative=!0,e}))}(e,t.targets,s):e}))}function W(e,t){var s=e.getIndex();if(null===s){var n=[],i=e.getAttribute("position");if(void 0===i)return console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Undefined position attribute. Processing not possible."),e;for(var a=0;a<i.count;a++)n.push(a);e.setIndex(n),s=e.getIndex()}var o=s.count-2,l=[];if(t===r.TriangleFanDrawMode)for(a=1;a<=o;a++)l.push(s.getX(0)),l.push(s.getX(a)),l.push(s.getX(a+1));else for(a=0;a<o;a++)a%2==0?(l.push(s.getX(a)),l.push(s.getX(a+1)),l.push(s.getX(a+2))):(l.push(s.getX(a+2)),l.push(s.getX(a+1)),l.push(s.getX(a)));l.length/3!==o&&console.error("THREE.GLTFLoader.toTrianglesDrawMode(): Unable to generate correct amount of triangles.");var c=e.clone();return c.setIndex(l),c}return D.prototype.setExtensions=function(e){this.extensions=e},D.prototype.setPlugins=function(e){this.plugins=e},D.prototype.parse=function(e,t){var s=this,r=this.json,n=this.extensions;this.cache.removeAll(),this._invokeAll((function(e){return e._markDefs&&e._markDefs()})),Promise.all(this._invokeAll((function(e){return e.beforeRoot&&e.beforeRoot()}))).then((function(){return Promise.all([s.getDependencies("scene"),s.getDependencies("animation"),s.getDependencies("camera")])})).then((function(t){var i={scene:t[0][r.scene||0],scenes:t[0],animations:t[1],cameras:t[2],asset:r.asset,parser:s,userData:{}};U(n,i,r),H(i,r),Promise.all(s._invokeAll((function(e){return e.afterRoot&&e.afterRoot(i)}))).then((function(){e(i)}))})).catch(t)},D.prototype._markDefs=function(){for(var e=this.json.nodes||[],t=this.json.skins||[],s=this.json.meshes||[],r=0,n=t.length;r<n;r++)for(var i=t[r].joints,a=0,o=i.length;a<o;a++)e[i[a]].isBone=!0;for(var l=0,c=e.length;l<c;l++){var u=e[l];void 0!==u.mesh&&(this._addNodeRef(this.meshCache,u.mesh),void 0!==u.skin&&(s[u.mesh].isSkinnedMesh=!0)),void 0!==u.camera&&this._addNodeRef(this.cameraCache,u.camera)}},D.prototype._addNodeRef=function(e,t){void 0!==t&&(void 0===e.refs[t]&&(e.refs[t]=e.uses[t]=0),e.refs[t]++)},D.prototype._getNodeRef=function(e,t,s){if(e.refs[t]<=1)return s;var r=s.clone();return r.name+="_instance_"+e.uses[t]++,r},D.prototype._invokeOne=function(e){var t=Object.values(this.plugins);t.push(this);for(var s=0;s<t.length;s++){var r=e(t[s]);if(r)return r}},D.prototype._invokeAll=function(e){var t=Object.values(this.plugins);t.unshift(this);for(var s=[],r=0;r<t.length;r++){var n=e(t[r]);n&&s.push(n)}return s},D.prototype.getDependency=function(e,t){var s=e+":"+t,r=this.cache.get(s);if(!r){switch(e){case"scene":r=this.loadScene(t);break;case"node":r=this.loadNode(t);break;case"mesh":r=this._invokeOne((function(e){return e.loadMesh&&e.loadMesh(t)}));break;case"accessor":r=this.loadAccessor(t);break;case"bufferView":r=this._invokeOne((function(e){return e.loadBufferView&&e.loadBufferView(t)}));break;case"buffer":r=this.loadBuffer(t);break;case"material":r=this._invokeOne((function(e){return e.loadMaterial&&e.loadMaterial(t)}));break;case"texture":r=this._invokeOne((function(e){return e.loadTexture&&e.loadTexture(t)}));break;case"skin":r=this.loadSkin(t);break;case"animation":r=this.loadAnimation(t);break;case"camera":r=this.loadCamera(t);break;default:throw new Error("Unknown type: "+e)}this.cache.add(s,r)}return r},D.prototype.getDependencies=function(e){var t=this.cache.get(e);if(!t){var s=this,r=this.json[e+("mesh"===e?"es":"s")]||[];t=Promise.all(r.map((function(t,r){return s.getDependency(e,r)}))),this.cache.add(e,t)}return t},D.prototype.loadBuffer=function(e){var t=this.json.buffers[e],r=this.fileLoader;if(t.type&&"arraybuffer"!==t.type)throw new Error("THREE.GLTFLoader: "+t.type+" buffer type is not supported.");if(void 0===t.uri&&0===e)return Promise.resolve(this.extensions[s.KHR_BINARY_GLTF].body);var n=this.options;return new Promise((function(e,s){r.load(j(t.uri,n.path),e,void 0,(function(){s(new Error('THREE.GLTFLoader: Failed to load buffer "'+t.uri+'".'))}))}))},D.prototype.loadBufferView=function(e){var t=this.json.bufferViews[e];return this.getDependency("buffer",t.buffer).then((function(e){var s=t.byteLength||0,r=t.byteOffset||0;return e.slice(r,r+s)}))},D.prototype.loadAccessor=function(e){var t=this,s=this.json,n=this.json.accessors[e];if(void 0===n.bufferView&&void 0===n.sparse)return Promise.resolve(null);var i=[];return void 0!==n.bufferView?i.push(this.getDependency("bufferView",n.bufferView)):i.push(null),void 0!==n.sparse&&(i.push(this.getDependency("bufferView",n.sparse.indices.bufferView)),i.push(this.getDependency("bufferView",n.sparse.values.bufferView))),Promise.all(i).then((function(e){var i,a,o=e[0],l=L[n.type],c=R[n.componentType],u=c.BYTES_PER_ELEMENT,h=u*l,p=n.byteOffset||0,d=void 0!==n.bufferView?s.bufferViews[n.bufferView].byteStride:void 0,m=!0===n.normalized;if(d&&d!==h){var f=Math.floor(p/d),v="InterleavedBuffer:"+n.bufferView+":"+n.componentType+":"+f+":"+n.count,g=t.cache.get(v);g||(i=new c(o,f*d,n.count*d/u),g=new r.InterleavedBuffer(i,d/u),t.cache.add(v,g)),a=new r.InterleavedBufferAttribute(g,l,p%d/u,m)}else i=null===o?new c(n.count*l):new c(o,p,n.count*l),a=new r.BufferAttribute(i,l,m);if(void 0!==n.sparse){var y=L.SCALAR,b=R[n.sparse.indices.componentType],w=n.sparse.indices.byteOffset||0,T=n.sparse.values.byteOffset||0,x=new b(e[1],w,n.sparse.count*y),M=new c(e[2],T,n.sparse.count*l);null!==o&&(a=new r.BufferAttribute(a.array.slice(),a.itemSize,a.normalized));for(var S=0,E=x.length;S<E;S++){var k=x[S];if(a.setX(k,M[S*l]),l>=2&&a.setY(k,M[S*l+1]),l>=3&&a.setZ(k,M[S*l+2]),l>=4&&a.setW(k,M[S*l+3]),l>=5)throw new Error("THREE.GLTFLoader: Unsupported itemSize in sparse BufferAttribute.")}}return a}))},D.prototype.loadTexture=function(e){var t=this.json,s=this.options,r=t.textures[e],n=t.images[r.source],i=this.textureLoader;if(n.uri){var a=s.manager.getHandler(n.uri);null!==a&&(i=a)}return this.loadTextureImage(e,n,i)},D.prototype.loadTextureImage=function(e,t,s){var n=this,i=this.json,a=this.options,o=i.textures[e],l=self.URL||self.webkitURL,c=t.uri,u=!1,h=!0;if("image/jpeg"===t.mimeType&&(h=!1),void 0!==t.bufferView)c=n.getDependency("bufferView",t.bufferView).then((function(e){if("image/png"===t.mimeType){var s=new DataView(e,25,1).getUint8(0,!1);h=6===s||4===s||3===s}u=!0;var r=new Blob([e],{type:t.mimeType});return c=l.createObjectURL(r)}));else if(void 0===t.uri)throw new Error("THREE.GLTFLoader: Image "+e+" is missing URI and bufferView");return Promise.resolve(c).then((function(e){return new Promise((function(t,n){var i=t;!0===s.isImageBitmapLoader&&(i=function(e){t(new r.CanvasTexture(e))}),s.load(j(e,a.path),i,void 0,n)}))})).then((function(t){!0===u&&l.revokeObjectURL(c),t.flipY=!1,o.name&&(t.name=o.name),h||(t.format=r.RGBFormat);var s=(i.samplers||{})[o.sampler]||{};return t.magFilter=_[s.magFilter]||r.LinearFilter,t.minFilter=_[s.minFilter]||r.LinearMipmapLinearFilter,t.wrapS=I[s.wrapS]||r.RepeatWrapping,t.wrapT=I[s.wrapT]||r.RepeatWrapping,n.associations.set(t,{type:"textures",index:e}),t}))},D.prototype.assignTexture=function(e,t,r){var n=this;return this.getDependency("texture",r.index).then((function(i){if(void 0===r.texCoord||0==r.texCoord||"aoMap"===t&&1==r.texCoord||console.warn("THREE.GLTFLoader: Custom UV set "+r.texCoord+" for texture "+t+" not yet supported."),n.extensions[s.KHR_TEXTURE_TRANSFORM]){var a=void 0!==r.extensions?r.extensions[s.KHR_TEXTURE_TRANSFORM]:void 0;if(a){var o=n.associations.get(i);i=n.extensions[s.KHR_TEXTURE_TRANSFORM].extendTexture(i,a),n.associations.set(i,o)}}e[t]=i}))},D.prototype.assignFinalMaterial=function(e){var t=e.geometry,s=e.material,n=void 0!==t.attributes.tangent,i=void 0!==t.attributes.color,a=void 0===t.attributes.normal,o=!0===e.isSkinnedMesh,l=Object.keys(t.morphAttributes).length>0,c=l&&void 0!==t.morphAttributes.normal;if(e.isPoints){var u="PointsMaterial:"+s.uuid,h=this.cache.get(u);h||(h=new r.PointsMaterial,r.Material.prototype.copy.call(h,s),h.color.copy(s.color),h.map=s.map,h.sizeAttenuation=!1,this.cache.add(u,h)),s=h}else if(e.isLine){u="LineBasicMaterial:"+s.uuid;var p=this.cache.get(u);p||(p=new r.LineBasicMaterial,r.Material.prototype.copy.call(p,s),p.color.copy(s.color),this.cache.add(u,p)),s=p}if(n||i||a||o||l){u="ClonedMaterial:"+s.uuid+":";s.isGLTFSpecularGlossinessMaterial&&(u+="specular-glossiness:"),o&&(u+="skinning:"),n&&(u+="vertex-tangents:"),i&&(u+="vertex-colors:"),a&&(u+="flat-shading:"),l&&(u+="morph-targets:"),c&&(u+="morph-normals:");var d=this.cache.get(u);d||(d=s.clone(),o&&(d.skinning=!0),i&&(d.vertexColors=!0),a&&(d.flatShading=!0),l&&(d.morphTargets=!0),c&&(d.morphNormals=!0),n&&(d.vertexTangents=!0,d.normalScale&&(d.normalScale.y*=-1),d.clearcoatNormalScale&&(d.clearcoatNormalScale.y*=-1)),this.cache.add(u,d),this.associations.set(d,this.associations.get(s))),s=d}s.aoMap&&void 0===t.attributes.uv2&&void 0!==t.attributes.uv&&t.setAttribute("uv2",t.attributes.uv),e.material=s},D.prototype.getMaterialType=function(){return r.MeshStandardMaterial},D.prototype.loadMaterial=function(e){var t,n=this,i=this.json,a=this.extensions,o=i.materials[e],l={},c=o.extensions||{},u=[];if(c[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS]){var h=a[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS];t=h.getMaterialType(),u.push(h.extendParams(l,o,n))}else if(c[s.KHR_MATERIALS_UNLIT]){var p=a[s.KHR_MATERIALS_UNLIT];t=p.getMaterialType(),u.push(p.extendParams(l,o,n))}else{var d=o.pbrMetallicRoughness||{};if(l.color=new r.Color(1,1,1),l.opacity=1,Array.isArray(d.baseColorFactor)){var m=d.baseColorFactor;l.color.fromArray(m),l.opacity=m[3]}void 0!==d.baseColorTexture&&u.push(n.assignTexture(l,"map",d.baseColorTexture)),l.metalness=void 0!==d.metallicFactor?d.metallicFactor:1,l.roughness=void 0!==d.roughnessFactor?d.roughnessFactor:1,void 0!==d.metallicRoughnessTexture&&(u.push(n.assignTexture(l,"metalnessMap",d.metallicRoughnessTexture)),u.push(n.assignTexture(l,"roughnessMap",d.metallicRoughnessTexture))),t=this._invokeOne((function(t){return t.getMaterialType&&t.getMaterialType(e)})),u.push(Promise.all(this._invokeAll((function(t){return t.extendMaterialParams&&t.extendMaterialParams(e,l)}))))}!0===o.doubleSided&&(l.side=r.DoubleSide);var f=o.alphaMode||N;return f===F?(l.transparent=!0,l.depthWrite=!1):(l.transparent=!1,f===B&&(l.alphaTest=void 0!==o.alphaCutoff?o.alphaCutoff:.5)),void 0!==o.normalTexture&&t!==r.MeshBasicMaterial&&(u.push(n.assignTexture(l,"normalMap",o.normalTexture)),l.normalScale=new r.Vector2(1,-1),void 0!==o.normalTexture.scale&&l.normalScale.set(o.normalTexture.scale,-o.normalTexture.scale)),void 0!==o.occlusionTexture&&t!==r.MeshBasicMaterial&&(u.push(n.assignTexture(l,"aoMap",o.occlusionTexture)),void 0!==o.occlusionTexture.strength&&(l.aoMapIntensity=o.occlusionTexture.strength)),void 0!==o.emissiveFactor&&t!==r.MeshBasicMaterial&&(l.emissive=(new r.Color).fromArray(o.emissiveFactor)),void 0!==o.emissiveTexture&&t!==r.MeshBasicMaterial&&u.push(n.assignTexture(l,"emissiveMap",o.emissiveTexture)),Promise.all(u).then((function(){var i;return i=t===g?a[s.KHR_MATERIALS_PBR_SPECULAR_GLOSSINESS].createMaterial(l):new t(l),o.name&&(i.name=o.name),i.map&&(i.map.encoding=r.sRGBEncoding),i.emissiveMap&&(i.emissiveMap.encoding=r.sRGBEncoding),H(i,o),n.associations.set(i,{type:"materials",index:e}),o.extensions&&U(a,i,o),i}))},D.prototype.createUniqueName=function(e){for(var t=r.PropertyBinding.sanitizeNodeName(e||""),s=t,n=1;this.nodeNamesUsed[s];++n)s=t+"_"+n;return this.nodeNamesUsed[s]=!0,s},D.prototype.loadGeometries=function(e){var t=this,n=this.extensions,i=this.primitiveCache;function a(e){return n[s.KHR_DRACO_MESH_COMPRESSION].decodePrimitive(e,t).then((function(s){return z(s,e,t)}))}for(var o,l,c=[],u=0,h=e.length;u<h;u++){var p,d=e[u],m=(l=void 0,(l=(o=d).extensions&&o.extensions[s.KHR_DRACO_MESH_COMPRESSION])?"draco:"+l.bufferView+":"+l.indices+":"+G(l.attributes):o.indices+":"+G(o.attributes)+":"+o.mode),f=i[m];if(f)c.push(f.promise);else p=d.extensions&&d.extensions[s.KHR_DRACO_MESH_COMPRESSION]?a(d):z(new r.BufferGeometry,d,t),i[m]={primitive:d,promise:p},c.push(p)}return Promise.all(c)},D.prototype.loadMesh=function(e){for(var t,s=this,n=this.json,i=this.extensions,a=n.meshes[e],o=a.primitives,l=[],c=0,u=o.length;c<u;c++){var h=void 0===o[c].material?(void 0===(t=this.cache).DefaultMaterial&&(t.DefaultMaterial=new r.MeshStandardMaterial({color:16777215,emissive:0,metalness:1,roughness:1,transparent:!1,depthTest:!0,side:r.FrontSide})),t.DefaultMaterial):this.getDependency("material",o[c].material);l.push(h)}return l.push(s.loadGeometries(o)),Promise.all(l).then((function(t){for(var n=t.slice(0,t.length-1),l=t[t.length-1],c=[],u=0,h=l.length;u<h;u++){var p,d=l[u],m=o[u],f=n[u];if(m.mode===E||m.mode===k||m.mode===A||void 0===m.mode)!0!==(p=!0===a.isSkinnedMesh?new r.SkinnedMesh(d,f):new r.Mesh(d,f)).isSkinnedMesh||p.geometry.attributes.skinWeight.normalized||p.normalizeSkinWeights(),m.mode===k?p.geometry=W(p.geometry,r.TriangleStripDrawMode):m.mode===A&&(p.geometry=W(p.geometry,r.TriangleFanDrawMode));else if(m.mode===x)p=new r.LineSegments(d,f);else if(m.mode===S)p=new r.Line(d,f);else if(m.mode===M)p=new r.LineLoop(d,f);else{if(m.mode!==T)throw new Error("THREE.GLTFLoader: Primitive mode unsupported: "+m.mode);p=new r.Points(d,f)}Object.keys(p.geometry.morphAttributes).length>0&&V(p,a),p.name=s.createUniqueName(a.name||"mesh_"+e),H(p,a),m.extensions&&U(i,p,m),s.assignFinalMaterial(p),c.push(p)}if(1===c.length)return c[0];var v=new r.Group;for(u=0,h=c.length;u<h;u++)v.add(c[u]);return v}))},D.prototype.loadCamera=function(e){var t,s=this.json.cameras[e],n=s[s.type];if(n)return"perspective"===s.type?t=new r.PerspectiveCamera(r.MathUtils.radToDeg(n.yfov),n.aspectRatio||1,n.znear||1,n.zfar||2e6):"orthographic"===s.type&&(t=new r.OrthographicCamera(-n.xmag,n.xmag,n.ymag,-n.ymag,n.znear,n.zfar)),s.name&&(t.name=this.createUniqueName(s.name)),H(t,s),Promise.resolve(t);console.warn("THREE.GLTFLoader: Missing camera parameters.")},D.prototype.loadSkin=function(e){var t=this.json.skins[e],s={joints:t.joints};return void 0===t.inverseBindMatrices?Promise.resolve(s):this.getDependency("accessor",t.inverseBindMatrices).then((function(e){return s.inverseBindMatrices=e,s}))},D.prototype.loadAnimation=function(e){for(var t=this.json.animations[e],s=[],n=[],i=[],a=[],o=[],l=0,c=t.channels.length;l<c;l++){var u=t.channels[l],h=t.samplers[u.sampler],p=u.target,d=void 0!==p.node?p.node:p.id,m=void 0!==t.parameters?t.parameters[h.input]:h.input,f=void 0!==t.parameters?t.parameters[h.output]:h.output;s.push(this.getDependency("node",d)),n.push(this.getDependency("accessor",m)),i.push(this.getDependency("accessor",f)),a.push(h),o.push(p)}return Promise.all([Promise.all(s),Promise.all(n),Promise.all(i),Promise.all(a),Promise.all(o)]).then((function(s){for(var n=s[0],i=s[1],a=s[2],o=s[3],l=s[4],c=[],u=0,h=n.length;u<h;u++){var p=n[u],d=i[u],m=a[u],f=o[u],v=l[u];if(void 0!==p){var g;switch(p.updateMatrix(),p.matrixAutoUpdate=!0,O[v.path]){case O.weights:g=r.NumberKeyframeTrack;break;case O.rotation:g=r.QuaternionKeyframeTrack;break;case O.position:case O.scale:default:g=r.VectorKeyframeTrack}var y=p.name?p.name:p.uuid,b=void 0!==f.interpolation?C[f.interpolation]:r.InterpolateLinear,T=[];O[v.path]===O.weights?p.traverse((function(e){!0===e.isMesh&&e.morphTargetInfluences&&T.push(e.name?e.name:e.uuid)})):T.push(y);var x=m.array;if(m.normalized){var M;if(x.constructor===Int8Array)M=1/127;else if(x.constructor===Uint8Array)M=1/255;else if(x.constructor==Int16Array)M=1/32767;else{if(x.constructor!==Uint16Array)throw new Error("THREE.GLTFLoader: Unsupported output accessor component type.");M=1/65535}for(var S=new Float32Array(x.length),E=0,k=x.length;E<k;E++)S[E]=x[E]*M;x=S}for(E=0,k=T.length;E<k;E++){var A=new g(T[E]+"."+O[v.path],d.array,x,b);"CUBICSPLINE"===f.interpolation&&(A.createInterpolant=function(e){return new w(this.times,this.values,this.getValueSize()/3,e)},A.createInterpolant.isInterpolantFactoryMethodGLTFCubicSpline=!0),c.push(A)}}}var R=t.name?t.name:"animation_"+e;return new r.AnimationClip(R,void 0,c)}))},D.prototype.loadNode=function(e){var t,s=this.json,n=this.extensions,i=this,a=s.nodes[e],o=a.name?i.createUniqueName(a.name):"";return(t=[],void 0!==a.mesh&&t.push(i.getDependency("mesh",a.mesh).then((function(e){var t=i._getNodeRef(i.meshCache,a.mesh,e);return void 0!==a.weights&&t.traverse((function(e){if(e.isMesh)for(var t=0,s=a.weights.length;t<s;t++)e.morphTargetInfluences[t]=a.weights[t]})),t}))),void 0!==a.camera&&t.push(i.getDependency("camera",a.camera).then((function(e){return i._getNodeRef(i.cameraCache,a.camera,e)}))),i._invokeAll((function(t){return t.createNodeAttachment&&t.createNodeAttachment(e)})).forEach((function(e){t.push(e)})),Promise.all(t)).then((function(t){var s;if((s=!0===a.isBone?new r.Bone:t.length>1?new r.Group:1===t.length?t[0]:new r.Object3D)!==t[0])for(var l=0,c=t.length;l<c;l++)s.add(t[l]);if(a.name&&(s.userData.name=a.name,s.name=o),H(s,a),a.extensions&&U(n,s,a),void 0!==a.matrix){var u=new r.Matrix4;u.fromArray(a.matrix),s.applyMatrix4(u)}else void 0!==a.translation&&s.position.fromArray(a.translation),void 0!==a.rotation&&s.quaternion.fromArray(a.rotation),void 0!==a.scale&&s.scale.fromArray(a.scale);return i.associations.set(s,{type:"nodes",index:e}),s}))},D.prototype.loadScene=function(){function e(t,s,n,i){var a=n.nodes[t];return i.getDependency("node",t).then((function(e){return void 0===a.skin?e:i.getDependency("skin",a.skin).then((function(e){for(var s=[],r=0,n=(t=e).joints.length;r<n;r++)s.push(i.getDependency("node",t.joints[r]));return Promise.all(s)})).then((function(s){return e.traverse((function(e){if(e.isMesh){for(var n=[],i=[],a=0,o=s.length;a<o;a++){var l=s[a];if(l){n.push(l);var c=new r.Matrix4;void 0!==t.inverseBindMatrices&&c.fromArray(t.inverseBindMatrices.array,16*a),i.push(c)}else console.warn('THREE.GLTFLoader: Joint "%s" could not be found.',t.joints[a])}e.bind(new r.Skeleton(n,i),e.matrixWorld)}})),e}));var t})).then((function(t){s.add(t);var r=[];if(a.children)for(var o=a.children,l=0,c=o.length;l<c;l++){var u=o[l];r.push(e(u,t,n,i))}return Promise.all(r)}))}return function(t){var s=this.json,n=this.extensions,i=this.json.scenes[t],a=new r.Group;i.name&&(a.name=this.createUniqueName(i.name)),H(a,i),i.extensions&&U(n,a,i);for(var o=i.nodes||[],l=[],c=0,u=o.length;c<u;c++)l.push(e(o[c],a,s,this));return Promise.all(l).then((function(){return a}))}}(),e}()},"./src/controller/aim.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Aim=void 0;const r=s("./src/controller/controller.ts"),n=s("./src/controller/controllerbase.ts"),i=s("./src/controller/playshot.ts"),a=s("./src/utils/gltf.ts");class o extends n.ControllerBase{constructor(e){super(e),this.scale=.001,this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.table.cue.aim.power=0,this.container.view.camera.mode=this.container.view.camera.aimView}handleInput(e){switch(e.key){case"ArrowLeft":this.container.table.cue.rotateAim(-e.t*this.scale);break;case"ArrowRight":this.container.table.cue.rotateAim(e.t*this.scale);break;case"movementXUp":this.container.table.cue.rotateAim(e.t*this.scale*2);break;case"ArrowDown":this.container.table.cue.adjustHeight(-e.t*this.scale);break;case"ArrowUp":this.container.table.cue.adjustHeight(e.t*this.scale);break;case"ShiftArrowLeft":this.container.table.cue.adjustSide(e.t*this.scale);break;case"ShiftArrowRight":this.container.table.cue.adjustSide(-e.t*this.scale);break;case"Space":this.container.table.cue.adjustPower(e.t*this.scale*.7);break;case"KeySUp":a.exportGltf(this.container.view.scene);break;case"SpaceUp":return this.hit();default:return this}return this.container.sendEvent(this.container.table.cue.aim),this}hit(){return this.container.table.cue.aim.round(),this.container.sendEvent(new r.HitEvent(this.container.table.cue.aim)),new i.PlayShot(this.container)}}t.Aim=o},"./src/controller/container.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Container=void 0;const r=s("./src/events/stationaryevent.ts"),n=s("./src/model/table.ts"),i=s("./src/view/view.ts"),a=s("./src/controller/init.ts"),o=s("./src/utils/rack.ts"),l=s("./src/events/eventutil.ts"),c=s("./src/view/aiminputs.ts");t.Container=class{constructor(e,t,s){this.inputQueue=[],this.eventQueue=[],this.last=performance.now(),this.step=.001,this.log=t,this.table=new n.Table(o.Rack.diamond()),this.view=new i.View(e,s),this.aimInputs=new c.AimInputs(this),this.table.balls.forEach((e=>{this.view.addMesh(e.ballmesh.mesh),this.view.addMesh(e.ballmesh.shadow)})),this.view.addMesh(this.table.cue.mesh),this.updateController(new a.Init(this))}sendEvent(e){this.broadcast(l.EventUtil.serialise(e))}advance(e){const t=Math.floor(e/this.step),s=t*this.step,n=this.table.allStationary();for(var i=0;i<t;i++)this.table.advance(this.step);this.table.updateBallMesh(s),this.view.update(this.table.cue.aim),this.table.cue.update(s),!n&&this.table.allStationary()&&this.eventQueue.push(new r.StationaryEvent)}processEvents(){const e=this.inputQueue.shift();e&&this.updateController(this.controller.handleInput(e));const t=this.eventQueue.shift();t&&this.updateController(t.applyToController(this.controller))}animate(e){this.advance((e-this.last)/1e3),this.last=e,this.processEvents(),this.view.render(),requestAnimationFrame((e=>{this.animate(e)}))}updateController(e){e!==this.controller&&this.log("Transition to "+e.constructor.name),this.controller=e}}},"./src/controller/controller.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Controller=t.StationaryEvent=t.AbortEvent=t.Input=t.HitEvent=t.AimEvent=t.BeginEvent=void 0;const r=s("./src/events/beginevent.ts");Object.defineProperty(t,"BeginEvent",{enumerable:!0,get:function(){return r.BeginEvent}});const n=s("./src/events/aimevent.ts");Object.defineProperty(t,"AimEvent",{enumerable:!0,get:function(){return n.AimEvent}});const i=s("./src/events/hitevent.ts");Object.defineProperty(t,"HitEvent",{enumerable:!0,get:function(){return i.HitEvent}});const a=s("./src/events/input.ts");Object.defineProperty(t,"Input",{enumerable:!0,get:function(){return a.Input}});const o=s("./src/events/abortevent.ts");Object.defineProperty(t,"AbortEvent",{enumerable:!0,get:function(){return o.AbortEvent}});const l=s("./src/events/stationaryevent.ts");Object.defineProperty(t,"StationaryEvent",{enumerable:!0,get:function(){return l.StationaryEvent}});t.Controller=class{constructor(e){this.container=e}handleInput(e){return this}handleBegin(e){return this}handleBreak(e){return this}handleAim(e){return this}handleHit(e){return this}handleAbort(e){return this}handleWatch(e){return this}handleStationary(e){return this}}},"./src/controller/controllerbase.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ControllerBase=void 0;const r=s("./src/controller/controller.ts"),n=s("./src/controller/end.ts");class i extends r.Controller{constructor(e){super(e)}handleAbort(e){return new n.End(this.container)}}t.ControllerBase=i},"./src/controller/end.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.End=void 0;const r=s("./src/controller/controller.ts");class n extends r.Controller{}t.End=n},"./src/controller/init.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Init=void 0;const r=s("./src/events/watchevent.ts"),n=s("./src/controller/aim.ts"),i=s("./src/controller/watchaim.ts"),a=s("./src/controller/controllerbase.ts"),o=s("./src/controller/placeball.ts"),l=s("./src/controller/replay.ts");class c extends a.ControllerBase{handleBegin(e){return this.container.sendEvent(new r.WatchEvent(this.container.table.serialise())),new n.Aim(this.container)}handleWatch(e){return this.container.table.updateFromSerialised(e.json),new i.WatchAim(this.container)}handleBreak(e){return e.init?(console.log("ReplayMode"),this.container.table.updateFromShortSerialised(e.init),new l.Replay(this.container,e.shots)):new o.PlaceBall(this.container)}}t.Init=c},"./src/controller/placeball.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlaceBall=void 0;const r=s("./src/controller/controllerbase.ts"),n=s("./src/controller/aim.ts"),i=s("./node_modules/three/build/three.module.js"),a=s("./src/view/tablegeometry.ts"),o=s("./src/events/breakevent.ts"),l=s("./src/utils/utils.ts");class c extends r.ControllerBase{constructor(e){super(e),this.scale=.01,this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.table.cue.aim.power=0,this.container.view.camera.mode=this.container.view.camera.aimView,this.container.table.cue.mesh.visible=!1}handleInput(e){switch(e.key){case"ArrowLeft":this.container.table.balls[0].pos.y=i.MathUtils.clamp(l.round(this.container.table.balls[0].pos.y+e.t*this.scale),-a.TableGeometry.tableY,a.TableGeometry.tableY);break;case"ArrowRight":this.container.table.balls[0].pos.y=i.MathUtils.clamp(l.round(this.container.table.balls[0].pos.y-e.t*this.scale),-a.TableGeometry.tableY,a.TableGeometry.tableY);break;case"movementXUp":this.container.table.balls[0].pos.y=i.MathUtils.clamp(l.round(this.container.table.balls[0].pos.y-e.t*this.scale*2),-a.TableGeometry.tableY,a.TableGeometry.tableY);break;case"SpaceUp":return this.placed();default:return this}return this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.view.camera.aimView(this.container.table.cue.aim,1),this}placed(){return this.container.table.cue.mesh.visible=!0,this.container.table.cue.aim.round(),this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.sendEvent(new o.BreakEvent(this.container.table.shortSerialise())),new n.Aim(this.container)}}t.PlaceBall=c},"./src/controller/playshot.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.PlayShot=void 0;const r=s("./src/events/watchevent.ts"),n=s("./src/controller/aim.ts"),i=s("./src/controller/controllerbase.ts");class a extends i.ControllerBase{constructor(e){super(e),this.allStationary=!1,this.container.table.outcome=[],this.container.table.hit(),this.container.view.camera.mode=this.container.view.camera.afterHitView}handleStationary(e){return this.allStationary=!0,this.container.log("stationary event"),this.container.table.outcome.some((e=>"pot"==e.type))?(this.container.log("pot! transition to Aim"),this.container.sendEvent(new r.WatchEvent(this.container.table.serialise())),new n.Aim(this.container)):(this.container.log("no pot"),this.container.sendEvent(new r.WatchEvent(this.container.table.serialise())),new n.Aim(this.container))}}t.PlayShot=a},"./src/controller/replay.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Replay=void 0;const r=s("./src/events/hitevent.ts"),n=s("./src/controller/controllerbase.ts"),i=s("./src/events/aimevent.ts");class a extends n.ControllerBase{constructor(e,t){return super(e),this.delay=1500,this.shots=t,this.playNextShot(),this}playNextShot(){var e=i.AimEvent.fromJson(this.shots.shift());this.container.table.cue.aim=e,this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.view.camera.mode=this.container.view.camera.aimView,setTimeout((()=>{this.container.eventQueue.push(new r.HitEvent({}))}),this.delay)}handleHit(e){return this.container.table.outcome=[],this.container.table.hit(),this.container.view.camera.mode=this.container.view.camera.afterHitView,this}handleStationary(e){return console.log("stationary event"),this.container.table.outcome.some((e=>"pot"==e.type))&&console.log(this.container.table.outcome.filter((e=>"pot"==e.type))),this.shots.length>0&&setTimeout((()=>{this.playNextShot()}),this.delay),this}}t.Replay=a},"./src/controller/watchaim.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchAim=void 0;const r=s("./src/controller/watchshot.ts"),n=s("./src/controller/controllerbase.ts");class i extends n.ControllerBase{constructor(e){super(e),this.scale=1e-6,this.container.table.cue.moveTo(this.container.table.balls[0].pos),this.container.view.camera.mode=this.container.view.camera.topView}handleAim(e){return this.container.table.cue.aim=e,this}handleHit(e){return this.container.table.updateFromSerialised(e.json),new r.WatchShot(this.container)}}t.WatchAim=i},"./src/controller/watchshot.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchShot=void 0;const r=s("./src/controller/aim.ts"),n=s("./src/controller/watchaim.ts"),i=s("./src/controller/controllerbase.ts");class a extends i.ControllerBase{constructor(e){super(e),this.allStationary=!1,this.container.table.outcome=[],this.container.table.hit()}handleAim(e){return this.allStationary?(this.container.log("all stationary so transition to Aim now"),new r.Aim(this.container)):(this.container.log("pending transition to Aim"),this.pendingState=new r.Aim(this.container),this)}handleWatch(e){return this.allStationary?(this.container.log("all stationary so transition to WatchAim now"),new n.WatchAim(this.container)):(this.container.log("pending transition to WatchAim"),this.pendingState=new n.WatchAim(this.container),this)}handleStationary(e){return this.allStationary=!0,this.container.log("stationary event"),this.pendingState?(this.container.log("go to pending state now"),this.pendingState):(this.container.log("no pending state"),this)}}t.WatchShot=a},"./src/events/abortevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AbortEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts");class i extends r.GameEvent{constructor(){super(),this.type=n.EventType.ABORT}applyToController(e){return e.handleAbort(this)}}t.AbortEvent=i},"./src/events/aimevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AimEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts"),i=s("./src/utils/utils.ts"),a=s("./node_modules/three/build/three.module.js");class o extends r.GameEvent{constructor(){super(),this.verticalOffset=.1,this.sideOffset=0,this.angle=0,this.power=0,this.pos=new a.Vector3(1,0,0),this.type=n.EventType.AIM}applyToController(e){return e.handleAim(this)}static fromJson(e){let t=new o;return t.pos=i.vec(e.pos),t.angle=e.angle,t.verticalOffset=e.verticalOffset,t.sideOffset=e.sideOffset,t.power=e.power,t}copy(){return o.fromJson(this)}round(){this.angle=i.round(this.angle),this.power=i.round(this.power),this.verticalOffset=i.round(this.verticalOffset),this.sideOffset=i.round(this.sideOffset),i.roundVec(this.pos)}}t.AimEvent=o},"./src/events/beginevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BeginEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts");class i extends r.GameEvent{constructor(){super(),this.type=n.EventType.BEGIN}applyToController(e){return e.handleBegin(this)}}t.BeginEvent=i},"./src/events/breakevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BreakEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts");class i extends r.GameEvent{constructor(e,t){super(),this.init=e,this.shots=t,this.type=n.EventType.BREAK}applyToController(e){return e.handleBreak(this)}static fromJson(e){return new i(e.init,e.shots)}}t.BreakEvent=i},"./src/events/eventtype.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventType=void 0,function(e){e[e.BEGIN=0]="BEGIN",e[e.BREAK=1]="BREAK",e[e.WATCHAIM=2]="WATCHAIM",e[e.AIM=3]="AIM",e[e.HIT=4]="HIT",e[e.STATIONARY=5]="STATIONARY",e[e.CHAT=6]="CHAT",e[e.ABORT=7]="ABORT",e[e.REPOSITION=8]="REPOSITION"}(t.EventType||(t.EventType={}))},"./src/events/eventutil.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.EventUtil=void 0;const r=s("./src/events/eventtype.ts"),n=s("./src/events/aimevent.ts"),i=s("./src/events/watchevent.ts"),a=s("./src/events/hitevent.ts"),o=s("./src/events/abortevent.ts"),l=s("./src/events/breakevent.ts");t.EventUtil=class{static serialise(e){return JSON.stringify(e)}static fromSerialised(e){let t=JSON.parse(e);switch(t.type){case r.EventType.AIM:return n.AimEvent.fromJson(t);case r.EventType.BREAK:return l.BreakEvent.fromJson(t);case r.EventType.WATCHAIM:return i.WatchEvent.fromJson(t.json);case r.EventType.HIT:return a.HitEvent.fromJson(t.json);case r.EventType.ABORT:return new o.AbortEvent;default:throw Error("Unknown GameEvent :"+e)}}}},"./src/events/gameevent.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.GameEvent=void 0;t.GameEvent=class{}},"./src/events/hitevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.HitEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts");class i extends r.GameEvent{constructor(e){super(),this.type=n.EventType.HIT,this.json=e}applyToController(e){return e.handleHit(this)}static fromJson(e){return new i(e)}}t.HitEvent=i},"./src/events/input.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Input=void 0;t.Input=class{constructor(e,t){this.t=e,this.key=t}}},"./src/events/keyboard.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Keyboard=void 0;const r=s("./src/events/input.ts");t.Keyboard=class{constructor(e){this.pressed={},this.released={},this.keydown=e=>{e=e||window.event,null==this.pressed[e.code]&&(this.pressed[e.code]=performance.now()),e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()},this.keyup=e=>{e=e||window.event,this.released[e.code]=performance.now()-this.pressed[e.code],delete this.pressed[e.code],e.stopImmediatePropagation(),"F12"!==e.key&&e.preventDefault()},this.mousemove=e=>{1===e.buttons&&(this.released.movementX?this.released.movementX+=e.movementX:this.released.movementX=e.movementX)},this.addHandlers(e)}getEvents(){let e=Object.keys(this.pressed).filter((e=>!/.*Shift.*/.test(e))).filter((e=>!/.*Control.*/.test(e))),t=Object.keys(this.pressed).some((e=>/.*Shift.*/.test(e))),s=Object.keys(this.pressed).some((e=>/.*Control.*/.test(e))),n=[];return e.forEach((e=>{let i=performance.now()-this.pressed[e];n.push(new r.Input(s?i/3:i,t?"Shift"+e:e)),"Space"!=e&&(this.pressed[e]=performance.now())})),Object.keys(this.released).forEach((e=>n.push(new r.Input(this.released[e],e+"Up")))),this.released={},n}addHandlers(e){document.addEventListener("keydown",this.keydown),document.addEventListener("keyup",this.keyup),e.addEventListener("pointermove",this.mousemove)}}},"./src/events/stationaryevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.StationaryEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts");class i extends r.GameEvent{constructor(){super(),this.type=n.EventType.STATIONARY}applyToController(e){return e.handleStationary(this)}}t.StationaryEvent=i},"./src/events/watchevent.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.WatchEvent=void 0;const r=s("./src/events/gameevent.ts"),n=s("./src/events/eventtype.ts");class i extends r.GameEvent{constructor(e){super(),this.type=n.EventType.WATCHAIM,this.json=e}applyToController(e){return e.handleWatch(this)}static fromJson(e){return new i(e)}}t.WatchEvent=i},"./src/index.ts":(e,t,s)=>{"use strict";const r=s("./src/controller/container.ts"),n=s("./src/events/keyboard.ts"),i=s("./src/events/eventutil.ts"),a=s("./src/events/eventtype.ts"),o=s("./src/events/breakevent.ts");var l,c={init:null,shots:Array()},u=new n.Keyboard(document.getElementById("viewP1"));function h(){console.log("Assets loaded");const e=/state=(.*)/.exec(location.search);null!==e?(c=JSON.parse(decodeURI(e[1])),l.eventQueue.push(new o.BreakEvent(c.init,c.shots))):l.eventQueue.push(new o.BreakEvent),l.broadcast=e=>{let t=i.EventUtil.fromSerialised(e);if(t.type===a.EventType.BREAK&&(c.init=t.init),t.type===a.EventType.HIT){c.shots.push(t.json),console.log("break of "+c.shots.length);let e=encodeURI(`${window.location}?&state=${JSON.stringify(c)}`);console.log(e)}},p(),l.animate(performance.now())}function p(){u.getEvents().forEach((e=>l.inputQueue.push(e))),requestAnimationFrame((e=>{p()}))}l=new r.Container(document.getElementById("viewP1"),(e=>{}),h)},"./src/model/ball.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Ball=t.State=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./src/utils/utils.ts"),i=s("./src/model/physics/physics.ts"),a=s("./src/view/ballmesh.ts");var o;!function(e){e.Stationary="Stationary",e.Rolling="Rolling",e.Sliding="Sliding",e.Falling="Falling",e.InPocket="InPocket"}(o=t.State||(t.State={}));class l{constructor(e,t){this.vel=n.zero.clone(),this.rvel=n.zero.clone(),this.state=o.Stationary,this.transition=.05,this.pos=e.clone(),this.ballmesh=new a.BallMesh(t||5592405*Math.random())}update(e){this.updatePosition(e),this.updateVelocity(e)}updateMesh(e){this.ballmesh.updatePosition(this.pos),0!=this.rvel.lengthSq()&&this.ballmesh.updateRotation(this.rvel,e)}updatePosition(e){this.pos.addScaledVector(this.vel,e)}updateVelocity(e){this.inMotion()&&(this.isRolling()?this.updateVelocityRolling(e):this.updateVelocitySliding(e))}updateVelocityRolling(e){i.forceRoll(this.vel,this.rvel);let t=new r.Vector3,s=new r.Vector3;i.rollingFull(this.rvel,t,s),t.multiplyScalar(e),s.multiplyScalar(e),n.passesThroughZero(this.rvel,s)||n.passesThroughZero(this.vel,t)?this.setStationary():(this.vel.add(t),this.rvel.add(s),this.state=o.Rolling)}updateVelocitySliding(e){let t=new r.Vector3,s=new r.Vector3;i.sliding(this.vel,this.rvel,t,s),t.multiplyScalar(e),s.multiplyScalar(e),n.passesThroughZero(this.rvel,s)&&n.passesThroughZero(this.vel,t)?this.setStationary():(this.vel.add(t),this.rvel.add(s),this.state=o.Sliding)}setStationary(){this.vel.copy(n.zero),this.rvel.copy(n.zero),this.state=o.Stationary}isRolling(){return i.surfaceVelocity(this.vel,this.rvel).length()<this.transition&&0!=this.vel.lengthSq()}onTable(){return this.state!==o.Falling}inMotion(){return this.onTable()&&(0!=this.vel.lengthSq()||0!=this.rvel.lengthSq())}futurePosition(e){return this.pos.clone().addScaledVector(this.vel,e)}serialise(){return{pos:this.pos,vel:this.vel,rvel:this.rvel,state:this.state}}static fromSerialised(e){return l.updateFromSerialised(new l(n.vec(e.pos)),e)}static updateFromSerialised(e,t){return e.pos.copy(t.pos),e.vel.copy(n.vec(t.vel)),e.rvel.copy(n.vec(t.rvel)),e.state=t.state,e}}t.Ball=l},"./src/model/physics/collision.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Collision=void 0;class s{static willCollide(e,t,s){return e.onTable()&&t.onTable()&&e.futurePosition(s).distanceToSquared(t.futurePosition(s))<1}static collide(e,t){s.updateVelocities(e,t)}static updateVelocities(e,t){const s=t.pos.clone().sub(e.pos).normalize(),r=s.dot(e.vel),n=s.dot(t.vel);e.vel.addScaledVector(s,n).addScaledVector(s,-r),t.vel.addScaledVector(s,r).addScaledVector(s,-n)}}t.Collision=s},"./src/model/physics/constants.ts":(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.I=t.R=t.e=t.Mxy=t.Mz=t.m=t.rho=t.g=t.mu=void 0,t.mu=1.7,t.g=9.8,t.rho=.3,t.m=1,t.Mz=t.mu*t.m*t.g*2/3*t.rho,t.Mxy=7/(5*Math.sqrt(2))*t.mu*t.m*t.g*.1,t.e=.95,t.R=.5,t.I=.4*t.m*t.R*t.R},"./src/model/physics/cushion.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cushion=void 0;const r=s("./src/view/tablegeometry.ts"),n=s("./src/model/physics/physics.ts"),i=s("./node_modules/three/build/three.module.js");class a{static willBounce(e,t){let s=e.futurePosition(t);return e.onTable()&&(a.willBounceLongSegment(r.TableGeometry.pockets.pocketNW.knuckleNE.pos.x,r.TableGeometry.pockets.pocketN.knuckleNW.pos.x,s)||a.willBounceLongSegment(r.TableGeometry.pockets.pocketN.knuckleNE.pos.x,r.TableGeometry.pockets.pocketNE.knuckleNW.pos.x,s)||a.willBounceShortSegment(r.TableGeometry.pockets.pocketNW.knuckleSW.pos.y,r.TableGeometry.pockets.pocketSW.knuckleNW.pos.y,s))}static willBounceLongSegment(e,t,s){return s.x>e&&s.x<t&&Math.abs(s.y)>r.TableGeometry.tableY}static willBounceShortSegment(e,t,s){return s.y>t&&s.y<e&&Math.abs(s.x)>r.TableGeometry.tableX}static bounce(e,t){const s=e.futurePosition(t);s.x>r.TableGeometry.tableX&&a.bounceIn(0,e),s.x<-r.TableGeometry.tableX&&a.bounceIn(Math.PI,e),s.y>r.TableGeometry.tableY&&a.bounceIn(-Math.PI/2,e),s.y<-r.TableGeometry.tableY&&a.bounceIn(Math.PI/2,e)}static bounceIn(e,t){let s=new i.Vector3,r=new i.Vector3;n.rotateApplyUnrotate(e,t.vel,t.rvel,s,r),t.vel.add(s),t.rvel.setLength(t.rvel.length()/4)}}t.Cushion=a},"./src/model/physics/knuckle.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Knuckle=void 0;const r=s("./src/view/tablegeometry.ts"),n=s("./src/model/physics/constants.ts");class i{constructor(e,t){this.pos=e,this.radius=t}static willBounce(e,t){return t.distanceTo(e.pos)<.5+e.radius}bounce(e){const t=e.pos.clone().sub(this.pos).normalize();let s=t.dot(e.vel);e.vel.addScaledVector(t,-2*n.e*s)}static willBounceAny(e,t){const s=e.futurePosition(t);return e.onTable()&&r.TableGeometry.knuckles.find((e=>i.willBounce(e,s)))}}t.Knuckle=i},"./src/model/physics/physics.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.bounceWithSlipX=t.bounceWithoutSlipX=t.isCushionXGrip=t.rotateApplyUnrotate=t.forceRoll=t.rollingFull=t.slidingFull=t.sliding=t.surfaceVelocity=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./src/utils/utils.ts"),i=s("./src/model/physics/constants.ts");function a(e,t){return e.clone().add(n.upCross(t)).setZ(0)}t.surfaceVelocity=a,t.sliding=function(e,t,s,r){const o=a(e,t);s.copy(n.norm(o).multiplyScalar(-i.mu*i.g)),r.copy(n.norm(n.upCross(o)).multiplyScalar(2.5*i.mu*i.g)),r.setZ(-2.5*i.Mz*Math.sign(t.z))},t.slidingFull=function(e,t,s,n){const a=new r.Vector3(e.x-t.y,e.y+t.x,0).normalize();s.set(-i.mu*i.g*a.x,-i.mu*i.g*a.y,0),n.set(-2.5*i.mu*i.g*a.y,2.5*i.mu*i.g*a.x,-2.5*i.Mz*Math.sign(t.z))},t.rollingFull=function(e,t,s){const n=new r.Vector3(e.x,e.y,0).length(),a=5/7*i.Mxy/n;t.set(-a*e.y,a*e.x,0),s.set(-a*e.x,-a*e.y,-a*e.z)},t.forceRoll=function(e,t){e.sub(a(e,t).multiplyScalar(.5)),t.copy(n.upCross(e))};const o=Math.sin(9.25/32.5),l=Math.cos(9.25/32.5),c=o*o,u=l*l;t.rotateApplyUnrotate=function(e,t,s,r,i){d(t.clone().applyAxisAngle(n.up,e),s.clone().applyAxisAngle(n.up,e),r,i),r.applyAxisAngle(n.up,-e),i.applyAxisAngle(n.up,-e)};const h=7/(2*i.m),p=1/i.m;function d(e,t,s,r){var n=e.x-e.x*(2/7*c+(1+i.e)*u)-2/7*i.R*t.y*o,a=5/7*e.y+2/7*i.R*(t.x*o-t.z*l),h=i.m*(a-e.y),p=i.m*(n-e.x),d=-i.m,m=t.x-i.R/i.I*h*o,f=t.y+i.R/i.I*(p*o-d*l),v=t.z+i.R/i.I*h*l;s.set(n-e.x,a-e.y,0),r.set(m-t.x,f-t.y,v-t.z)}t.isCushionXGrip=function(e,t){var s,n=(s=function(e){return-e.y}(e),(1+i.e)*s/p),a=function(e,t){return new r.Vector3(e.x*o-e.z*l+i.R*t.y,-e.y-i.R*t.z*l+i.R*t.x*o)}(e,t).length()/h;return console.log(n+" < "+a+" isGrip = "+(n<a?"true":"false")),n<a},t.bounceWithoutSlipX=d,t.bounceWithSlipX=function(e,t,s,r){var n=e.x-e.x*(1+i.e)*l*(i.mu*l*o+l),a=e.y+i.mu*(1+i.e)*l*o*e.x,c=i.m*(a-e.y),u=i.m*(n-e.x),h=-i.m,p=t.x-i.R/i.I*c*o,d=t.y+i.R/i.I*(u*o-h*l),m=t.z+i.R/i.I*c*l;s.set(n-e.x,a-e.y,0),r.set(p-t.x,d-t.y,m-t.z)}},"./src/model/physics/pocket.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Pocket=void 0;const r=s("./src/model/ball.ts"),n=s("./src/view/tablegeometry.ts");class i{constructor(e,t){this.pos=e,this.radius=t}static willFall(e,t){return t.distanceTo(e.pos)<.5+e.radius}fall(e,t){const s=e.pos.clone().sub(this.pos).normalize();e.vel.addScaledVector(s,1*t),e.vel.z=-10,e.state=r.State.Falling}static willFallAny(e,t){const s=e.futurePosition(t);return e.onTable()&&n.TableGeometry.pocketCenters.find((e=>i.willFall(e,s)))}}t.Pocket=i},"./src/model/table.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Table=void 0;const r=s("./src/model/physics/cushion.ts"),n=s("./src/model/physics/collision.ts"),i=s("./src/model/physics/knuckle.ts"),a=s("./src/model/physics/pocket.ts"),o=s("./src/view/cue.ts"),l=s("./src/model/ball.ts"),c=s("./src/events/aimevent.ts"),u=s("./src/utils/utils.ts");class h{constructor(e){this.cue=new o.Cue,this.outcome=[],this.initialiseBalls(e)}initialiseBalls(e){this.balls=e,this.pairs=[],this.balls.forEach((e=>{this.balls.forEach((t=>{e!==t&&this.pairs.push({a:e,b:t})}))}))}advance(e){let t=0;for(;!this.prepareAdvanceAll(e);)if(t++>100)throw new Error("Depth exceeded resolving collisions");this.balls.forEach((t=>{t.update(e)}))}updateBallMesh(e){this.balls.forEach((t=>{t.updateMesh(e)}))}prepareAdvanceAll(e){return this.pairs.length>0?!this.pairs.some((t=>!this.prepareAdvancePair(t.a,t.b,e))):!this.balls.some((t=>!this.prepareAdvanceToCushions(t,e)))}prepareAdvancePair(e,t,s){return!e.inMotion()&&!t.inMotion()||(n.Collision.willCollide(e,t,s)?(n.Collision.collide(e,t),this.outcome.push({type:"collision",a:e,b:t}),!1):this.prepareAdvanceToCushions(e,s))}prepareAdvanceToCushions(e,t){if(r.Cushion.willBounce(e,t))return r.Cushion.bounce(e,t),this.outcome.push({type:"cushion",a:e}),!1;let s=i.Knuckle.willBounceAny(e,t);if(s)return s.bounce(e),this.outcome.push({type:"cushion",a:e}),!1;let n=a.Pocket.willFallAny(e,t);return!n||(n.fall(e,t),this.outcome.push({type:"pot",a:e}),!1)}allStationary(){return this.balls.every((e=>!e.inMotion()||!e.onTable()))}hit(){let e=this.cue.aim;this.balls[0].vel.copy(u.unitAtAngle(e.angle).multiplyScalar(e.power));let t=u.upCross(u.unitAtAngle(e.angle)).multiplyScalar(e.power*e.verticalOffset*5/2);t.z=5*-e.sideOffset/2,this.balls[0].rvel.copy(t),e.power=0}serialise(){return{balls:this.balls.map((e=>e.serialise())),aim:this.cue.aim.copy()}}static fromSerialised(e){let t=new h(e.balls.map((e=>l.Ball.fromSerialised(e))));return t.updateFromSerialised(e),t}updateFromSerialised(e){this.balls.forEach(((t,s)=>l.Ball.updateFromSerialised(t,e.balls[s]))),e.aim&&(this.cue.aim=c.AimEvent.fromJson(e.aim))}shortSerialise(){return this.balls.map((e=>[e.pos.x,e.pos.y])).reduce(((e,t)=>e.concat(t)),[])}updateFromShortSerialised(e){this.balls.forEach(((t,s)=>{t.pos.x=e[2*s],t.pos.y=e[2*s+1]}))}}t.Table=h},"./src/utils/gltf.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.downloadObjectAsJson=t.importGltf=t.exportGltf=void 0;const r=s("./node_modules/three/examples/jsm/exporters/GLTFExporter.js"),n=s("./node_modules/three/examples/jsm/loaders/GLTFLoader.js");function i(e,t){var s=document.createElement("a");s.setAttribute("href","data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(e))),s.setAttribute("download",t),document.body.appendChild(s),s.click(),s.remove()}t.exportGltf=function(e){(new r.GLTFExporter).parse(e,(e=>{console.log(e),i(e,"scene.gltf")}))},t.importGltf=function(e,t,s){(new n.GLTFLoader).load(e,(e=>{t.add(e.scene),null!==s&&s()}),(e=>console.log(e.loaded+" bytes loaded")),(e=>console.log(e)))},t.downloadObjectAsJson=i},"./src/utils/rack.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Rack=void 0;const r=s("./src/model/ball.ts"),n=s("./src/view/tablegeometry.ts"),i=s("./node_modules/three/build/three.module.js"),a=s("./src/utils/utils.ts");class o{static jitter(e){return a.roundVec(e.clone().add(new i.Vector3(o.noise*(Math.random()-.5),o.noise*(Math.random()-.5),0)))}static cueBall(){return new r.Ball(new i.Vector3(-11,0,0),16444375)}static diamond(){let e=new i.Vector3(0,o.gap,0),t=e.clone().applyAxisAngle(o.up,1*Math.PI/3),s=new i.Vector3(n.TableGeometry.tableX/2,0,0),a=[];return a.push(o.cueBall()),a.push(new r.Ball(o.jitter(s),14736950)),s.add(t),a.push(new r.Ball(o.jitter(s),16751872)),s.sub(e),a.push(new r.Ball(o.jitter(s),5380369)),s.add(t),a.push(new r.Ball(o.jitter(s),5853696)),s.sub(e),a.push(new r.Ball(o.jitter(s),16711680)),s.addScaledVector(e,2),a.push(new r.Ball(o.jitter(s),328965)),s.add(t).sub(e),a.push(new r.Ball(o.jitter(s),685250)),s.sub(e),a.push(new r.Ball(o.jitter(s),553728)),s.add(t),a.push(new r.Ball(o.jitter(s),4063388)),a}}t.Rack=o,o.noise=.05,o.gap=1+2*o.noise,o.up=new i.Vector3(0,0,-1)},"./src/utils/utils.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.roundVec=t.round=t.unitAtAngle=t.passesThroughZero=t.norm=t.upCross=t.vec=t.up=t.zero=void 0;const r=s("./node_modules/three/build/three.module.js");function n(e){return Math.round(1e3*(e+Number.EPSILON))/1e3}t.zero=new r.Vector3(0,0,0),t.up=new r.Vector3(0,0,1),t.vec=function(e){return new r.Vector3(e.x,e.y,e.z)},t.upCross=function(e){return t.up.clone().cross(e)},t.norm=function(e){return e.clone().normalize()},t.passesThroughZero=function(e,t){return e.clone().add(t).dot(e)<=0},t.unitAtAngle=function(e){return new r.Vector3(1,0,0).applyAxisAngle(t.up,e)},t.round=n,t.roundVec=function(e){return e.x=n(e.x),e.y=n(e.y),e.z=n(e.z),e}},"./src/view/aiminputs.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.AimInputs=void 0;const r=s("./src/events/input.ts");t.AimInputs=class{constructor(e){this.mousemove=e=>{1===e.buttons&&(this.cueTipElement.style.left=e.offsetX-this.cueTipElement.offsetWidth/2+"px",this.cueTipElement.style.top=e.offsetY-this.cueTipElement.offsetHeight/2+"px",this.container.table.cue.setSpin(-(e.offsetX-this.cueBallElement.offsetWidth/2)/this.cueBallElement.offsetWidth,-(e.offsetY-this.cueBallElement.offsetHeight/2)/this.cueBallElement.offsetHeight))},this.hit=e=>{this.container.table.cue.setPower(this.cuePowerElement.value/100),this.container.inputQueue.push(new r.Input(0,"SpaceUp"))},this.container=e,this.cueBallElement=document.getElementById("cueBall"),this.cueTipElement=document.getElementById("cueTip"),this.cueBallElement?.addEventListener("pointermove",this.mousemove),this.cuePowerElement=document.getElementById("cuePower"),this.cueHitElement=document.getElementById("cueHit"),this.cueHitElement?.addEventListener("click",this.hit)}}},"./src/view/ballmesh.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.BallMesh=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./src/utils/utils.ts");t.BallMesh=class{constructor(e){this.m=new r.Matrix4,this.initialiseMesh(e)}updatePosition(e){this.mesh.position.copy(e),this.shadow.position.copy(e)}updateRotation(e,t){let s=e.length()*t*Math.PI/2,r=this.m.identity().makeRotationAxis(n.norm(e),s);this.mesh.geometry.applyMatrix4(r)}initialiseMesh(e){var t=new r.IcosahedronGeometry(.5,1),s=new r.MeshPhongMaterial({color:e,emissive:0,flatShading:!0});this.mesh=new r.Mesh(t,s),this.mesh.name="ball";const n=new r.CircleGeometry(.45,9);n.applyMatrix4((new r.Matrix4).identity().makeTranslation(0,0,-.49));const i=new r.MeshBasicMaterial({color:1118498});this.shadow=new r.Mesh(n,i)}}},"./src/view/camera.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Camera=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./src/utils/utils.ts");t.Camera=class{constructor(e){this.mode=this.topView,this.topViewPoint=new r.Vector3(0,-.1,49),this.camera=new r.PerspectiveCamera(35,e,.1,1e3)}update(e){this.mode(e)}topView(e){this.camera.position.lerp(this.topViewPoint,.2),this.camera.up=n.up,this.camera.lookAt(n.zero)}aimView(e,t=.08){this.camera.position.lerp(e.pos.clone().addScaledVector(n.unitAtAngle(e.angle),-9),t),this.camera.position.z=2.7,this.camera.up=n.up,this.camera.lookAt(e.pos)}afterHitView(e){this.camera.position.lerp(this.camera.position.clone().addScaledVector(n.up,1),.001),this.camera.up=n.up,this.camera.lookAt(e.pos)}}},"./src/view/cue.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Cue=void 0;const r=s("./src/view/tablegeometry.ts"),n=s("./src/utils/utils.ts"),i=s("./src/events/aimevent.ts"),a=s("./node_modules/three/build/three.module.js");class o{constructor(){this.limit=.4,this.maxPower=60,this.t=0,this.aim=new i.AimEvent,this.length=1*r.TableGeometry.tableX,this.initialise(.05,.15,this.length)}initialise(e,t,s){var r=new a.CylinderGeometry(e,t,s,11);this.mesh=new a.Mesh(r,o.material),this.mesh.castShadow=!0,this.mesh.geometry.applyMatrix4((new a.Matrix4).identity().makeRotationAxis(new a.Vector3(1,0,0),-.1)).applyMatrix4((new a.Matrix4).identity().makeRotationAxis(n.up,-Math.PI/2)).applyMatrix4((new a.Matrix4).identity().makeTranslation(-s/2-.5,0,1)),this.mesh.rotation.z=this.aim.angle}rotateAim(e){this.aim.angle+=e,this.mesh.rotation.z=this.aim.angle}adjustHeight(e){this.aim.verticalOffset=a.MathUtils.clamp(this.aim.verticalOffset+e,-this.limit,this.limit),this.mesh.position.z=this.aim.verticalOffset}adjustSide(e){this.aim.sideOffset=a.MathUtils.clamp(this.aim.sideOffset+e,-this.limit,this.limit)}adjustPower(e){this.aim.power=Math.min(this.maxPower,this.aim.power+e)}setPower(e){this.aim.power=e*this.maxPower}setSpin(e,t){console.log(e,t),this.aim.verticalOffset=a.MathUtils.clamp(t,-this.limit,this.limit),this.aim.sideOffset=a.MathUtils.clamp(e,-this.limit,this.limit)}moveTo(e){this.aim.pos.copy(e),this.mesh.rotation.z=this.aim.angle;let t=n.upCross(n.unitAtAngle(this.aim.angle)).multiplyScalar(this.aim.sideOffset).setZ(this.aim.verticalOffset),s=.25*(Math.sin(this.t/3)-1),r=n.unitAtAngle(this.aim.angle).clone().multiplyScalar(s-this.aim.power/this.maxPower*3);this.mesh.position.copy(e.clone().add(t).add(r))}update(e){this.t+=e,this.moveTo(this.aim.pos)}intersectsAnything(e){let t=e.balls[0].pos.clone().addScaledVector(n.unitAtAngle(this.aim.angle),-this.length/2);t.z=this.aim.verticalOffset;let s=n.unitAtAngle(this.aim.angle);return new a.Raycaster(t,s,0,this.length/2-.6).intersectObjects(e.balls.map((e=>e.ballmesh.mesh))).length>0}}t.Cue=o,o.material=new a.MeshPhongMaterial({color:8934775,wireframe:!1,flatShading:!1})},"./src/view/overheadcamera.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.OverheadCamera=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./src/utils/utils.ts");t.OverheadCamera=class{constructor(e){this.topViewPoint=new r.Vector3(0,-.1,48),this.camera=new r.PerspectiveCamera(35,e,.1,1e3),this.camera.position.copy(this.topViewPoint),this.camera.up=n.up,this.camera.lookAt(n.zero)}aspect(e,t){const s=500,r=Math.min(s,.4*e),n=1/e,i=1/t*.59;return t>1.5*e?{x:n*e,y:i*e}:.4*e>s?{x:n*s,y:i*s}:{x:n*r,y:i*r}}}},"./src/view/tablegeometry.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.TableGeometry=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./node_modules/three/build/three.module.js"),i=s("./src/model/physics/knuckle.ts"),a=s("./src/model/physics/pocket.ts");class o{static addToScene(e){o.knuckles.forEach((t=>o.knuckleCylinder(t,e))),o.pocketCenters.forEach((t=>o.knuckleCylinder(t,e)))}static knuckleCylinder(e,t){o.cylinder(e.pos,e.radius,.75,t).position.setZ(-.125)}static cylinder(e,t,s,i){var a=new n.CylinderGeometry(t,t,s,16),l=new n.Mesh(a,o.material);return l.position.copy(e),l.geometry.applyMatrix4((new r.Matrix4).identity().makeRotationAxis(new r.Vector3(1,0,0),Math.PI/2)),i.add(l),l}static addCushions(e){o.plane(new r.Vector3(0,0,-5.5),2*o.X,2*o.Y,10,e);let t=.75,s=-.125,n=Math.abs(o.pockets.pocketNW.knuckleNE.pos.x-o.pockets.pocketN.knuckleNW.pos.x),i=Math.abs(o.pockets.pocketNW.knuckleSW.pos.y-o.pockets.pocketSW.knuckleNW.pos.y);o.plane(new r.Vector3(o.X+.5,0,s),1,i,t,e),o.plane(new r.Vector3(-o.X-.5,0,s),1,i,t,e),o.plane(new r.Vector3(-o.X/2,o.Y+.5,s),n,1,t,e),o.plane(new r.Vector3(-o.X/2,-o.Y-.5,s),n,1,t,e),o.plane(new r.Vector3(o.X/2,o.Y+.5,s),n,1,t,e),o.plane(new r.Vector3(o.X/2,-o.Y-.5,s),n,1,t,e)}static plane(e,t,s,r,i){var a=new n.BoxGeometry(t,s,r),l=new n.Mesh(a,o.material);l.receiveShadow=!0,l.position.copy(e),i.add(l)}}t.TableGeometry=o,o.tableX=21.5,o.tableY=10.5,o.X=o.tableX+.5,o.Y=o.tableY+.5,o.PX=o.tableX+1.6,o.PY=o.tableY+1.6,o.knuckleInset=1.6,o.knuckleRadius=.5,o.middleKnuckleInset=1.5,o.middleKnuckleRadius=.25,o.cornerRadius=1.4,o.middleRadius=.5,o.pockets={pocketNW:{pocket:new a.Pocket(new r.Vector3(-o.PX,o.PY,0),o.cornerRadius),knuckleNE:new i.Knuckle(new r.Vector3(-o.X+o.knuckleInset,o.Y+o.knuckleRadius,0),o.knuckleRadius),knuckleSW:new i.Knuckle(new r.Vector3(-o.X-o.knuckleRadius,o.Y-o.knuckleInset,0),o.knuckleRadius)},pocketN:{pocket:new a.Pocket(new r.Vector3(0,o.PY,0),o.middleRadius),knuckleNE:new i.Knuckle(new r.Vector3(o.middleKnuckleInset,o.Y+o.middleKnuckleRadius,0),o.middleKnuckleRadius),knuckleNW:new i.Knuckle(new r.Vector3(-o.middleKnuckleInset,o.Y+o.middleKnuckleRadius,0),o.middleKnuckleRadius)},pocketS:{pocket:new a.Pocket(new r.Vector3(0,-o.PY,0),o.middleRadius),knuckleSE:new i.Knuckle(new r.Vector3(o.middleKnuckleInset,-o.Y-o.middleKnuckleRadius,0),o.middleKnuckleRadius),knuckleSW:new i.Knuckle(new r.Vector3(-o.middleKnuckleInset,-o.Y-o.middleKnuckleRadius,0),o.middleKnuckleRadius)},pocketNE:{pocket:new a.Pocket(new r.Vector3(o.PX,o.PY,0),o.cornerRadius),knuckleNW:new i.Knuckle(new r.Vector3(o.X-o.knuckleInset,o.Y+o.knuckleRadius,0),o.knuckleRadius),knuckleSE:new i.Knuckle(new r.Vector3(o.X+o.knuckleRadius,o.Y-o.knuckleInset,0),o.knuckleRadius)},pocketSE:{pocket:new a.Pocket(new r.Vector3(o.PX,-o.PY,0),o.cornerRadius),knuckleNE:new i.Knuckle(new r.Vector3(o.X+o.knuckleRadius,-o.Y+o.knuckleInset,0),o.knuckleRadius),knuckleSW:new i.Knuckle(new r.Vector3(o.X-o.knuckleInset,-o.Y-o.knuckleRadius,0),o.knuckleRadius)},pocketSW:{pocket:new a.Pocket(new r.Vector3(-o.PX,-o.PY,0),o.cornerRadius),knuckleSE:new i.Knuckle(new r.Vector3(-o.X+o.knuckleInset,-o.Y-o.knuckleRadius,0),o.knuckleRadius),knuckleNW:new i.Knuckle(new r.Vector3(-o.X-o.knuckleRadius,-o.Y+o.knuckleInset,0),o.knuckleRadius)}},o.knuckles=[o.pockets.pocketNW.knuckleNE,o.pockets.pocketNW.knuckleSW,o.pockets.pocketN.knuckleNW,o.pockets.pocketN.knuckleNE,o.pockets.pocketS.knuckleSW,o.pockets.pocketS.knuckleSE,o.pockets.pocketNE.knuckleNW,o.pockets.pocketNE.knuckleSE,o.pockets.pocketSE.knuckleNE,o.pockets.pocketSE.knuckleSW,o.pockets.pocketSW.knuckleSE,o.pockets.pocketSW.knuckleNW],o.pocketCenters=[o.pockets.pocketNW.pocket,o.pockets.pocketSW.pocket,o.pockets.pocketN.pocket,o.pockets.pocketS.pocket,o.pockets.pocketNE.pocket,o.pockets.pocketSE.pocket],o.material=new n.MeshPhongMaterial({color:4478361,wireframe:!1,flatShading:!0})},"./src/view/view.ts":(e,t,s)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.View=void 0;const r=s("./node_modules/three/build/three.module.js"),n=s("./src/view/camera.ts"),i=s("./src/view/overheadcamera.ts"),a=s("./src/utils/gltf.ts");t.View=class{constructor(e,t){this.scene=new r.Scene,this.windowWidth=1,this.windowHeight=1,this.views=[{left:0,bottom:0,width:1,height:1},{left:.7,bottom:0,width:.3,height:.3}],this.element=e,e&&this.initialiseScene(e,e.offsetWidth,e.offsetHeight),this.camera=new n.Camera(e?e.offsetWidth/e.offsetHeight:1),this.overheadCamera=new i.OverheadCamera(e?e.offsetWidth/e.offsetHeight:1),this.addTable(t)}update(e){this.camera.update(e)}updateSize(){this.windowWidth==this.element.offsetWidth&&this.windowHeight==this.element.offsetHeight||(this.windowWidth=this.element.offsetWidth,this.windowHeight=this.element.offsetHeight,this.renderer.setSize(this.windowWidth,this.windowHeight))}render(){this.updateSize(),this.renderCamera(this.camera,this.views[0]);let e=this.overheadCamera.aspect(this.windowWidth,this.windowHeight);this.views[1].width=e.x,this.views[1].height=e.y,this.views[1].left=1-1.01*e.x,this.views[1].bottom=.01*e.y,this.renderCamera(this.overheadCamera,this.views[1])}renderCamera(e,t){this.updateSize();const s=Math.floor(this.windowWidth*t.left),r=Math.floor(this.windowHeight*t.bottom),n=Math.floor(this.windowWidth*t.width),i=Math.floor(this.windowHeight*t.height);this.renderer.setViewport(s,r,n,i),this.renderer.setScissor(s,r,n,i),this.renderer.setScissorTest(!0),e.camera.aspect=n/i,e.camera.updateProjectionMatrix(),this.renderer.render(this.scene,e.camera)}initialiseScene(e,t,s){this.renderer=new r.WebGLRenderer,this.renderer.setSize(t,s),this.renderer.shadowMap.enabled=!1,e.appendChild(this.renderer.domElement)}addTable(e){this.scene.add(new r.AmbientLight(3158064,1)),a.importGltf("models/p8.gltf",this.scene,e)}addMesh(e){this.scene.add(e)}isVisible(e){var t=new r.Frustum,s=new r.Matrix4,n=this.camera.camera;return n.updateMatrixWorld(),n.matrixWorldInverse.getInverse(n.matrixWorld),s.multiplyMatrices(n.projectionMatrix,n.matrixWorldInverse),t.setFromMatrix(s),t.intersectsObject(e)}}}},e=>{"use strict";var t;t="./src/index.ts",e(e.s=t)}]);